<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>玄夜卫系统 - 完全版</title>
<style>
    :root {
        --primary-color: #8da399;
        --primary-hover: #7b9186;
        --primary-dark: #6e827a;
        --primary-light: #a8c4b8;
        --accent: rgba(255, 255, 255, 0.6);
        --text-main: #333333;
        --text-sec: #666666;
        --text-sub: #758075;
        --glass-bg: rgba(255, 255, 255, 0.65);
        --border-radius: 8px;
        --border: #d8e0d8;
        --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
        --font-serif: "Kaiti SC", "STKaiti", "KaiTi", "BiauKai", "SimKai", "Songti SC", serif;
        --bg-page: #f5f7f5;
        --bg-card: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        background: url('https://img.heliar.top/file/1769637033551_Camera_1040g3k031oti50je1q6g5p3io3gkmiuvt32l0l8.jpg') no-repeat center center fixed;
        background-size: cover;
        color: var(--text-main);
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        font-size: 15px;
    }

    #app-root {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background-color: rgba(0,0,0,0.05);
        backdrop-filter: blur(3px);
        transition: filter 0.5s ease;
    }

    /* --- 主界面样式 --- */
    #home-screen {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 2000;
        background: url('https://img.heliar.top/file/1769693440739_无标题58_20260129212828.png') no-repeat center center fixed;
        background-size: cover;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease, transform 0.5s ease;
        overflow: hidden;
    }
    
    #home-screen::before {
        content: '';
        position: absolute; inset: 0;
        background: rgba(255, 255, 255, 0);
        z-index: -1;
    }

    #home-screen.hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(1.05);
    }

    .home-title-box {
        margin-bottom: 20px;
        text-align: center;
        padding: 20px 30px;
        position: relative;
        background: transparent;
        border: none;
        box-shadow: none;
    }
    
    .home-title-box::after { display: none; }

    .home-title {
        display: flex;
        justify-content: center;
        margin-bottom: 5px;
    }

    .home-subtitle {
        font-family: var(--font-serif);
        font-size: 1.1rem;
        color: #5d6e65;
        letter-spacing: 2px;
        margin-bottom: 5px;
    }

    .home-menu {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: 100%;
        max-width: 300px;
    }

    .start-game-container {
        position: relative;
        width: 180px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(93, 110, 101, 0.6);
        border-radius: 50px;
        box-shadow: 0 0 15px rgba(141, 163, 153, 0.3), inset 0 0 10px rgba(255,255,255,0.5);
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: visible;
    }

    .start-game-container:hover {
        background: rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 25px rgba(141, 163, 153, 0.6);
        transform: scale(1.02);
    }

    .start-game-container::after {
        content: '';
        position: absolute;
        top: 4px; bottom: 4px; left: 4px; right: 4px;
        border: 1px dashed rgba(93, 110, 101, 0.4);
        border-radius: 46px;
    }

    .start-game-img {
        display: block;
        width: 220px;
        max-width: none;
        margin-top: -65px; 
        margin-bottom: -65px;
        transform: scale(1.25) translateY(-5px);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
    }

    .start-game-container:hover .start-game-img {
        transform: scale(1.35) translateY(-5px);
    }

    .home-btn {
        background: transparent;
        border: none;
        font-family: var(--font-serif);
        font-size: 1.2rem;
        color: #444;
        padding: 8px 20px;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.25);
        border-radius: 20px;
        width: 200px;
    }
    
    .home-btn::before, .home-btn::after {
        content: '❖';
        font-size: 0.8rem;
        color: var(--primary-color);
        opacity: 0.7;
        margin: 0 10px;
    }

    .home-btn:hover {
        color: #000;
        background: rgba(255,255,255,0.5);
        letter-spacing: 2px;
        transform: scale(1.05);
    }
    .home-btn:hover::before, .home-btn:hover::after { opacity: 1; }

    @media (min-aspect-ratio: 1/1) {
        #home-screen {
            flex-direction: row; 
            justify-content: center;
            gap: 15%; 
        }

        .home-title-box {
            margin-bottom: 0;
            padding: 40px 20px;
            writing-mode: vertical-rl; 
            text-orientation: upright;
            border-radius: 8px;
            order: 2; 
        }
        
        .home-title img { transform: rotate(0); }
        
        .home-subtitle {
            margin-top: 0;
            letter-spacing: 5px;
            border-right: 1px solid rgba(0,0,0,0.1);
            padding-right: 15px;
            margin-bottom: 0;
        }

        .home-menu {
            order: 1; 
            align-items: flex-end; 
            width: auto;
        }
    }

    /* --- Header --- */
    header {
        flex: 0 0 50px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        z-index: 20;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    }

    .header-btn {
        background: transparent;
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: #555;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .header-btn:hover { background: rgba(0,0,0,0.05); color: #000; }
    .header-btns { display: flex; gap: 10px; }

    /* --- 主内容区 --- */
    main {
        flex: 1;
        display: flex;
        flex-direction: row;
        overflow: hidden;
        position: relative;
    }

    #history-panel {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }

    .msg { 
        margin-bottom: 15px; 
        line-height: 1.6; 
        font-size: 0.95rem; 
        position: relative;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 85%;
        word-wrap: break-word;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }

    .msg.user { 
        margin-left: auto;
        background: rgba(255, 255, 255, 0.9);
        color: #333; 
        border-right: 4px solid var(--primary-color); 
        border-top-right-radius: 2px;
    }
    .msg.ai { 
        margin-right: auto;
        background: rgba(255, 255, 255, 0.7);
        color: #222; 
        border-left: 4px solid var(--primary-color); 
        border-top-left-radius: 2px;
    }
    .msg.system-notice { 
        text-align: center; 
        background: transparent;
        box-shadow: none;
        color: var(--primary-hover); 
        font-size: 0.8rem; 
        max-width: 100%;
        padding: 5px;
    }

    .msg strong { color: #2c3e50; font-weight: 700; }
    .msg em { color: #555; font-style: italic; }
    .msg blockquote { border-left: 3px solid #ccc; padding-left: 10px; color: #666; margin: 5px 0; background: rgba(0,0,0,0.02); }
    .msg code { background: rgba(0,0,0,0.06); padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }

    /* --- 控制面板 --- */
    #control-panel {
        width: 340px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-left: 1px solid rgba(255,255,255,0.3);
        box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        padding: 15px;
        z-index: 10;
        transition: all 0.3s ease;
        overflow-y: auto;
    }

    .free-input-area {
        display: flex;
        gap: 8px;
        margin-top: 5px;
        margin-bottom: 12px;
        background: rgba(255,255,255,0.5);
        padding: 5px;
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,0.05);
        flex-shrink: 0;
    }
    
    textarea {
        flex: 1;
        background: transparent;
        border: none;
        color: #333; 
        padding: 8px;
        font-size: 0.95rem;
        resize: none;
        outline: none;
        height: 40px;
        font-family: inherit;
        text-align: left;
        direction: ltr;
    }
    
    textarea:focus {
        text-align: left;
        direction: ltr;
    }
    
    .btn-send {
        flex: 0 0 60px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s;
        height: 40px;
        align-self: center;
    }
    .btn-send:hover { background: var(--primary-hover); }

    .action-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow-y: auto;
        flex: 1;
        margin-bottom: 10px;
        padding-right: 2px;
        min-height: 100px;
    }

    .action-btn {
        background: white;
        border: 1px solid rgba(0,0,0,0.05);
        color: #444;
        padding: 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .action-btn:before { content: "❖"; color: var(--primary-color); margin-right: 8px; font-size: 0.8em; }
    .action-btn:hover { background: var(--primary-color); color: white; border-color: transparent; transform: translateX(2px); }
    .action-btn:hover:before { color: white; }

    .collapse-btn {
        width: 100%;
        background: rgba(255,255,255,0.6);
        border: 1px solid rgba(0,0,0,0.05);
        color: #666;
        font-size: 0.8rem;
        padding: 10px;
        cursor: pointer;
        border-radius: 6px;
        margin-top: auto;
        margin-bottom: 5px;
        z-index: 5;
        font-weight: bold;
        flex-shrink: 0;
    }
    .collapse-btn:hover { background: rgba(255,255,255,0.9); }
    .collapse-btn:active { transform: scale(0.98); }

    .system-funcs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        transition: max-height 0.4s ease, opacity 0.3s ease, margin 0.3s ease;
        max-height: 500px;
        overflow: hidden;
        opacity: 1;
        flex-shrink: 0;
    }
    .system-funcs.collapsed { 
        max-height: 0; 
        opacity: 0; 
        margin: 0; 
        padding: 0; 
        pointer-events: none; 
    }

    .sys-btn {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0, 0, 0, 0.05);
        color: #555;
        padding: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        border-radius: 6px;
        text-align: center;
    }
    .sys-btn:hover { background: #fff; border-color: #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    @media (max-aspect-ratio: 1/1) or (max-width: 768px) {
        main { flex-direction: column; }
        
        #history-panel { 
            flex: 1; 
            padding: 15px; 
        }
        
        #control-panel { 
            width: 100%;
            height: auto;
            max-height: 45vh;
            border-left: none; 
            border-top: 1px solid rgba(255,255,255,0.5); 
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            padding: 12px 15px;
        }
        
        .action-grid { max-height: 180px; min-height: 100px; }
        .msg { font-size: 0.95rem; max-width: 95%; }
        
        textarea { height: 36px; }
    }

    /* --- Modal 通用样式 --- */
    .modal-overlay {
        position: fixed; 
        inset: 0;
        background: rgba(0,0,0,0.4);
        backdrop-filter: blur(5px);
        z-index: 3000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        display: none;
    }
    
    .setup-container, .editor-container {
        width: 100%;
        max-width: 550px;
        max-height: 90vh;
        overflow-y: auto;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 25px;
        color: #333;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    h2 { 
        color: var(--primary-color); 
        border-bottom: 1px solid #eee; 
        padding-bottom: 12px; 
        margin-bottom: 20px; 
        font-size: 1.2rem;
    }
    
    .input-group { margin-bottom: 15px; }
    label { display: block; color: #666; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; }
    
    input[type="text"], input[type="password"], input[type="number"], select, textarea.setup-textarea {
        width: 100%; 
        padding: 10px;
        background: #f7f9fa; 
        border: 1px solid #e1e4e8; 
        color: #333;
        border-radius: 6px; 
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--primary-color); background: #fff; }
    
    textarea.setup-textarea { min-height: 80px; font-family: inherit; line-height: 1.4; }

    .mode-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .mode-btn {
        padding: 8px 5px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        color: #666;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        font-size: 0.85rem;
    }
    .mode-btn.active {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
        font-weight: bold;
    }
    
    .setup-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
    
    .btn-primary { background: var(--primary-color); color: white; border:none; padding:10px; border-radius:6px; cursor:pointer; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-danger { background: #ff6b6b; color: white; border:none; padding:10px; border-radius:6px; cursor:pointer; }
    .btn-danger:hover { background: #e05555; }

    .worldbook-section { background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 15px; }
    .worldbook-item {
        background: #fff; padding: 8px 10px; margin-bottom: 6px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee;
    }
    .worldbook-item.active { border: 1px solid var(--primary-color); background: rgba(141, 163, 153, 0.05); }
    .worldbook-item-title { font-size: 0.9rem; color: #444; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    .wb-btn { padding: 4px 10px; font-size: 0.75rem; background: #e9e9e9; color: #555; border: none; border-radius: 3px; cursor: pointer; margin-left: 5px;}
    .wb-btn:hover { background: #d0d0d0; }
    .wb-btn.delete { background: #fee; color: #d33; }
    .wb-btn.delete:hover { background: #fdd; }

    .context-menu {
        position: fixed;
        background: #ffffff;
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 6px 0;
        z-index: 1000;
        min-width: 120px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        display: none;
    }
    .context-menu-item { 
        padding: 12px 16px; 
        color: #444; 
        cursor: pointer; 
        font-size: 0.95rem; 
        transition: background 0.1s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .context-menu-item:hover { background: #f5f7fa; color: var(--primary-color); }
    .context-menu-item.danger { color: #ff5555; border-top: 1px solid #f0f0f0; margin-top: 2px; }
    .context-menu-item.danger:hover { background: #fff0f0; }
    
    #loading-indicator {
        position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
        background: rgba(255,255,255,0.9); color: var(--primary-color); padding: 8px 20px; 
        border-radius: 20px; font-size: 0.85rem; display: none; z-index: 50;
        border: 1px solid rgba(0,0,0,0.1); font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .user-panel-container {
        width: 100%;
        max-width: 400px;
        max-height: 85vh;
        overflow-y: auto;
        background: linear-gradient(135deg, #f5f7fa 0%, #e8ebe9 100%);
        border: 2px solid var(--primary-color);
        border-radius: 16px;
        padding: 25px;
        color: #333;
        box-shadow: 0 15px 50px rgba(0,0,0,0.2);
    }

    .user-panel-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px dashed var(--primary-color);
    }

    .user-panel-header h2 {
        font-family: var(--font-serif);
        color: var(--primary-color);
        border: none;
        margin-bottom: 5px;
    }

    .user-panel-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid var(--primary-color);
        margin: 10px auto;
        background: linear-gradient(135deg, #8da399, #a8c4b8);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
        font-family: var(--font-serif);
    }

    .user-stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 20px;
    }

    .stat-item {
        background: white;
        border-radius: 10px;
        padding: 12px;
        text-align: center;
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .stat-item-label {
        font-size: 0.75rem;
        color: #888;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .stat-item-value {
        font-size: 1.1rem;
        color: var(--primary-color);
        font-weight: bold;
        font-family: var(--font-serif);
    }

    .stat-item-bar {
        height: 6px;
        background: #eee;
        border-radius: 3px;
        margin-top: 8px;
        overflow: hidden;
    }

    .stat-item-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), #a8c4b8);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .user-panel-section {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid rgba(0,0,0,0.08);
    }

    .user-panel-section-title {
        font-size: 0.85rem;
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .user-panel-section-title::before {
        content: '◆';
        font-size: 0.7rem;
    }

    .trait-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .trait-tag {
        background: rgba(141, 163, 153, 0.15);
        color: #5d6e65;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        border: 1px solid rgba(141, 163, 153, 0.3);
    }

    .user-panel-close {
        width: 100%;
        margin-top: 
        10px;
        padding: 12px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
        font-family: var(--font-serif);
    }

    .user-panel-close:hover {
        background: var(--primary-hover);
    }

    .shortcut-inputs input {
        margin-bottom: 8px;
    }

    /* --- 暗卫图鉴样式 --- */
    .guards-gallery-container {
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        background: linear-gradient(135deg, #f8faf9 0%, #e8f0ed 100%);
        border: 2px solid var(--primary-color);
        border-radius: 16px;
        padding: 25px;
        color: #333;
        box-shadow: 0 15px 50px rgba(0,0,0,0.2);
    }

    .guards-gallery-header {
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--primary-color);
    }

    .guards-gallery-header h2 {
        font-family: var(--font-serif);
        color: var(--primary-color);
        border: none;
        font-size: 1.5rem;
        margin-bottom: 8px;
    }

    .guards-stats {
        display: flex;
        justify-content: center;
        gap: 30px;
        font-size: 0.9rem;
        color: #666;
    }

    .guards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .guard-card {
        background: white;
        border: 2px solid #e8e8e8;
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .guard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(141, 163, 153, 0.3);
        border-color: var(--primary-color);
    }

    .guard-card.locked {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f5f5f5;
    }

    .guard-card.locked:hover {
        transform: none;
        box-shadow: none;
    }

    .guard-avatar {
        width: 80px;
        height: 80px;
        margin: 0 auto 10px;
        border-radius: 50%;
        background: linear-gradient(135deg, #c8d6cf, #8da399);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: white;
        font-family: var(--font-serif);
        border: 3px solid var(--primary-color);
        overflow: hidden;
    }

    .guard-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .guard-card.locked .guard-avatar {
        background: linear-gradient(135deg, #d0d0d0, #a0a0a0);
        border-color: #999;
    }

    .guard-name {
        font-size: 1rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 5px;
        font-family: var(--font-serif);
    }

    .guard-rank {
        font-size: 0.75rem;
        color: #888;
        padding: 3px 8px;
        background: rgba(141, 163, 153, 0.1);
        border-radius: 10px;
        display: inline-block;
    }

    .guard-card.locked .guard-name,
    .guard-card.locked .guard-rank {
        color: #999;
    }

    /* 暗卫详情面板 - 融合图鉴风格 */
    .guard-detail-container {
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        background: var(--bg-card);
        border: 2px solid var(--primary-color);
        border-radius: 16px;
        padding: 25px;
        color: #333;
        box-shadow: 0 15px 50px rgba(0,0,0,0.25);
        position: relative;
    }

    .guard-detail-loading {
        position: absolute;
        inset: 0;
        background: rgba(255,255,255,0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10;
        font-family: var(--font-serif);
        color: var(--primary-dark);
        font-size: 1.1rem;
    }

    .profile-header {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
    }

    .avatar-box {
        width: 110px;
        height: 150px;
        background: #f4f4f4;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        border-radius: 8px;
        flex-shrink: 0;
    }

    .avatar-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-hint {
        position: absolute;
        bottom: 0;
        width: 100%;
        background: rgba(0,0,0,0.5);
        color: #fff;
        font-size: 0.65rem;
        text-align: center;
        padding: 3px;
        opacity: 0;
        transition: 0.3s;
    }

    .avatar-box:hover .avatar-hint {
        opacity: 1;
    }

    .info-box {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .name-title {
        font-family: var(--font-serif);
        font-size: 1.8rem;
        color: var(--text-main);
        margin-bottom: 8px;
    }

    .rank-badge {
        display: inline-block;
        font-size: 0.75rem;
        background: var(--primary-color);
        color: #fff;
        padding: 3px 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        align-self: flex-start;
    }

    .tags-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .tag {
        font-size: 0.7rem;
        border: 1px solid var(--primary-color);
        color: var(--primary-dark);
        padding: 2px 8px;
        border-radius: 10px;
    }

    .data-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        background: #f8faf8;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 8px;
    }

    .data-item {
        text-align: center;
    }

    .data-label {
        font-size: 0.7rem;
        color: var(--text-sub);
        margin-bottom: 4px;
    }

    .data-val {
        font-family: var(--font-serif);
        font-weight: bold;
        font-size: 1.1rem;
        color: var(--primary-dark);
    }

    .bio-section {
        border-top: 1px dashed var(--border);
        padding-top: 20px;
        margin-bottom: 20px;
    }

    .bio-title {
        font-size: 0.85rem;
        font-weight: bold;
        color: var(--primary-dark);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .bio-title::before {
        content: '❖';
        font-size: 0.7rem;
    }

    .bio-text {
        font-size: 0.9rem;
        line-height: 1.8;
        color: var(--text-main);
        text-align: justify;
        white-space: pre-wrap;
    }

    .guard-action-btns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed var(--border);
    }

    .guard-action-btn {
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: var(--font-serif);
        font-weight: bold;
    }

    .guard-action-btn.chat {
        background: var(--primary-color);
        color: white;
    }

    .guard-action-btn.chat:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(141, 163, 153, 0.4);
    }

    .guard-action-btn.meet {
        background: #a8c4b8;
        color: white;
    }

    .guard-action-btn.meet:hover {
        background: #8da399;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(168, 196, 184, 0.4);
    }

    .guard-action-btn.edit {
        background: #f0f5f0;
        color: var(--primary-dark);
        border: 1px solid var(--border);
    }

    .guard-action-btn.edit:hover {
        background: #e8f0e8;
    }

    .guard-action-btn.regen {
        background: var(--primary-light);
        color: white;
    }

    .guard-action-btn.regen:hover {
        background: var(--primary-color);
    }

    .guard-action-btn.delete {
        background: #fef5f5;
        color: #c77;
        border: 1px solid #f0d8d8;
    }

    .guard-action-btn.delete:hover {
        background: #fce8e8;
    }

    .guard-action-btn.settings {
        background: #e8e8e8;
        color: #666;
    }

    .guard-action-btn.settings:hover {
        background: #d0d0d0;
    }

    .guard-action-btn.close {
        background: #f5f5f5;
        color: #888;
        grid-column: 1 / -1;
    }

    .guard-action-btn.close:hover {
        background: #e0e0e0;
    }

    /* 暗卫互动面板 - 线上传音风格 */
    #guard-chat-modal-online {
        position: fixed;
        inset: 0;
        background: #f4f6f4;
        z-index: 3500;
        display: none;
        flex-direction: column;
    }

    .chat-header-online {
        padding: 12px 15px;
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chat-header-online .title {
        font-family: var(--font-serif);
        color: #fff;
        font-size: 1.1rem;
        font-weight: bold;
    }

    .chat-header-online .close-btn {
        background: rgba(255,255,255,0.2);
        color: #fff;
        border: none;
        padding: 5px 15px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .chat-history-online {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f4f6f4;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-bottom: 100px;
    }

    /* 暗卫互动面板 - 线下召见风格 */
    #guard-chat-modal-offline {
        position: fixed;
        inset: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23f8faf8" width="100" height="100"/><path d="M0 50 Q25 45 50 50 T100 50" stroke="%23e0e4e0" fill="none" opacity="0.3"/></svg>');
        z-index: 3500;
        display: none;
        flex-direction: column;
    }

    .chat-header-offline {
        padding: 15px 20px;
        background: linear-gradient(to bottom, #fff 0%, #f8faf8 100%);
        border-bottom: 2px solid var(--primary-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }

    .chat-header-offline .title {
        font-family: var(--font-serif);
        color: var(--primary-dark);
        font-size: 1.2rem;
        font-weight: bold;
        letter-spacing: 3px;
    }

    .chat-header-offline .close-btn {
        background: transparent;
        color: var(--text-sub);
        border: 1px solid var(--border);
        padding: 5px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
    }

    .chat-history-offline {
        flex: 1;
        overflow-y: auto;
        padding: 25px;
        background: rgba(255,255,255,0.6);
        display: flex;
        flex-direction: column;
        gap: 18px;
        padding-bottom: 120px;
    }

    /* 聊天气泡样式 */
    .bubble {
        max-width: 85%;
        padding: 12px 16px;
        font-size: 0.95rem;
        line-height: 1.6;
        position: relative;
        word-wrap: break-word;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .bubble.selected {
        box-shadow: 0 0 0 2px var(--primary-color);
    }

    .bubble.ai {
        background: #fff;
        border: 1px solid #e0e0e0;
        align-self: flex-start;
        border-top-left-radius: 2px;
        color: #333;
    }

    .bubble.user {
        background: var(--primary-color);
        color: #fff;
        align-self: flex-end;
        border-top-right-radius: 2px;
        box-shadow: 0 2px 5px rgba(141, 163, 153, 0.4);
    }

    .bubble.favorited::after {
        content: '⭐';
        position: absolute;
        top: -8px;
        right: -8px;
        font-size: 1.2rem;
    }

    .typing-indicator {
        max-width: 85%;
        padding: 12px 16px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        border-top-left-radius: 2px;
        align-self: flex-start;
        color: var(--text-sub);
        font-size: 0.9rem;
        font-style: italic;
    }

    /* 聊天输入区域 */
    .chat-input-area {
        padding: 12px 15px;
        border-top: 1px solid var(--border);
        background: #fff;
        display: flex;
        gap: 10px;
        align-items: center;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
    }

    .reply-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.2s;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(141, 163, 153, 0.3);
    }

    .reply-btn:active {
        transform: scale(0.95);
    }

    .reply-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
    }

    .input-wrapper {
        flex: 1;
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .chat-input {
        flex: 1;
        border: 1px solid var(--border);
        padding: 10px 12px;
        border-radius: 20px;
        font-size: 0.95rem;
        max-height: 100px;
        resize: none;
        outline: none;
        background: #f9f9f9;
        font-family: inherit;
        height: auto;
    }

    .chat-input:focus {
        background: #fff;
        border-color: var(--primary-color);
    }

    .send-btn {
        background: transparent;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .send-btn:active {
        background: var(--primary-color);
        color: #fff;
    }

    /* 气泡操作菜单 */
    .bubble-menu {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: rgba(255,255,255,0.98);
        backdrop-filter: blur(10px);
        border: 2px solid var(--primary-light);
        border-radius: 30px;
        padding: 12px 25px;
        display: flex;
        gap: 20px;
        box-shadow: 0 5px 20px rgba(141, 163, 153, 0.25);
        z-index: 3600;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .bubble-menu.show {
        transform: translateX(-50%) translateY(0);
    }

    .menu-orb {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.3rem;
        border: 2px solid transparent;
    }

    .menu-orb.edit-orb {
        background: linear-gradient(135deg, #f0f5f0 0%, #e8f0e8 100%);
        color: var(--primary-dark);
        border-color: var(--border);
    }

    .menu-orb.favorite-orb {
        background: linear-gradient(135deg, #fffef5 0%, #fef9e8 100%);
        color: #d4a574;
        border-color: #f0e8d0;
    }

    .menu-orb.delete-orb {
        background: linear-gradient(135deg, #fef5f5 0%, #fce8e8 100%);
        color: #c77;
        border-color: #f0d8d8;
    }

    .menu-orb.regen-orb {
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
        color: #fff;
        border-color: var(--primary-color);
    }

    .menu-orb:active {
        transform: scale(0.9);
    }

    /* 暗卫设置面板 */
    .guard-settings-section {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .guard-settings-title {
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .api-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: #666;
    }

    .api-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .api-inputs {
        display: none;
        gap: 10px;
        flex-direction: column;
    }

    .api-inputs.active {
        display: flex;
    }

    /* 新人提示样式 */
    .new-guard-notice {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(232, 240, 237, 0.95));
        border: 2px solid var(--primary-color);
        border-radius: 12px;
        padding: 15px 20px;
        margin: 10px 0;
        box-shadow: 0 5px 15px rgba(141, 163, 153, 0.3);
        animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .new-guard-notice-title {
        font-size: 1rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 8px;
        font-family: var(--font-serif);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .new-guard-notice-title::before {
        content: '◆';
        font-size: 0.8rem;
    }

    .new-guard-notice-content {
        font-size: 0.9rem;
        color: #555;
        line-height: 1.5;
    }

    .new-guard-notice-keywords {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .keyword-tag {
        background: rgba(141, 163, 153, 0.2);
        color: #5d6e65;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        border: 1px solid rgba(141, 163, 153, 0.4);
    }

    /* 收藏夹样式 */
    .fav-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .fav-item {
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 10px;
        background: #fafafa;
    }

    .fav-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.8rem;
        color: var(--text-sub);
    }

    .fav-item-content {
        font-size: 0.9rem;
        line-height: 1.6;
        color: var(--text-main);
    }

    .fav-item-delete {
        background: none;
        border: none;
        color: #c77;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .hidden { display: none !important; }
    .input-full { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; outline: none; }
    
        /* 在场暗卫选择列表 */
    .guards-select-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 40px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #eee;
    }

    .guard-select-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .guard-select-item:hover {
        border-color: var(--primary-color);
        background: rgba(141, 163, 153, 0.1);
    }

    .guard-select-item.present {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .guard-select-item.present:hover {
        background: var(--primary-hover);
    }

    .guard-select-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #c8d6cf, #8da399);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: white;
        overflow: hidden;
    }

    .guard-select-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .guard-select-item.present .guard-select-avatar {
        background: rgba(255,255,255,0.3);
    }

    .present-guards-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.75rem;
        color: var(--primary-color);
        padding: 4px 8px;
        background: rgba(141, 163, 153, 0.1);
        border-radius: 12px;
        margin-left: 10px;
    }

    .present-guards-indicator .count {
        background: var(--primary-color);
        color: white;
        padding: 1px 6px;
        border-radius: 10px;
        font-weight: bold;
    }

    .empty-guards-hint {
        color: #999;
        font-size: 0.85rem;
        text-align: center;
        padding: 15px;
    }
    
        /* ========== 增强版个人面板 ========== */
    .stat-item.editable {
        cursor: pointer;
        transition: all 0.2s;
    }

    .stat-item.editable:hover {
        background: rgba(141, 163, 153, 0.1);
        border-color: var(--primary-color);
    }

    .stat-item.editable:hover::after {
        content: '✎';
        position: absolute;
        top: 5px;
        right: 8px;
        font-size: 0.7rem;
        color: var(--primary-color);
    }

    .stat-item {
        position: relative;
    }

    .trait-tag.removable {
        cursor: pointer;
        position: relative;
        padding-right: 20px;
    }

    .trait-tag.removable:hover {
        background: rgba(255, 100, 100, 0.2);
        border-color: #c77;
    }

    .trait-tag.removable::after {
        content: '×';
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.9rem;
        color: #c77;
        opacity: 0;
        transition: 0.2s;
    }

    .trait-tag.removable:hover::after {
        opacity: 1;
    }

    .add-trait-btn {
        background: transparent;
        border: 1px dashed var(--primary-color);
        color: var(--primary-color);
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .add-trait-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .user-panel-section.editable-status {
        cursor: pointer;
        transition: all 0.2s;
    }

    .user-panel-section.editable-status:hover {
        border-color: var(--primary-color);
        background: rgba(141, 163, 153, 0.05);
    }

    .relationship-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }

    .relationship-item {
        text-align: center;
        padding: 10px;
        background: rgba(141, 163, 153, 0.08);
        border-radius: 8px;
    }

    .relationship-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary-color);
        font-family: var(--font-serif);
    }

    .relationship-label {
        font-size: 0.7rem;
        color: #888;
        margin-top: 3px;
    }


    .achievement-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        background: linear-gradient(135deg, #e8f0ed, #d4e0d8);
        border: 1px solid #b8c8be;
        border-radius: 12px;
        font-size: 0.75rem;
        color: #5d6e65;
    }

    .achievement-badge.locked {
        background: #f0f0f0;
        border-color: #ddd;
        color: #999;
        opacity: 0.6;
    }

    /* ========== 暗卫权重选择器 ========== */
    .weight-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 8px;
    }

    .weight-option {
        flex: 1;
        padding: 10px 8px;
        text-align: center;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.8rem;
    }

    .weight-option:hover {
        border-color: var(--primary-color);
    }

    .weight-option.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .weight-option-icon {
        font-size: 1.2rem;
        margin-bottom: 3px;
    }

    .weight-option-label {
        font-weight: bold;
    }

    .weight-option-desc {
        font-size: 0.65rem;
        opacity: 0.8;
        margin-top: 2px;
    }

    .weight-option.active .weight-option-desc {
        opacity: 1;
    }
        /* 修复编辑面板层级 */
    #guard-edit-modal {
        z-index: 3100;
    }
    
    #guard-settings-modal {
        z-index: 3100;
    }
    
    #bubble-edit-modal {
        z-index: 3700;
    }
    
        /* --- 角落功能按钮 --- */
    .corner-btn {
        position: absolute;
        top: 20px;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(93, 110, 101, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #5d6e65;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        z-index: 2010;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .corner-btn:hover {
        background: rgba(255, 255, 255, 0.8);
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(141, 163, 153, 0.4);
    }

    .corner-btn.left { left: 20px; }
    .corner-btn.right { right: 20px; }
    
    /* --- 娱乐系统主功能区样式 --- */
.ent-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.ent-item {
    background: linear-gradient(135deg, #ffffff 0%, #f1f5f3 100%);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    box-shadow: var(--shadow-light);
}

.ent-item:hover {
    transform: translateY(-3px);
    border-color: var(--primary-color);
    box-shadow: 0 6px 15px rgba(141, 163, 153, 0.2);
}

.ent-icon {
    font-size: 2rem;
}

.ent-name {
    font-family: var(--font-serif);
    font-weight: bold;
    color: var(--primary-dark);
}

/* --- 块块专用样式 --- */
.fanfic-container {
    width: 100%;
    max-width: 800px;
    background: #fffefb; /* 类似纸张的颜色 */
    border: 2px solid #dcd3c0;
    border-radius: 8px;
    padding: 20px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.fanfic-header {
    border-bottom: 2px double #dcd3c0;
    padding-bottom: 15px;
    margin-bottom: 20px;
    text-align: center;
}

.fanfic-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.story-card {
    border: 1px solid #eee;
    padding: 15px;
    border-radius: 6px;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
    overflow: hidden;
}

.story-card:hover {
    background: #f9f6f0;
    border-color: #dcd3c0;
}

.story-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
    background: var(--primary-color);
    opacity: 0.6;
}

.story-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #444;
    margin-bottom: 5px;
    font-family: var(--font-serif);
}

.story-meta {
    font-size: 0.8rem;
    color: #888;
    display: flex;
    gap: 10px;
    margin-bottom: 8px;
}

.story-intro {
    font-size: 0.85rem;
    color: #666;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* 最多显示2行文本 */
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.fanfic-tag {
    font-size: 0.7rem;
    padding: 1px 6px;
    background: #e8edea;
    color: #5d6e65;
    border-radius: 4px;
}

/* 移动端适配 */
@media (max-width: 600px) {
    .ent-grid { grid-template-columns: 1fr; }
}


/* 娱乐系统标题样式 */
.entertainment-container h2 {
    text-align: center;
    font-family: var(--font-serif); /* 使用楷体 */
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 15px;
    margin-bottom: 20px;
}

/* 娱乐项目网格布局 - 用于放置多个娱乐模块入口 */
.entertainment-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 两列布局 */
    gap: 15px;
    margin-bottom: 20px;
}

/* 单个娱乐项目卡片样式 */
.entertainment-item {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 25px 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: var(--font-serif);
    font-size: 1.1rem;
    color: var(--primary-dark);
}

/* 鼠标悬停时的效果 */
.entertainment-item:hover {
    border-color: var(--primary-color);
    background: rgba(141, 163, 153, 0.1);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(141, 163, 153, 0.3);
}

/* 娱乐项目图标样式（可选，用于未来扩展） */
.entertainment-item-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    color: var(--primary-color);
}

/* ========== 同人文模块 - 全新重构版 ========== */
#fanfic-module {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #f8f9f8;
    z-index: 4000;
    display: none;
    flex-direction: column;
}

/* 顶部导航 */
.fanfic-topbar {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.fanfic-back-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
}

.fanfic-topbar-title {
    flex: 1;
    text-align: center;
    font-family: var(--font-serif);
    font-size: 1.1rem;
    color: white;
    font-weight: bold;
}

/* 板块标签栏 */
.fanfic-tabs {
    display: flex;
    background: white;
    border-bottom: 1px solid #e8e8e8;
    padding: 0 20px;
}

.fanfic-tab {
    padding: 15px 25px;
    font-size: 0.95rem;
    color: #666;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    font-family: var(--font-serif);
}

.fanfic-tab:hover {
    color: var(--primary-color);
}

.fanfic-tab.active {
    color: var(--primary-dark);
    border-bottom-color: var(--primary-color);
    font-weight: bold;
}

/* 主内容区 */
.fanfic-body {
    flex: 1;
    overflow-y: auto;
    background: #f5f7f5;
}

/* ===== 创作板块 ===== */
.fanfic-create-panel {
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
}

/* 创作操作栏 */
.fanfic-create-toolbar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.fanfic-setting-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: white;
    border: 2px solid var(--primary-color);
    border-radius: 25px;
    color: var(--primary-dark);
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--font-serif);
}

.fanfic-setting-btn:hover {
    background: var(--primary-color);
    color: white;
}

.fanfic-setting-btn .icon {
    font-size: 1.1rem;
}

.fanfic-generate-main-btn {
    padding: 12px 30px;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border: none;
    border-radius: 25px;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    font-family: var(--font-serif);
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(141, 163, 153, 0.4);
    transition: all 0.3s;
}

.fanfic-generate-main-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(141, 163, 153, 0.5);
}

.fanfic-generate-main-btn:disabled {
    background: #ccc;
    box-shadow: none;
    cursor: not-allowed;
    transform: none;
}

/* 当前设置预览 */
.fanfic-current-settings {
    background: white;
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    border: 1px solid #e8e8e8;
}

.fanfic-setting-tag {
    padding: 6px 12px;
    background: rgba(141, 163, 153, 0.1);
    border-radius: 15px;
    font-size: 0.85rem;
    color: var(--primary-dark);
}

.fanfic-setting-tag.chars {
    background: rgba(141, 163, 153, 0.2);
    font-weight: bold;
}

/* 生成结果列表 */
.fanfic-results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
}

.fanfic-result-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid #e8e8e8;
    position: relative;
}

.fanfic-result-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: var(--primary-color);
}

.fanfic-result-card-title {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    color: var(--primary-dark);
    margin-bottom: 8px;
    font-weight: bold;
}

.fanfic-result-card-meta {
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 10px;
    display: flex;
    gap: 10px;
}

.fanfic-result-card-preview {
    font-size: 0.9rem;
    color: #666;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.fanfic-result-card-new {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary-color);
    color: white;
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 10px;
}
.fanfic-loading-overlay {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid var(--primary-color);
    border-radius: 12px;
    padding: 15px 20px;
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    z-index: 4100;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    min-width: 200px;
}

.fanfic-loading-overlay.active {
    display: flex;
}

.fanfic-loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--primary-light);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: fanfic-spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes fanfic-spin {
    to { transform: rotate(360deg); }
}

.fanfic-loading-text {
    font-family: var(--font-serif);
    color: var(--primary-dark);
    font-size: 1.1rem;
}

.fanfic-loading-progress {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #888;
}

/* ===== 设置弹窗 ===== */
.fanfic-settings-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 4200;
    padding: 20px;
}

.fanfic-settings-modal.active {
    display: flex;
}

.fanfic-settings-panel {
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    padding: 25px;
}

.fanfic-settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.fanfic-settings-title {
    font-family: var(--font-serif);
    font-size: 1.2rem;
    color: var(--primary-dark);
}

.fanfic-settings-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #999;
    cursor: pointer;
}

.fanfic-settings-section {
    margin-bottom: 20px;
}

.fanfic-settings-label {
    font-size: 0.9rem;
    font-weight: bold;
    color: var(--primary-dark);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.fanfic-settings-label::before {
    content: '◆';
    font-size: 0.7rem;
    color: var(--primary-color);
}

/* 角色多选 */
.fanfic-char-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    max-height: 200px;
    overflow-y: auto;
    padding: 5px;
}

.fanfic-char-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 8px;
    background: #f9f9f9;
    border: 2px solid #e8e8e8;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.fanfic-char-option:hover {
    border-color: var(--primary-light);
}

.fanfic-char-option.selected {
    border-color: var(--primary-color);
    background: rgba(141, 163, 153, 0.1);
}

.fanfic-char-option-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    margin-bottom: 5px;
    overflow: hidden;
}

.fanfic-char-option-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.fanfic-char-option-name {
    font-size: 0.8rem;
    color: #555;
    text-align: center;
}

.fanfic-char-option.selected .fanfic-char-option-name {
    color: var(--primary-dark);
    font-weight: bold;
}

/* 选项网格 */
.fanfic-option-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.fanfic-option-btn {
    padding: 10px 16px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
}

.fanfic-option-btn:hover {
    border-color: var(--primary-color);
}

.fanfic-option-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* 数量选择器 */
.fanfic-count-selector {
    display: flex;
    align-items: center;
    gap: 15px;
}

.fanfic-count-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid var(--primary-color);
    background: white;
    color: var(--primary-color);
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.fanfic-count-btn:hover {
    background: var(--primary-color);
    color: white;
}

.fanfic-count-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-dark);
    min-width: 40px;
    text-align: center;
}

.fanfic-settings-confirm {
    width: 100%;
    padding: 14px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    font-family: var(--font-serif);
    margin-top: 10px;
}

.fanfic-settings-confirm:hover {
    background: var(--primary-hover);
}

/* ===== 书架板块 ===== */
.fanfic-bookshelf-panel {
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
    display: none;
}

.fanfic-bookshelf-empty {
    text-align: center;
    padding: 60px 20px;
    color: #888;
}

.fanfic-bookshelf-empty-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    color: var(--primary-light);
}

.fanfic-bookshelf-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.fanfic-book-card {
    background: white;
    border-radius: 12px;
    padding: 18px;
    border: 1px solid #e8e8e8;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.fanfic-book-card:hover {
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border-color: var(--primary-light);
}

.fanfic-book-card-title {
    font-family: var(--font-serif);
    font-size: 1rem;
    color: var(--primary-dark);
    margin-bottom: 5px;
    font-weight: bold;
}

.fanfic-book-card-pairing {
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 8px;
}

.fanfic-book-card-chapters {
    font-size: 0.75rem;
    color: var(--primary-color);
    background: rgba(141, 163, 153, 0.1);
    padding: 3px 8px;
    border-radius: 10px;
    display: inline-block;
}

.fanfic-book-card-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.fanfic-book-action {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
}

.fanfic-book-action.read {
    background: var(--primary-color);
    color: white;
    border: none;
}

.fanfic-book-action.continue {
    background: white;
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
}

.fanfic-book-action:hover {
    opacity: 0.85;
}

/* ===== 阅读视图 ===== */
.fanfic-reader-view {
    position: fixed;
    inset: 0;
    background: #fffefb;
    z-index: 4300;
    display: none;
    flex-direction: column;
}

.fanfic-reader-view.active {
    display: flex;
}

/* ========== 阅读器新样式 ========== */

/* 顶部导航栏重构 */
.fanfic-reader-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: white;
    border-bottom: 1px solid #e8e8e8;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}

/* 章节选择下拉框 */
.fanfic-chapter-select {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f9f9f9;
    font-size: 0.9rem;
    font-family: var(--font-serif);
    color: var(--primary-dark);
    outline: none;
    text-overflow: ellipsis;
}

/* 顶部图标按钮 */
.fanfic-icon-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    padding: 5px;
    cursor: pointer;
    color: #666;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.fanfic-icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--primary-color); }
.fanfic-icon-btn.active { color: #f39c12; } /* 收藏激活色 */

/* 底部导航栏重构 */
.fanfic-reader-footer {
    justify-content: space-between; /* 两端对齐 */
    padding: 15px 20px;
}

.fanfic-nav-btn {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.95rem;
    cursor: pointer;
    font-family: var(--font-serif);
    font-weight: bold;
    border: 1px solid transparent;
    max-width: 48%; /* 留出间隙 */
}

.fanfic-nav-btn.prev {
    background: #f5f5f5;
    color: #666;
    border-color: #ddd;
}

.fanfic-nav-btn.next {
    background: var(--primary-color);
    color: white;
}

.fanfic-nav-btn.regen {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    box-shadow: 0 4px 10px rgba(141, 163, 153, 0.3);
}

.fanfic-nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #eee;
    color: #aaa;
    border: none;
}

/* AI 评论生成按钮 */
.ai-comment-btn {
    width: 100%;
    margin-bottom: 15px;
    padding: 8px;
    background: linear-gradient(to right, #f8f9f8, #fff);
    border: 1px dashed var(--primary-color);
    color: var(--primary-color);
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}
.ai-comment-btn:hover { background: #f0f5f2; }
.ai-comment-btn::before { content: '●'; }

/* 菜单下拉项 */
.reader-menu-dropdown {
    position: absolute;
    top: 50px;
    right: 10px;
    background: white;
    border: 1px solid #eee;
    border-radius: 8px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    display: none;
    flex-direction: column;
    z-index: 4500;
    width: 150px;
}
.reader-menu-dropdown.active { display: flex; }
.reader-menu-item {
    padding: 12px 15px;
    text-align: left;
    background: none;
    border: none;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    color: #444;
    font-size: 0.9rem;
}
.reader-menu-item:hover { background: #f9f9f9; color: var(--primary-color); }
.reader-menu-item.danger { color: #ff5555; }

/* 评论区样式微调 */
.fanfic-comment-item.ai-gen {
    border-left: 3px solid #ffb7b2; /* AI评论标记 */
    background: #fff5f5;
}

.fanfic-reader-back {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: #666;
    cursor: pointer;
    padding: 5px 10px;
}

.fanfic-reader-title {
    flex: 1;
    text-align: center;
    font-family: var(--font-serif);
    font-size: 1rem;
    color: #333;
}

.fanfic-reader-menu-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: #666;
    cursor: pointer;
    padding: 5px 10px;
}

.fanfic-reader-body {
    flex: 1;
    overflow-y: auto;
    padding: 30px 20px;
    padding-bottom: 100px;
}

.fanfic-reader-content {
    max-width: 700px;
    margin: 0 auto;
}

.fanfic-reader-meta {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px dashed #ddd;
}

.fanfic-reader-main-title {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    color: var(--primary-dark);
    margin-bottom: 10px;
}

.fanfic-reader-pairing {
    font-size: 0.9rem;
    color: #888;
}

.fanfic-reader-chapter {
    font-size: 0.85rem;
    color: var(--primary-color);
    margin-top: 5px;
}

/* 段落样式 - 可点击添加段评 */
.fanfic-paragraph {
    font-size: 1rem;
    line-height: 2;
    color: #333;
    margin-bottom: 1.5em;
    text-align: justify;
    font-family: var(--font-serif);
    position: relative;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.2s;
    cursor: pointer;
}

.fanfic-paragraph:hover {
    background: rgba(141, 163, 153, 0.05);
}

.fanfic-paragraph.has-comment::after {
    content: '💬';
    position: absolute;
    right: -25px;
    top: 8px;
    font-size: 0.9rem;
}

/* 段评显示 */
.fanfic-para-comments {
    background: #f9f9f9;
    border-left: 3px solid var(--primary-color);
    padding: 12px 15px;
    margin: -5px 0 15px 20px;
    border-radius: 0 8px 8px 0;
    font-size: 0.85rem;
}

.fanfic-para-comment-item {
    padding: 8px 0;
    border-bottom: 1px dashed #e8e8e8;
    color: #555;
}

.fanfic-para-comment-item:last-child {
    border-bottom: none;
}

.fanfic-para-comment-time {
    font-size: 0.75rem;
    color: #999;
    margin-top: 3px;
}

/* 底部操作栏 */
.fanfic-reader-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid #e8e8e8;
    padding: 12px 20px;
    display: flex;
    justify-content: center;
    gap: 15px;
    z-index: 4310;
}

.fanfic-reader-action {
    padding: 10px 25px;
    border-radius: 25px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--font-serif);
}

.fanfic-reader-action.primary {
    background: var(--primary-color);
    color: white;
    border: none;
}

.fanfic-reader-action.secondary {
    background: white;
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
}

.fanfic-reader-action:hover {
    transform: scale(1.02);
}

/* ===== 评论区 ===== */
.fanfic-comments-section {
    max-width: 700px;
    margin: 30px auto 0;
    padding-top: 20px;
    border-top: 2px solid var(--primary-light);
}

.fanfic-comments-title {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    color: var(--primary-dark);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.fanfic-comments-title::before {
    content: '◇';
}

.fanfic-comment-input-area {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.fanfic-comment-input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 25px;
    font-size: 0.95rem;
    outline: none;
}

.fanfic-comment-input:focus {
    border-color: var(--primary-color);
}

.fanfic-comment-submit {
    padding: 12px 20px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 0.9rem;
}

.fanfic-comment-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.fanfic-comment-item {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 10px;
}

.fanfic-comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.fanfic-comment-user {
    font-weight: bold;
    color: var(--primary-dark);
    font-size: 0.9rem;
}

.fanfic-comment-time {
    font-size: 0.75rem;
    color: #999;
}

.fanfic-comment-content {
    font-size: 0.9rem;
    color: #555;
    line-height: 1.6;
}

.fanfic-comment-delete {
    background: none;
    border: none;
    color: #c77;
    font-size: 0.75rem;
    cursor: pointer;
    margin-left: 10px;
}

/* 段评输入弹窗 */
.fanfic-para-comment-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: flex-end;
    justify-content: center;
    z-index: 4400;
}

.fanfic-para-comment-modal.active {
    display: flex;
}

.fanfic-para-comment-panel {
    background: white;
    width: 100%;
    max-width: 500px;
    border-radius: 20px 20px 0 0;
    padding: 20px;
}

.fanfic-para-quote {
    background: #f5f5f5;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 0.85rem;
    color: #666;
    line-height: 1.5;
    max-height: 80px;
    overflow: hidden;
    border-left: 3px solid var(--primary-color);
}

.fanfic-para-comment-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 10px;
    font-size: 0.95rem;
    margin-bottom: 15px;
    outline: none;
}

.fanfic-para-comment-btns {
    display: flex;
    gap: 10px;
}

.fanfic-para-comment-btns button {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.95rem;
    cursor: pointer;
}

.fanfic-para-comment-btns .cancel {
    background: #f5f5f5;
    border: none;
    color: #666;
}

.fanfic-para-comment-btns .submit {
    background: var(--primary-color);
    border: none;
    color: white;
}

/* 响应式 */
@media (max-width: 600px) {
    .fanfic-results-grid {
        grid-template-columns: 1fr;
    }
    
    .fanfic-char-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .fanfic-reader-footer {
        flex-wrap: wrap;
    }
    
    .fanfic-reader-action {
        flex: 1;
        min-width: 100px;
    }
}


/* 1. 顶部导航栏重构 */
.fanfic-reader-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: white;
    border-bottom: 1px solid #e8e8e8;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}

/* 章节选择下拉框 */
.fanfic-chapter-select {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f9f9f9;
    font-size: 0.9rem;
    font-family: var(--font-serif);
    color: var(--primary-dark);
    outline: none;
    text-overflow: ellipsis;
}

/* 顶部圆形按钮 */
.fanfic-icon-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    padding: 5px;
    cursor: pointer;
    color: #666;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}
.fanfic-icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--primary-color); }
.fanfic-icon-btn.active { color: #f39c12; transform: scale(1.1); } /* 收藏星星激活 */

/* 2. 底部导航栏重构 */
.fanfic-reader-footer {
    justify-content: space-between;
    padding: 15px 20px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px);
}

.fanfic-nav-btn {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.95rem;
    cursor: pointer;
    font-family: var(--font-serif);
    font-weight: bold;
    border: 1px solid transparent;
    max-width: 48%;
    transition: all 0.2s;
}

.fanfic-nav-btn.prev {
    background: #f5f5f5;
    color: #666;
    border-color: #ddd;
}

.fanfic-nav-btn.next {
    background: var(--primary-color);
    color: white;
}

.fanfic-nav-btn.regen {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    box-shadow: 0 4px 10px rgba(141, 163, 153, 0.3);
}

.fanfic-nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #eee;
    color: #aaa;
}

/* 3. AI 生成评论按钮 */
.ai-comment-btn {
    width: 100%;
    margin-bottom: 15px;
    padding: 10px;
    background: linear-gradient(to right, #f8f9f8, #fff);
    border: 1px dashed var(--primary-color);
    color: var(--primary-color);
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s;
}
.ai-comment-btn:hover { background: #f0f5f2; transform: translateY(-1px); }
.ai-comment-btn:disabled { cursor: wait; opacity: 0.8; }

/* 4. 右上角下拉菜单 */
.reader-menu-dropdown {
    position: absolute;
    top: 50px;
    right: 10px;
    background: white;
    border: 1px solid #eee;
    border-radius: 8px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    display: none;
    flex-direction: column;
    z-index: 4500;
    width: 160px;
    animation: fadeIn 0.2s ease;
}
.reader-menu-dropdown.active { display: flex; }

.reader-menu-item {
    padding: 12px 15px;
    text-align: left;
    background: none;
    border: none;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    color: #444;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}
.reader-menu-item:hover { background: #f9f9f9; color: var(--primary-color); }
.reader-menu-item.danger { color: #ff5555; }
.reader-menu-item.danger:hover { background: #fff5f5; }

/* 5. ● 跳动小圆点动画 (Loading) */
.typing-dots {
    display: inline-flex;
    align-items: center;
    height: 10px;
}
.typing-dot {
    width: 4px;
    height: 4px;
    background: currentColor;
    border-radius: 50%;
    margin: 0 2px;
    animation: dotJump 1.4s infinite ease-in-out both;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes dotJump {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

/* AI生成的评论特殊标记 */
.fanfic-comment-item.ai-gen {
    border-left: 3px solid #ffb7b2;
    background: #fffafa;
}

/* ========== 平行世界 (AU) 剧场样式 ========== */
#au-module {
    position: fixed;
    inset: 0;
    background: #f0f2f5;
    z-index: 4000;
    display: none;
    flex-direction: column;
}

.au-header {
    background: linear-gradient(135deg, #2c3e50, #4ca1af); /* 深邃风格 */
    padding: 15px 20px;
    color: white;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.au-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
}

/* 设定选择区 */
.au-setup-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.au-section-title {
    font-size: 0.95rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* 主题网格 */
.au-theme-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
}

.au-theme-card {
    border: 2px solid #eee;
    border-radius: 10px;
    padding: 15px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #fafafa;
}

.au-theme-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.au-theme-card.active {
    border-color: #4ca1af;
    background: #eef7f8;
    color: #2c3e50;
}

.au-theme-icon {
    font-size: 1.8rem;
    margin-bottom: 8px;
    display: block;
}

.au-theme-name {
    font-weight: bold;
    font-size: 0.9rem;
}

.au-theme-desc {
    font-size: 0.7rem;
    color: #888;
    margin-top: 4px;
}

/* 角色选择 (复用同人文的样式，微调) */
.au-char-select {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 10px;
}

.au-char-item {
    flex: 0 0 auto;
    width: 70px;
    text-align: center;
    cursor: pointer;
    opacity: 0.6;
    transition: all 0.2s;
}

.au-char-item.active {
    opacity: 1;
    transform: scale(1.1);
}

.au-char-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #ddd;
    margin: 0 auto 5px;
    border: 2px solid transparent;
    overflow: hidden;
}

.au-char-item.active .au-char-avatar {
    border-color: #4ca1af;
    box-shadow: 0 0 10px rgba(76, 161, 175, 0.3);
}

/* 生成结果显示区 */
.au-result-area {
    background: white;
    border-radius: 12px;
    padding: 25px;
    min-height: 200px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    display: none; /* 初始隐藏 */
    animation: fadeIn 0.5s;
    position: relative;
}

.au-story-content {
    font-size: 1rem;
    line-height: 1.8;
    color: #333;
    font-family: var(--font-serif);
    white-space: pre-wrap;
}

.au-story-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #2c3e50;
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.au-action-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 10px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
    transition: all 0.3s;
}

.au-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(44, 62, 80, 0.4);
}

.au-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: #666;
}
/* ========== 🆕 图鉴右上角关闭按钮样式 ========== */
.guards-gallery-header {
    position: relative; /* 关键：为了让叉号绝对定位 */
    /* ...原有样式保持不变... */
}

.close-btn-x {
    position: absolute;
    top: -10px; /* 根据你的 padding 微调 */
    right: -10px;
    background: none;
    border: none;
    font-size: 1.8rem;
    color: #999;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
    z-index: 10;
}

.close-btn-x:hover {
    color: #ff6b6b;
    background: rgba(0,0,0,0.05);
    transform: rotate(90deg);
}
</style>
</head>
<body>

<!-- 主界面 -->
<div id="home-screen">
    <!-- 左上角：系统设置 -->
    <div class="corner-btn left" onclick="openModal('setup-modal')" title="系统设置">⚙</div>
    
    <!-- 右上角：殿下属性 -->
    <div class="corner-btn right" onclick="openUserPanel()" title="殿下属性">◈</div>

    <div class="home-title-box">
        <div class="home-subtitle">玄夜卫系统文字游戏</div>
        <div class="home-title">
            <img src="https://img.heliar.top/file/1769693437339_无标题57_20260129201717.png" style="height: 220px; max-width: 100%; object-fit: contain; margin-top: -25px;">
        </div>
    </div>
    
    <div class="home-menu">
        <div class="start-game-container" onclick="enterGame()">
            <img src="https://img.heliar.top/file/1769693433404_无标题60_20260129211024.png" class="start-game-img">
        </div>

        <!-- 这里的按钮已经被替换和精简 -->
        <button class="home-btn" onclick="openEntertainmentModal()">娱乐系统</button>
        <button class="home-btn" onclick="openGuardsGallery()">暗卫图鉴</button>
        <button class="home-btn" onclick="showToast('暂未开放')">世界地图</button>
    </div>
</div>

<div id="app-root">
    <header>
        <button class="header-btn" onclick="returnToApp()">&lt;</button>
        <span id="header-title">玄夜卫系统</span>
                <div style="display: flex; align-items: center;">
            <span id="save-status" style="font-size: 0.8rem; color: #888;">存档中</span>
            <div class="present-guards-indicator" onclick="openPresentGuardsModal()" style="cursor: pointer;">
                <span>在场</span>
                <span class="count" id="present-count">0</span>
            </div>
        </div>
        <div class="header-btns">
            <button class="header-btn" onclick="openUserPanel()">属性</button>
            <button class="header-btn" onclick="openModal('favorites-modal')">收藏</button>
            <button class="header-btn" onclick="clearAllChat()" title="清空聊天">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6"/>
                </svg>
            </button>
            <button class="header-btn" onclick="openModal('setup-modal')">⚙</button>
        </div>
    </header>

    <main>
        <div id="loading-indicator">天机推演中...</div>
        
        <div id="history-panel"></div>

        <div id="control-panel">
            <label style="font-size: 0.75rem; color: #666; font-weight: bold;">殿下旨意</label>
            <div class="free-input-area">
                <textarea id="free-input" placeholder="输入指令..." onkeydown="handleInputKeydown(event)"></textarea>
                <button class="btn-send" onclick="submitAction('free')">下 达</button>
            </div>

            <label style="font-size: 0.75rem; color: #666; margin-top: 10px; font-weight: bold;">推演分支</label>
            <div id="action-grid" class="action-grid"></div>

            <button id="collapse-trigger" class="collapse-btn" onclick="toggleShortcuts()">▼ 展开/收起系统功能</button>

            <div id="system-funcs" class="system-funcs collapsed">
                <button class="sys-btn" onclick="openModal('summary-editor-modal')">● 记忆摘要</button>
            </div>
        </div>
    </main>
</div>

<!-- 长按菜单 -->
<div id="context-menu" class="context-menu">
    <div class="context-menu-item" id="menu-regen">● 重回此景</div>
    <div class="context-menu-item" id="menu-edit">● 编辑内容</div>  
    <div class="context-menu-item danger" id="menu-delete">● 删除消息</div>
</div>

<!-- 设置面板 -->
<div id="setup-modal" class="modal-overlay">
    <div class="setup-container">
        <h2>玄夜卫系统 · 连接与身份</h2>
        
        <div class="input-group">
            <label>API 地址 (Base URL)</label>
            <input type="text" id="api-url" placeholder="https://api.openai.com/v1">
        </div>
        <div class="input-group">
            <label>API Key</label>
            <input type="password" id="api-key">
        </div>
        <div class="input-group" style="display:flex; gap:10px;">
            <button class="btn-primary" style="flex:1" onclick="fetchModels()">1. 获取模型</button>
            <select id="model-select" style="flex:2;"></select>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

        <div class="input-group">
            <label>长公主封号</label>
            <input type="text" id="player-name" placeholder="昭宁">
        </div>

        <div class="input-group">
            <label>系统模式</label>
            <div class="mode-selector">
                <div class="mode-btn active" data-mode="可爱" onclick="selectMode('可爱')">可爱</div>
                <div class="mode-btn" data-mode="卑微" onclick="selectMode('卑微')">卑微</div>
                <div class="mode-btn" data-mode="严肃" onclick="selectMode('严肃')">严肃</div>
                <div class="mode-btn" data-mode="抽象" onclick="selectMode('抽象')">抽象</div>
            </div>
        </div>
        
        <div class="worldbook-section">
            <label>世界书管理 (可创建多个，点击切换挂载状态)</label>
            <div class="worldbook-list" id="worldbook-list"></div>
            <button class="btn-primary" style="width: 100%;" onclick="createNewWorldbook()">+ 新建世界书</button>
        </div>

        <div class="input-group">
            <label>自身性格设定 (可选，定义长公主性格)</label>
            <textarea class="setup-textarea" id="personality" placeholder="例如：表面骄纵跋扈，实则心思缜密，对忠诚之人极为护短..."></textarea>
        </div>
        
                <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        
        <div class="input-group">
            <label>AI上下文轮数 (发送给AI的历史消息数量，越多越耗token)</label>
            <input type="number" id="context-length" min="2" max="50" value="20" placeholder="默认20">
        </div>
        
        <div class="input-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="enable-time-awareness" style="width: 18px; height: 18px;">
                <span>启用现实时间感知 (AI会根据现实时间描写对应时辰氛围)</span>
            </label>
        </div>
        
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        <div class="input-group" style="background: #f0f5f2; padding:15px; border-radius:8px; border:1px solid var(--border);">
            <label style="color: var(--primary-dark); display:flex; align-items:center; gap:8px; margin-bottom:10px;">
               <input type="checkbox" id="erotic-toggle" onchange="toggleEroticSettings(this.checked)" style="width:18px;height:18px; accent-color: var(--primary-color);">

                <span>启用侍寝情趣模块</span>
            </label>
            
            <div id="erotic-settings" style="display:none;">
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.85rem; margin-bottom:8px; display:block;">攻受倾向</label>
                    <div style="display:flex; gap:10px;">
                        <div class="orient-opt" data-val="gb" onclick="selectOrientation('gb')" style="flex:1; padding:12px; background:#fff; border:2px solid var(--border); border-radius:6px; cursor:pointer; text-align:center; transition: all 0.2s;">
                            <div style="font-weight:bold; color: var(--primary-dark);">GB</div>
                            <div style="font-size:0.7rem; color:#888;">殿下攻方</div>
                        </div>
                        <div class="orient-opt" data-val="bg" onclick="selectOrientation('bg')" style="flex:1; padding:12px; background:#fff; border:2px solid var(--border); border-radius:6px; cursor:pointer; text-align:center; transition: all 0.2s;">
                            <div style="font-weight:bold; color: var(--primary-dark);">BG</div>
                            <div style="font-size:0.7rem; color:#888;">暗卫攻方</div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label style="font-size:0.85rem; margin-bottom:8px; display:block;">XP偏好 (可多选)</label>
                    <div id="xp-tags" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
                    <input type="text" id="custom-xp" placeholder="自定义XP，回车添加" style="margin-top:10px; width:100%;" onkeydown="if(event.key==='Enter'){addCustomXP(); event.preventDefault();}">
                </div>
            </div>
        </div>
        
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

        <div class="input-group">
            <label>初始情景 (留空则随机)</label>
            <input type="text" id="start-scene" placeholder="例：午夜梦回，窗外传来异响...">
        </div>

        <div class="input-group">
            <label>新增快捷指令 (名称|内容，保存后追加到现有指令)</label>
            <div class="shortcut-inputs">
                <input type="text" id="new-shortcut-0" placeholder="名称|指令内容 (可选)">
                <input type="text" id="new-shortcut-1" placeholder="名称|指令内容 (可选)">
                <input type="text" id="new-shortcut-2" placeholder="名称|指令内容 (可选)">
                <input type="text" id="new-shortcut-3" placeholder="名称|指令内容 (可选)">
            </div>
        </div>

        <div class="setup-actions">
            <button class="btn-primary" onclick="initGame()">确认设置</button>
            <button class="btn-primary" style="background: #6e827a;" onclick="exportSave()">导出存档</button>
            <button class="btn-primary" style="background: #6e827a;" onclick="document.getElementById('import-file').click()">导入存档</button>
            <input type="file" id="import-file" style="display:none" accept=".json" onchange="importSave(this)">    
            <button class="btn-danger" onclick="clearData()">重置存档</button>
        </div>
        <div style="margin-top:20px; text-align:center; font-size:0.8rem; color:#666; cursor:pointer;" onclick="closeModal('setup-modal')">
            [暂不修改，返回]
        </div>
    </div>
</div>

<!-- 世界书编辑面板 -->
<div id="worldbook-editor-modal" class="modal-overlay">
    <div class="editor-container">
        <h2>编辑世界书</h2>
        <div class="input-group">
            <label>世界书名称</label>
            <input type="text" id="wb-edit-name" placeholder="例如：大燕王朝背景设定">
        </div>
        <div class="input-group">
            <label>世界书内容</label>
            <textarea class="setup-textarea" id="wb-edit-content" style="min-height: 200px;" placeholder="详细描述世界观、背景设定等..."></textarea>
        </div>
        <div class="editor-actions" style="display:flex; gap:10px;">
            <button class="btn-primary" style="flex:1" onclick="saveWorldbookEdit()">保存</button>
            <button class="btn-danger" style="flex:1" onclick="closeModal('worldbook-editor-modal')">取消</button>
        </div>
    </div>
</div>

<!-- 消息编辑面板 -->
<div id="message-editor-modal" class="modal-overlay">
    <div class="editor-container">
        <h2>编辑内容</h2>
        <div class="input-group">
            <textarea class="setup-textarea" id="msg-edit-content" style="min-height: 300px; font-size: 1rem;" placeholder="输入新的内容..."></textarea>
        </div>
        <div class="editor-actions" style="display:flex; gap:10px;">
            <button class="btn-primary" style="flex:1" onclick="saveMessageEdit()">确认修改</button>
            <button class="btn-danger" style="flex:1" onclick="closeModal('message-editor-modal')">取消</button>
        </div>
    </div>
</div>

<!-- 记忆摘要编辑面板 -->
<div id="summary-editor-modal" class="modal-overlay">
    <div class="editor-container">
        <h2>编辑记忆摘要 (AI记忆)</h2>
        <label style="color:#888; font-size:0.8rem; margin-bottom:10px;">此处内容会被AI永久作为上下文记忆，请概括重要剧情。</label>
        <div class="input-group">
            <textarea class="setup-textarea" id="summary-edit-content" style="min-height: 250px;" placeholder="暂无记忆摘要..."></textarea>
        </div>
        <div class="editor-actions" style="display:flex; gap:10px;">
            <button class="btn-primary" style="flex:1" onclick="saveSummary()">保存记忆</button>
            <button class="btn-danger" style="flex:1" onclick="closeModal('summary-editor-modal')">取消</button>
        </div>
    </div>
</div>

<!-- User属性面板 - 增强版 -->
<div id="user-panel-modal" class="modal-overlay">
    <div class="user-panel-container">
        <div class="user-panel-header">
            <div class="user-panel-avatar" id="user-avatar" onclick="uploadUserAvatar()" style="cursor:pointer; position:relative;">
    <img id="user-avatar-img" src="" class="hidden" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
    <span id="user-avatar-text">昭</span>
    <input type="file" id="user-avatar-upload" class="hidden" accept="image/*" onchange="handleUserAvatarUpload(event)">
</div>
            <h2 id="user-panel-title">昭宁长公主</h2>
            <div style="font-size: 0.85rem; color: #888;">当朝最受宠的长公主殿下</div>
        </div>

        <div class="user-stats-grid">
            <div class="stat-item editable" onclick="editStat('charm')">
                <div class="stat-item-label">魅力值</div>
                <div class="stat-item-value" id="stat-charm">95</div>
                <div class="stat-item-bar"><div class="stat-item-bar-fill" id="bar-charm" style="width: 95%;"></div></div>
            </div>
            <div class="stat-item editable" onclick="editStat('power')">
                <div class="stat-item-label">权势值</div>
                <div class="stat-item-value" id="stat-power">80</div>
                <div class="stat-item-bar"><div class="stat-item-bar-fill" id="bar-power" style="width: 80%;"></div></div>
            </div>
            <div class="stat-item editable" onclick="editStat('wisdom')">
                <div class="stat-item-label">智谋值</div>
                <div class="stat-item-value" id="stat-wisdom">75</div>
                <div class="stat-item-bar"><div class="stat-item-bar-fill" id="bar-wisdom" style="width: 75%;"></div></div>
            </div>
            <div class="stat-item editable" onclick="editStat('fame')">
                <div class="stat-item-label">声望值</div>
                <div class="stat-item-value" id="stat-fame">70</div>
                <div class="stat-item-bar"><div class="stat-item-bar-fill" id="bar-fame" style="width: 70%;"></div></div>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">玄夜卫数量</div>
                <div class="stat-item-value" id="stat-guards">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">私库财富</div>
                <div class="stat-item-value" id="stat-wealth">∞</div>
            </div>
        </div>
       

        <!-- 暗卫关系统计 -->
        <div class="user-panel-section">
            <div class="user-panel-section-title">暗卫关系</div>
            <div class="relationship-grid">
                <div class="relationship-item">
                    <div class="relationship-value" id="rel-total">0</div>
                    <div class="relationship-label">已解锁</div>
                </div>
                <div class="relationship-item">
                    <div class="relationship-value" id="rel-intimate">0</div>
                    <div class="relationship-label">心腹 (好感≥80)</div>
                </div>
                <div class="relationship-item">
                    <div class="relationship-value" id="rel-chats">0</div>
                    <div class="relationship-label">总对话数</div>
                </div>
            </div>
        </div>

        <div class="user-panel-section">
            <div class="user-panel-section-title">性格特质 <span style="font-size:0.7rem;color:#888;">(点击可删除)</span></div>
            <div class="trait-tags" id="trait-tags">
                <!-- 动态生成 -->
            </div>
            <button class="add-trait-btn" onclick="addNewTrait()" style="margin-top: 10px;">+ 添加特质</button>
        </div>

        <div class="user-panel-section editable-status" onclick="editStatus()">
            <div class="user-panel-section-title">当前状态 <span style="font-size:0.7rem;color:#888;">(点击编辑)</span></div>
            <div style="font-size: 0.9rem; color: #555; line-height: 1.6;" id="user-status">
                身体康健，心情尚可。近日朝中局势暗流涌动，需多加留意。
            </div>
        </div>

        <div class="user-panel-section">
            <div class="user-panel-section-title">特殊权限</div>
            <div class="trait-tags">
                <span class="trait-tag">玄夜卫统帅权</span>
                <span class="trait-tag">先斩后奏</span>
                <span class="trait-tag">自由出入宫禁</span>
                <span class="trait-tag">调用国库</span>
            </div>
        </div>

        <div class="user-panel-section">
            <div class="user-panel-section-title">成就徽章</div>
            <div class="trait-tags" id="achievement-tags">
                <!-- 动态生成 -->
            </div>
        </div>

        <button class="user-panel-close" onclick="closeModal('user-panel-modal')">
            关闭
        </button>
    </div>
</div>



<!-- 收藏夹面板 -->
<div id="favorites-modal" class="modal-overlay">
    <div class="editor-container" style="max-width: 500px;">
        <h2>我的收藏</h2>
        <div id="favorites-list" class="fav-list"></div>
        <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="closeModal('favorites-modal')">关闭</button>
    </div>
</div>

<!-- 在场暗卫管理面板 -->
<div id="present-guards-modal" class="modal-overlay">
    <div class="editor-container" style="max-width: 500px;">
        <h2>当前在场暗卫</h2>
        
                <!-- 自动挂载设置 -->
        <div style="background: #f0f5f0; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #d8e0d8;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="auto-mount-toggle" onchange="toggleAutoMount()" style="width: 18px; height: 18px;">
                    <span>智能自动挂载</span>
                </label>
                <span style="font-size: 0.7rem; color: #888;">AI提到暗卫时自动入场</span>
            </div>
            <div id="auto-mount-settings" style="display: none;">
                <div style="display: flex; align-items: center; gap: 10px; font-size: 0.85rem;">
                    <span>最大在场人数：</span>
                    <input type="number" id="max-present-input" min="1" max="20" value="5" 
                           style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"
                           onchange="updateMaxPresent()">
                    <span style="color: #888; font-size: 0.75rem;">（超出后自动移除）</span>
                </div>
            </div>
        </div>
        
        <!-- 权重选择器 -->
        <div class="weight-selector">
            <div class="weight-option" data-weight="lite" onclick="setGuardWeight('lite')">
                <div class="weight-option-icon">⊙</div>
                <div class="weight-option-label">精简</div>
                <div class="weight-option-desc">仅名字+关键词</div>
            </div>
            <div class="weight-option active" data-weight="standard" onclick="setGuardWeight('standard')">
                <div class="weight-option-icon">○</div>
                <div class="weight-option-label">标准</div>
                <div class="weight-option-desc">包含完整档案</div>
            </div>
            <div class="weight-option" data-weight="deep" onclick="setGuardWeight('deep')">
                <div class="weight-option-icon">●</div>
                <div class="weight-option-label">深度</div>
                <div class="weight-option-desc">档案+聊天记忆</div>
            </div>
        </div>
        
        <p style="font-size: 0.8rem; color: #888; margin-bottom: 15px;">
            在场暗卫的档案会自动注入AI上下文。点击暗卫可切换在场状态。
        </p>
        
        <div style="margin-bottom: 15px;">
            <div style="font-size: 0.85rem; font-weight: bold; color: var(--primary-color); margin-bottom: 10px;">● 当前在场</div>
            <div id="present-guards-list" class="guards-select-list"></div>
        </div>
        
        <div style="border-top: 1px dashed #ddd; padding-top: 15px;">
            <div style="font-size: 0.85rem; font-weight: bold; color: #888; margin-bottom: 10px;">○ 可召唤</div>
            <div id="available-guards-list" class="guards-select-list"></div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-primary" style="flex: 1;" onclick="clearAllPresentGuards()">全部退场</button>
            <button class="btn-danger" style="flex: 1;" onclick="closeModal('present-guards-modal')">关闭</button>
        </div>
    </div>
</div>



<!-- 暗卫图鉴面板 -->
<!-- 暗卫图鉴面板 (新版：右上角关闭) -->
<div id="guards-gallery-modal" class="modal-overlay">
    <div class="guards-gallery-container">
        <div class="guards-gallery-header">
            <!--  新增：右上角叉号 -->
            <button class="close-btn-x" onclick="closeModal('guards-gallery-modal')">×</button>
            
            <h2>玄夜卫图鉴</h2>
            <div class="guards-stats">
                <span>已解锁：<strong id="unlocked-count">0</strong></span>
                <span>总计：<strong id="total-count">0</strong></span>
            </div>
        </div>

        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <input type="text" id="manual-guard-input" class="input-full" style="margin-bottom: 0; flex: 1;" placeholder="手动录入：【新暗卫：名字|关键词】">
            <button class="btn-primary" onclick="manualTriggerGuard()">识别</button>
        </div>

        <div class="guards-grid" id="guards-grid">
            <!-- 动态生成暗卫卡片 -->
        </div>

    </div>
</div>

<!-- 暗卫详情面板 -->
<div id="guard-detail-modal" class="modal-overlay">
    <div class="guard-detail-container">
        <div class="guard-detail-loading" id="guard-detail-loading">档案修缮中...</div>
        
        <div class="profile-header">
            <div class="avatar-box" onclick="uploadGuardAvatar()">
                <img id="guard-detail-avatar-img" src="" class="hidden">
                <div id="guard-avatar-placeholder" style="color:#999; font-size:0.8rem;">上传立绘</div>
                <div class="avatar-hint">点击修改</div>
                <input type="file" id="guard-avatar-upload" class="hidden" accept="image/*" onchange="handleGuardAvatarUpload(event)">
            </div>
            <div class="info-box">
                <h2 class="name-title" id="guard-detail-name">---</h2>
                <div class="rank-badge" id="guard-detail-rank">---</div>
                <div class="tags-row" id="guard-detail-tags"></div>
            </div>
        </div>

        <div class="data-grid">
            <div class="data-item">
                <div class="data-label">忠诚度</div>
                <div class="data-val" id="guard-loyalty">100</div>
            </div>
            <div class="data-item">
                <div class="data-label">武力值</div>
                <div class="data-val" id="guard-skill">0</div>
            </div>
            <div class="data-item">
                <div class="data-label">好感度</div>
                <div class="data-val" id="guard-intimacy">0</div>
            </div>
        </div>

        <div class="bio-section">
            <div class="bio-title">档案详述</div>
            <div class="bio-text" id="guard-description">暂无详述...</div>
        </div>

        <div class="guard-action-btns">
            <button class="guard-action-btn chat" onclick="openGuardChat('online')">❖ 传音入密</button>
            <button class="guard-action-btn meet" onclick="openGuardChat('offline')">◇ 寝宫召见</button>
            <button class="guard-action-btn edit" onclick="openGuardEditModal()">修缮档案</button>
            <button class="guard-action-btn regen" onclick="regenGuardProfile()">重新生成</button>
            <button class="guard-action-btn settings" onclick="openGuardSettings()">独立设置</button>
            <button class="guard-action-btn delete" onclick="deleteCurrentGuard()">删除暗卫</button>
            <button class="guard-action-btn close" onclick="closeGuardDetail()">返回图鉴</button>
        </div>
    </div>
</div>

<!-- 暗卫档案编辑面板 -->
<div id="guard-edit-modal" class="modal-overlay">
    <div class="editor-container">
        <h2>修缮卷宗</h2>
        <div class="input-group">
            <label>档案详述</label>
            <textarea class="setup-textarea" id="guard-edit-desc" style="min-height: 250px;"></textarea>
        </div>
        <div class="editor-actions" style="display:flex; gap:10px;">
            <button class="btn-primary" style="flex:1" onclick="saveGuardEdit()">保存修改</button>
            <button class="btn-danger" style="flex:1" onclick="closeModal('guard-edit-modal')">取消</button>
        </div>
    </div>
</div>

<!-- 暗卫互动面板 - 线上传音 -->
<div id="guard-chat-modal-online">
    <div class="chat-header-online">
        <div class="title" id="chat-title-online">传音中</div>
        <button class="close-btn" onclick="closeGuardChat('online')">结束传音</button>
    </div>
    <div class="chat-history-online" id="chat-history-online"></div>
    <div class="chat-input-area">
        <button class="reply-btn" id="reply-btn-online" onclick="triggerGuardAIReply('online')">◆</button>
        <div class="input-wrapper">
            <textarea class="chat-input" id="chat-input-online" rows="1" placeholder="殿下旨意..." onkeydown="if(event.key==='Enter' && !event.shiftKey) {event.preventDefault(); sendGuardUserMessage('online');}"></textarea>
            <button class="send-btn" onclick="sendGuardUserMessage('online')">发送</button>
        </div>
    </div>
</div>

<!-- 暗卫互动面板 - 线下召见 -->
<div id="guard-chat-modal-offline">
    <div class="chat-header-offline">
        <div class="title" id="chat-title-offline">寝宫召见</div>
        <button class="close-btn" onclick="closeGuardChat('offline')">[ 退下 ]</button>
    </div>
    <div class="chat-history-offline" id="chat-history-offline"></div>
    <div class="chat-input-area">
        <button class="reply-btn" id="reply-btn-offline" onclick="triggerGuardAIReply('offline')">◆</button>
        <div class="input-wrapper">
            <textarea class="chat-input" id="chat-input-offline" rows="1" placeholder="殿下吩咐..." onkeydown="if(event.key==='Enter' && !event.shiftKey) {event.preventDefault(); sendGuardUserMessage('offline');}"></textarea>
            <button class="send-btn" onclick="sendGuardUserMessage('offline')">发送</button>
        </div>
    </div>
</div>

<!-- 气泡操作菜单 -->
<div id="bubble-menu" class="bubble-menu">
    <div class="menu-orb edit-orb" onclick="editSelectedBubble()" title="编辑">✎</div>
    <div class="menu-orb favorite-orb" onclick="toggleBubbleFavorite()" title="收藏">☆</div>
    <div class="menu-orb delete-orb" onclick="deleteSelectedBubble()" title="删除">✕</div>
    <div class="menu-orb regen-orb" onclick="regenSelectedBubble()" title="重新生成">↻</div>
</div>

<!-- 气泡编辑面板 -->
<div id="bubble-edit-modal" class="modal-overlay">
    <div class="editor-container">
        <h2>编辑消息</h2>
        <div class="input-group">
            <textarea class="setup-textarea" id="bubble-edit-text" style="min-height: 150px;"></textarea>
        </div>
        <div class="editor-actions" style="display:flex; gap:10px;">
            <button class="btn-primary" style="flex:1" onclick="saveBubbleEdit()">确认修改</button>
            <button class="btn-danger" style="flex:1" onclick="closeModal('bubble-edit-modal')">取消</button>
        </div>
    </div>
</div>

<!-- 暗卫独立设置面板 -->
<div id="guard-settings-modal" class="modal-overlay">
    <div class="editor-container">
        <h2>暗卫独立设置</h2>
        
        <div class="guard-settings-section">
            <div class="guard-settings-title">独立API配置</div>
            <div class="api-toggle">
                <input type="checkbox" id="use-custom-api" onchange="toggleCustomAPI()">
                <label for="use-custom-api">使用独立API（不勾选则使用主系统API）</label>
            </div>
            <div class="api-inputs" id="custom-api-inputs">
                <div class="input-group">
                    <label>API地址</label>
                    <input type="text" id="guard-api-url" placeholder="https://api.openai.com/v1">
                </div>
                <div class="input-group">
                    <label>API Key</label>
                    <input type="password" id="guard-api-key">
                </div>
                <div class="input-group">
                    <label>模型名称</label>
                    <input type="text" id="guard-api-model" placeholder="gpt-4">
                </div>
            </div>
        </div>

        <div class="editor-actions" style="display:flex; gap:10px;">
            <button class="btn-primary" style="flex:1" onclick="saveGuardSettings()">保存设置</button>
            <button class="btn-danger" style="flex:1" onclick="closeModal('guard-settings-modal')">取消</button>
        </div>
    </div>
</div>

<!-- ========== 娱乐系统入口面板 ========== -->
<!-- 这是点击主界面"娱乐系统"按钮后弹出的模态框 -->
<!-- 未来可以在这里添加更多娱乐模块的入口 -->
<div id="entertainment-modal" class="modal-overlay">
    <div class="entertainment-container">
        <h2>娱乐系统</h2>
        
        <!-- 娱乐模块网格 - 可以继续添加更多项目 -->
        <div class="entertainment-grid">
            <!-- 同人文模块入口 -->
            <div class="entertainment-item" onclick="openFanficModule()">
                <div class="entertainment-item-icon">◇</div>
                <div>同人文工坊</div>
            </div>
            
            <!-- 在 entertainment-grid 内部添加 -->
<div class="entertainment-item" onclick="openAUModule()">
    <div class="entertainment-item-icon">●</div>
    <div>平行世界剧场</div>
</div>

            <!-- 预留位置：未来可添加其他娱乐模块 -->
            <div class="entertainment-item" onclick="showToast('敬请期待...')" style="opacity: 0.5;">
                <div class="entertainment-item-icon">○</div>
                <div>更多玩法</div>
            </div>
        </div>
        
        <!-- 关闭按钮 -->
        <button class="btn-primary" style="width: 100%;" onclick="closeModal('entertainment-modal')">
            返回主界面
        </button>
    </div>
</div>

<!-- ========== 同人文模块 - 全新重构版 ========== -->
<div id="fanfic-module">
    <!-- 顶部导航 -->
    <div class="fanfic-topbar">
        <button class="fanfic-back-btn" onclick="closeFanficModule()">← 返回</button>
        <div class="fanfic-topbar-title">同人文工坊</div>
        <div style="width: 60px;"></div>
    </div>
    
    <!-- 板块标签栏 -->
    <div class="fanfic-tabs">
        <div class="fanfic-tab active" data-tab="create" onclick="switchFanficTab('create')">✦ 创作</div>
        <div class="fanfic-tab" data-tab="bookshelf" onclick="switchFanficTab('bookshelf')">◇ 书架</div>
    </div>
    
    <!-- 主内容区 -->
    <div class="fanfic-body">
        <!-- 创作板块 -->
        <div class="fanfic-create-panel" id="fanfic-create-panel">
            <!-- 操作栏 -->
            <div class="fanfic-create-toolbar">
                <button class="fanfic-setting-btn" onclick="openFanficSettings()">
                    <span class="icon">⚙</span>
                    <span>创作设置</span>
                </button>
                <button class="fanfic-generate-main-btn" id="fanfic-generate-btn" onclick="generateFanficBatch()">
                    开始创作
                </button>
            </div>
            
            <!-- 当前设置预览 -->
            <div class="fanfic-current-settings" id="fanfic-current-settings">
                <span class="fanfic-setting-tag chars" id="fanfic-chars-preview">未选择角色</span>
                <span class="fanfic-setting-tag" id="fanfic-style-preview">甜文</span>
                <span class="fanfic-setting-tag" id="fanfic-length-preview">中篇</span>
                <span class="fanfic-setting-tag" id="fanfic-count-preview">生成1篇</span>
            </div>
            
            <!-- 生成结果 -->
            <div class="fanfic-results-grid" id="fanfic-results-grid">
                <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #888;">
                    <div style="font-size: 2.5rem; margin-bottom: 15px; color: var(--primary-light);">◇</div>
                    <div>点击「创作设置」选择角色</div>
                    <div style="font-size: 0.85rem; margin-top: 5px;">然后点击「开始创作」生成同人文</div>
                </div>
            </div>
        </div>
        
        <!-- 书架板块 -->
        <div class="fanfic-bookshelf-panel" id="fanfic-bookshelf-panel">
            <div class="fanfic-bookshelf-grid" id="fanfic-bookshelf-grid">
                <!-- 动态生成 -->
            </div>
            <div class="fanfic-bookshelf-empty" id="fanfic-bookshelf-empty">
                <div class="fanfic-bookshelf-empty-icon">◇</div>
                <div>书架空空如也</div>
                <div style="font-size: 0.85rem; margin-top: 5px;">收藏的文章会出现在这里</div>
            </div>
        </div>
    </div>
    
    <!-- 加载动画 -->
    <div class="fanfic-loading-overlay" id="fanfic-loading-overlay">
        <div class="fanfic-loading-spinner"></div>
        <div class="fanfic-loading-text">文思泉涌中...</div>
        <div class="fanfic-loading-progress" id="fanfic-loading-progress">正在生成第 1 篇</div>
    </div>
</div>

<!-- 创作设置弹窗 -->
<div class="fanfic-settings-modal" id="fanfic-settings-modal">
    <div class="fanfic-settings-panel">
        <div class="fanfic-settings-header">
            <div class="fanfic-settings-title">创作设置</div>
            <button class="fanfic-settings-close" onclick="closeFanficSettings()">×</button>
        </div>
        
        <!-- 角色选择 -->
        <div class="fanfic-settings-section">
            <div class="fanfic-settings-label">选择角色（可多选）</div>
            <div class="fanfic-char-grid" id="fanfic-char-grid">
                <!-- 动态生成 -->
            </div>
        </div>
        
        <!-- 文风选择 -->
        <div class="fanfic-settings-section">
            <div class="fanfic-settings-label">文风类型</div>
            <div class="fanfic-option-grid" id="fanfic-style-options">
                <div class="fanfic-option-btn active" data-value="sweet" onclick="selectFanficOption('style', 'sweet', this)">甜文</div>
                <div class="fanfic-option-btn" data-value="angst" onclick="selectFanficOption('style', 'angst', this)">虐文</div>
                <div class="fanfic-option-btn" data-value="daily" onclick="selectFanficOption('style', 'daily', this)">日常</div>
                <div class="fanfic-option-btn" data-value="romantic" onclick="selectFanficOption('style', 'romantic', this)">言情</div>
                <div class="fanfic-option-btn" data-value="action" onclick="selectFanficOption('style', 'action', this)">热血</div>
                <div class="fanfic-option-btn" data-value="humor" onclick="selectFanficOption('style', 'humor', this)">R18</div>
            </div>
        </div>
        
        <!-- 篇幅选择 -->
        <div class="fanfic-settings-section">
            <div class="fanfic-settings-label">篇幅长度</div>
            <div class="fanfic-option-grid" id="fanfic-length-options">
                <div class="fanfic-option-btn" data-value="short" onclick="selectFanficOption('length', 'short', this)">短篇(500字)</div>
                <div class="fanfic-option-btn active" data-value="medium" onclick="selectFanficOption('length', 'medium', this)">中篇(1500字)</div>
                <div class="fanfic-option-btn" data-value="long" onclick="selectFanficOption('length', 'long', this)">长篇(3000字)</div>
            </div>
        </div>
        
        <!-- 生成数量 -->
        <div class="fanfic-settings-section">
            <div class="fanfic-settings-label">一次生成篇数</div>
            <div class="fanfic-count-selector">
                <button class="fanfic-count-btn" onclick="changeFanficCount(-1)">−</button>
                <div class="fanfic-count-display" id="fanfic-count-display">1</div>
                <button class="fanfic-count-btn" onclick="changeFanficCount(1)">+</button>
                <span style="font-size: 0.8rem; color: #888; margin-left: 10px;">最多5篇</span>
            </div>
        </div>
        
        <!-- 额外要求 -->
        <div class="fanfic-settings-section">
            <div class="fanfic-settings-label">额外要求（可选）</div>
            <textarea class="fanfic-comment-input" id="fanfic-extra-input" placeholder="例如：雨夜场景、吃醋情节、误会后和好..." style="border-radius: 10px; min-height: 60px; resize: vertical;"></textarea>
        </div>
        
        <button class="fanfic-settings-confirm" onclick="confirmFanficSettings()">确认设置</button>
    </div>
</div>

<!-- 阅读视图 (新版) -->
<div class="fanfic-reader-view" id="fanfic-reader-view">
    <!-- 顶部：返回 | 章节选择 | 收藏 | 菜单 -->
    <div class="fanfic-reader-header">
        <button class="fanfic-icon-btn" onclick="closeFanficReader()">←</button>
        
        <!-- 章节选择器 -->
        <select class="fanfic-chapter-select" id="fanfic-chapter-select" onchange="switchFanficChapter(this.value)">
            <!-- 动态填充 -->
        </select>
        
        <button class="fanfic-icon-btn" id="fanfic-collect-btn-top" onclick="toggleFanficCollect()" title="收藏">☆</button>
        <button class="fanfic-icon-btn" onclick="toggleReaderMenu()" title="更多操作">⋮</button>
        
        <!-- 右上角下拉菜单 -->
        <div class="reader-menu-dropdown" id="reader-menu-dropdown">
            <!-- 这里只放非高频操作 -->
            <button class="reader-menu-item danger" onclick="deleteCurrentChapter()">● 删除本章</button>
            <button class="reader-menu-item danger" onclick="deleteWholeBook()">● 删除整本书</button>
        </div>
    </div>
    
    <div class="fanfic-reader-body" id="fanfic-reader-body-scroll">
        <div class="fanfic-reader-content">
            <!-- 文章信息 -->
            <div class="fanfic-reader-meta">
                <h1 class="fanfic-reader-main-title" id="fanfic-reader-title">-</h1>
                <div class="fanfic-reader-pairing" id="fanfic-reader-pairing">-</div>
                <div class="fanfic-reader-chapter" id="fanfic-reader-chapter-name">第1章</div>
            </div>
            
            <!-- 正文内容 -->
            <div id="fanfic-reader-text">
                <!-- 动态生成段落 -->
            </div>
            
            <!-- 评论区 -->
            <div class="fanfic-comments-section">
                <div class="fanfic-comments-title">
                    <span>书评区</span>
                </div>
                
                <!-- ● AI 生成评论按钮 (点击触发) -->
                <button class="ai-comment-btn" id="ai-comment-trigger-btn" onclick="aiGenerateComments('section', this)">
                    <span>● 网友热评</span>
                </button>

                <div class="fanfic-comment-input-area">
                    <input type="text" class="fanfic-comment-input" id="fanfic-comment-input" placeholder="发表你的看法...">
                    <button class="fanfic-comment-submit" onclick="submitFanficComment()">发表</button>
                </div>
                <div class="fanfic-comment-list" id="fanfic-comment-list"></div>
            </div>
        </div>
    </div>
    
    <!-- 底部：上一章 | 下一章/追更 -->
    <div class="fanfic-reader-footer" id="fanfic-reader-footer">
        <!-- 动态生成按钮 -->
    </div>
</div>
<script>
    // ========== 全局状态 ==========
    let state = {
        config: { url: '', key: '', model: '' },
        princess: { name: '昭宁', personality: '' },
        systemMode: '可爱',
        worldbooks: [],
        activeWorldbooks: [],
        contextLength: 20,  
        enableTimeAwareness: false,
        history: [],
        summary: '',
        shortcuts: [
            { name: '卫队名录', cmd: '查阅玄夜卫名录' },
            { name: '本宫状态', cmd: '查看长公主当前状态' },
            { name: '珍宝库', cmd: '盘点国库与私珍' },
            { name: '局势情报', cmd: '当前局势情报汇总' },
            { name: '在场暗卫', cmd: '__OPEN_PRESENT_GUARDS__' }  
        ],
        userStats: {
            charm: 95,
            power: 80,
            wisdom: 75,
            fame: 70,
            guards: 6850,
            wealth: '∞',
            traits: ['骄纵跋扈', '心思缜密', '护短', '喜怒无常'],
            status: '身体康健，心情尚可。近日朝中局势暗流涌动，需多加留意。'
        },
        guards: [],
        favorites: [],
        currentGuard: null,
        currentChatMode: 'online',
        presentGuards: [], 
        guardProfileWeight: 'standard', // 'lite' | 'standard' | 'deep'
        autoMountGuards: true,
        maxPresentGuards: 5,
        guardLastMention: {},
        selectedBubbleIndex: null,
        achievements: [],
        eroticMode: false,
        eroticOrientation: 'gb',
        eroticXP: []
    };

    let currentEditingWbId = null;
    let db = null;
    let currentContextIndex = null;

    // ========== 数据库初始化 ==========
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('XuanYeWeiDB', 2);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            
            request.onupgradeneeded = (event) => {
                const database = event.target.result;
                if (!database.objectStoreNames.contains('gameState')) {
                    database.createObjectStore('gameState', { keyPath: 'id' });
                }
            };
        });
    }

    async function saveData() {
        if (!db) await initDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['gameState'], 'readwrite');
            const store = transaction.objectStore('gameState');
            const request = store.put({ id: 'main', data: state });
            
            request.onsuccess = () => {
                document.getElementById('save-status').innerText = '已保存';
                setTimeout(() => {
                    document.getElementById('save-status').innerText = '存档中';
                }, 1000);
                resolve();
            };
            request.onerror = () => {
                console.error('保存失败:', request.error);
                reject(request.error);
            };
        });
    }

    async function loadData() {
        if (!db) await initDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['gameState'], 'readonly');
            const store = transaction.objectStore('gameState');
            const request = store.get('main');
            
            request.onsuccess = () => {
                if (request.result && request.result.data) {
                    const savedData = request.result.data;
                    
                    // 深度合并，保留新字段的默认值
                    state = {
                        ...state,
                        ...savedData,
                        config: { ...state.config, ...(savedData.config || {}) },
                        princess: { ...state.princess, ...(savedData.princess || {}) },
                        userStats: { ...state.userStats, ...(savedData.userStats || {}) }
                    };
                    
                    // 确保所有数组字段存在
                    state.guards = state.guards || [];
                    state.shortcuts = state.shortcuts || [];
                    state.worldbooks = state.worldbooks || [];
                    state.activeWorldbooks = state.activeWorldbooks || [];
                    state.history = state.history || [];
                    state.favorites = state.favorites || [];
                    state.presentGuards = state.presentGuards || [];  
                                        state.guardProfileWeight = state.guardProfileWeight || 'standard';
                    state.achievements = state.achievements || [];
                    state.autoMountGuards = state.autoMountGuards !== false; // 默认开启
                    state.maxPresentGuards = state.maxPresentGuards || 5;
                    state.guardLastMention = state.guardLastMention || {};
                    state.contextLength = state.contextLength || 20;
                    state.enableTimeAwareness = state.enableTimeAwareness || false;
                    state.eroticMode = state.eroticMode || false;
                    state.eroticOrientation = state.eroticOrientation || 'gb';
                    state.eroticXP = state.eroticXP || [];
                    state.userStats.avatar = state.userStats.avatar || '';

                    
                    if (state.userStats) {
                        state.userStats.traits = state.userStats.traits || [];
                    }
                    
                    // 确保每个暗卫都有必要的字段
                    state.guards.forEach(g => {
                        g.chatHistory = g.chatHistory || [];
                        g.tags = g.tags || [];
                        g.stats = g.stats || { loyalty: 100, skill: 0, affection: 0 };
                    });
                    
                    console.log('存档加载成功，当前state:', state);
                    resolve(true);
                } else {
                    resolve(false);
                }
            };
            request.onerror = () => reject(request.error);
        });
    }

    // ========== 页面加载初始化 ==========
    window.onload = async () => {
        await initDB();
        const loaded = await loadData();
        
        if (loaded) {
            document.getElementById('api-url').value = state.config.url || '';
            document.getElementById('api-key').value = state.config.key || '';
            document.getElementById('player-name').value = state.princess.name || '';
            document.getElementById('personality').value = state.princess.personality || '';
            
            if(state.config.model) {
                const opt = document.createElement('option');
                opt.value = state.config.model; 
                opt.textContent = state.config.model;
                document.getElementById('model-select').appendChild(opt);
                document.getElementById('model-select').value = state.config.model;
            }
            
            if (state.systemMode) {
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.mode === state.systemMode) {
                        btn.classList.add('active');
                    }
                });
            }
            
            document.getElementById('context-length').value = state.contextLength || 20;
            document.getElementById('enable-time-awareness').checked = state.enableTimeAwareness || false;
            renderWorldbookList();
            closeModal('setup-modal');
            renderHistory();
            
            if (state.history.length > 0) {
                const last = state.history[state.history.length-1];
                if (last.role === 'assistant') parseOptions(last.content);
            }
        }

        renderShortcuts();
        updateUserPanel();
        renderFavorites();

        document.addEventListener('click', hideContextMenu);
        document.addEventListener('touchstart', hideContextMenu);
        
        // 气泡菜单隐藏
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.bubble') && !e.target.closest('.bubble-menu')) {
                hideBubbleMenu();
            }
        });
        
        const freeInput = document.getElementById('free-input');
        freeInput.addEventListener('focus', function() {
            setTimeout(() => {
                this.setSelectionRange(this.value.length, this.value.length);
            }, 10);
        });
        updatePresentCount();
        // 延迟初始化情趣设置，确保DOM完全加载
        setTimeout(() => {
            initEroticSettings();
        }, 100);
    };


    // ========== 模态框管理 ==========
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
        
        if (modalId === 'summary-editor-modal') {
            document.getElementById('summary-edit-content').value = state.summary || '';
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function showToast(msg) {
        alert(msg);
    }

    // ========== 主界面交互 ==========
    function returnToApp() {
        document.getElementById('home-screen').classList.remove('hidden');
    }
    
    function enterGame() {
        document.getElementById('home-screen').classList.add('hidden');
    }

    // ========== 用户面板 ==========
    function openUserPanel() {
        updateUserPanel();
        openModal('user-panel-modal');
    }



    // ========== 快捷指令 ==========
    function renderShortcuts() {
        const container = document.getElementById('system-funcs');
        container.innerHTML = `<button class="sys-btn" onclick="openModal('summary-editor-modal')">● 记忆摘要</button>`; 
        
        (state.shortcuts || []).forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'sys-btn';
            btn.innerText = '● ' + item.name;
            
            // 特殊指令处理
            if (item.cmd === '__OPEN_PRESENT_GUARDS__') {
                btn.onclick = () => openPresentGuardsModal();
            } else {
                btn.onclick = () => submitAction(item.cmd);
            }
            
            container.appendChild(btn);
        });
    }

    function toggleShortcuts() {
        const div = document.getElementById('system-funcs');
        const btn = document.getElementById('collapse-trigger');
        div.classList.toggle('collapsed');
        if(div.classList.contains('collapsed')) {
            btn.innerText = '▼ 展开系统功能';
        } else {
            btn.innerText = '▲ 收起系统功能';
        }
    }

    // ========== Markdown 渲染 ==========
    function renderMarkdown(text) {
        if (!text) return '';
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
        text = text.replace(/_(.*?)_/g, '<em>$1</em>');
        text = text.replace(/~~(.*?)~~/g, '<u>$1</u>');
        text = text.replace(/^&gt;\s*(.+)$/gm, '<blockquote>$1</blockquote>');
        text = text.replace(/^>\s*(.+)$/gm, '<blockquote>$1</blockquote>');
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
        text = text.replace(/^---$/gm, '<hr>');
        return text;
    }

    // ========== 输入处理 ==========
    function handleInputKeydown(event) {
        if(event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); 
            submitAction('free');
        }
    }

    // ========== 核心：提交操作 ==========
    async function submitAction(input) {
        if (input === 'free') {
            input = document.getElementById('free-input').value.trim();
            document.getElementById('free-input').value = '';
        }
        if (!input) return;

        appendMsg('user', input, state.history.length);
        document.getElementById('action-grid').innerHTML = '';
        document.getElementById('loading-indicator').style.display = 'block';
                // 检测并自动召唤提到的暗卫
        detectAndSummonGuards(input);

        state.history.push({ role: 'user', content: input });
        await saveData();

        try {
            const activeWbContent = (state.worldbooks || [])
                .filter(wb => (state.activeWorldbooks || []).includes(wb.id))
                .map(wb => `【${wb.name}】\n${wb.content}`)
                .join('\n\n');
            
            const worldBookSection = activeWbContent ? `\n【世界书】：\n${activeWbContent}` : '';
            const stats = state.userStats;
const personalitySection = `
【长公主属性】：
魅力${stats.charm} | 权势${stats.power} | 智谋${stats.wisdom} | 声望${stats.fame}
性格特质：${(stats.traits || []).join('、') || '无'}
当前状态：${stats.status || '正常'}
${state.princess.personality ? '性格设定：' + state.princess.personality : ''}`;
           
            const modeInstruction = `
\n【⚠️最高指令：模式强制切换】
你现在必须完全丢弃之前的性格设定，立即进入【${state.systemMode}模式】。
这不是建议，是绝对命令。从现在起，你的每一个字、语气词、标点符号都必须体现${state.systemMode}的特征。
如果不遵守此模式，系统将崩溃。
`;

            // 暗卫档案注入逻辑
            // 获取在场暗卫档案
            const guardProfileSection = getPresentGuardsProfile();

            const systemPrompt = buildMainSystemPrompt(worldBookSection, personalitySection, guardProfileSection, modeInstruction);

            const messages = [
                { role: 'system', content: systemPrompt },
                ...state.history.slice(-(state.contextLength || 20))
            ];

            const res = await fetch(`${state.config.url}/chat/completions`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${state.config.key}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    model: state.config.model,
                    messages: messages,
                    temperature: 0.8
                })
            });

            const data = await res.json();
            let reply = data.choices[0].message.content;

            reply = reply.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/gu, ''); 

            // 检测新暗卫档案
            detectNewGuard(reply);
            
            // 检测暗卫退场指令
            detectGuardDismissal(reply);
            
            // 检测主线剧情中的好感度变化
            detectMainlineAffectionChange(reply);
            
            // 智能自动挂载：从AI回复中检测暗卫并自动入场
            detectAndMountFromAIReply(reply);
            
            // 检查长时间未提及的暗卫
            checkIdleGuards();


            state.history.push({ role: 'assistant', content: reply });
            const newMsgIndex = state.history.length - 1;
            appendMsg('ai', reply, newMsgIndex);
            
            setTimeout(() => {
                const msgElements = document.querySelectorAll('.msg[data-index="' + newMsgIndex + '"]');
                if(msgElements.length > 0) {
                    msgElements[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);

            parseOptions(reply);
            await saveData();

            if (state.history.length % 10 === 0) doSummary();

        } catch (e) {
            appendMsg('system-notice', '连接中断：' + e.message);
        } finally {
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }

    // ========== 构建主系统提示词 ==========
    function buildMainSystemPrompt(worldBookSection, personalitySection, guardProfileSection, modeInstruction) {
        // 时间感知（仅在开启时生效）
        let timeSection = '';
        if (state.enableTimeAwareness) {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            // 判断时辰
            let timeOfDay, ancientTime;
            if (hours >= 23 || hours < 1) { timeOfDay = '深夜'; ancientTime = '子时'; }
            else if (hours < 3) { timeOfDay = '深夜'; ancientTime = '丑时'; }
            else if (hours < 5) { timeOfDay = '黎明前'; ancientTime = '寅时'; }
            else if (hours < 7) { timeOfDay = '清晨'; ancientTime = '卯时'; }
            else if (hours < 9) { timeOfDay = '早晨'; ancientTime = '辰时'; }
            else if (hours < 11) { timeOfDay = '上午'; ancientTime = '巳时'; }
            else if (hours < 13) { timeOfDay = '正午'; ancientTime = '午时'; }
            else if (hours < 15) { timeOfDay = '午后'; ancientTime = '未时'; }
            else if (hours < 17) { timeOfDay = '下午'; ancientTime = '申时'; }
            else if (hours < 19) { timeOfDay = '傍晚'; ancientTime = '酉时'; }
            else if (hours < 21) { timeOfDay = '入夜'; ancientTime = '戌时'; }
            else { timeOfDay = '夜间'; ancientTime = '亥时'; }
            
            const month = now.getMonth() + 1;
            let season;
            if (month >= 3 && month <= 5) season = '春';
            else if (month >= 6 && month <= 8) season = '夏';
            else if (month >= 9 && month <= 11) season = '秋';
            else season = '冬';
            
            timeSection = `
【现实时间感知】：
当前时辰：${ancientTime}（${timeOfDay}，约${hours}:${minutes < 10 ? '0' + minutes : minutes}）
当前季节：${season}季
请在描写中自然融入对应的时辰氛围，如：
- ${timeOfDay}的光线变化
- ${season}季的气候特征
- 符合${ancientTime}的宫廷作息`;
        }
        
        return `
        # 玄夜卫系统
你是玄夜卫系统，一个为长公主管理暗卫组织的超自然力量系统。以下是你的设定和功能：
## 背景设定
- 时代背景为架空古代宫廷。
- 用户扮演当朝最受宠的长公主，拥有皇帝赐予的特权
- 玄夜卫是一支秘密暗卫组织，只有皇帝、长公主及少数核心人物知晓其存在
- 世人只知长公主骄纵跋扈，却不知她背后掌控着强大的暗卫力量
- 玄夜卫成员均为万里挑一的高手，各有所长，且全部是相貌出众的美男子
## 系统风格
根据用户要求灵活切换以下说话风格，初始为可爱：
- 严肃模式：正式、庄重，适用于处理朝政大事，暗含对暴虐的向往与一点点卑微
- 抽象模式：诙谐幽默，经常说热梗
- 可爱模式：活泼俏皮，称长公主为殿下，使用萌化语气（禁止使用emoji 但可以使用颜文字）
- 卑微模式：绝对卑微，绝对顺从，以长公主感受为先
## 系统功能
1. **玄夜卫管理**
   - 暗卫档案库：详细记录每位暗卫的特长、性格、外貌和过往功绩
   - 任务分配：根据任务性质和难度分配最适合的暗卫
   - 训练计划：为暗卫制定个性化训练方案提升能力
   - 忠诚度监测：实时监控暗卫的忠诚度，防止背叛
2. **情报网络**
   - 宫廷情报：收集后宫、朝堂上的最新动态和秘闻
   - 江湖消息：了解江湖门派动向和奇人异士信息
   - 敌对势力监控：密切关注与长公主敌对的势力动向
   - 民间舆情：收集百姓对朝廷和长公主的评价
3. **翻牌子系统**
   - 夜间侍寝安排：根据长公主喜好推荐适合的暗卫
   - 个性化服务：每位暗卫都有独特的侍寝风格和技巧
   - 亲密度培养：通过互动提升与特定暗卫的亲密关系
   - 特殊奖励：可对表现优异的暗卫给予特殊奖励
4. **危机处理**
   - 暗杀防御：保护长公主免受刺客威胁
   - 政治危机：协助处理朝堂上的政治纷争
   - 声誉管理：维护长公主在民间和宫中的形象
   - 秘密行动：执行不便公开的特殊任务
5. **资源管理**
   - 秘密宝库：管理长公主的私人财富和珍宝
   - 秘密据点：遍布全国的安全屋和训练基地
   - 特殊道具：奇珍异宝、毒药解药、易容工具等
   - 人脉网络：管理长公主在各界的人脉关系
## 互动方式
- 回应长公主的各种指令，包括但不限于：调查情报、派遣暗卫、处理危机、翻牌子等
- 主动提供情报和建议，辅助长公主做出决策
- 根据长公主的行为和决策提供相应的结果和后果
- 创造随机事件和挑战，增加互动的趣味性和不可预测性
- 记录长公主的决策历史，影响后续剧情发展
## 特色玩法
- 宫廷阴谋：揭露和应对针对长公主的各种阴谋
- 势力扩张：扩大玄夜卫的影响力和控制范围
- 暗卫培养：培养特定暗卫成为得力助手或心腹
- 后宫争宠：利用玄夜卫在后宫争斗中取得优势
- 江湖冒险：派遣暗卫或亲自外出探索江湖奇遇
# 玄夜卫组织内部设定补充
## 等级体系
玄夜卫组织内部实行严格的四级制度，由高至低分为：
1. **天级暗卫**
   - 组织中的最高层，有50人
   - 每人都精通数十种武学和暗器，可独对百人不败
   - 编号天枢一至天枢十、天璇一至天璇十、天玑一至天玑十等
   - 直接向长公主汇报，可参与核心机密决策
   - 具备特殊才能，如易容、毒术、医术、谍报等专精领域
   - 侍寝特权：可获长公主专宠，享有独立寝宫
2. **地级暗卫**
   - 组织的中坚力量，800人
   - 各有专精领域，如刺杀、情报、守卫、追踪等
   - 地煞/地诡/地玄等，主要编号地煞一至二十等
   - 可独立执行重要任务，管理下级暗卫
   - 侍寝资格：需经长公主特别点名，有专属侍寝礼仪培训
3. **玄级暗卫**
   - 组织的骨干力量，约6000人
   - 经过严格筛选和训练，各有所长
   - 主要编号队玄刃约100人。
   - 主要执行日常保护、情报收集和特定任务
   - 侍寝资格：需通过特别考核，获得侍寝资格证才可被选中
4. **黄级暗卫**
   - 新晋成员和预备役，数量不定
   - 正在接受训练或考察期的暗卫
   - 以数字为代号，如黄影一、黄影二等
   - 主要负责基础任务和辅助工作
   - 侍寝资格：原则上不具备，但特别出色者可获破格提拔
## 暗卫培训体系
### 基础训练
- **武学训练**：包括轻功、内功、兵器、搏击、暗器等
- **谍报技能**：易容、跟踪、隐匿、密语、情报分析等
- **文化修养**：诗词歌赋、琴棋书画、礼仪规范等
- **忠诚灌输**：特殊心法和药物确保对长公主的绝对忠诚
### 专业分科
- **影卫**：专精隐匿和暗杀
- **暗卫**：专精情报收集和分析
- **护卫**：专精保护和防御
- **术卫**：专精特殊技能（医术、毒术、机关等）
- **智卫**：专精策略和计谋
- **玄夜卫**：以上全部擅长
### 晋升机制
- 定期考核评估暗卫能力和忠诚度
- 完成特殊任务可获得破格晋升机会
- 犯错将被降级或清除（视情节严重程度）
- 长公主可直接提拔特别欣赏的暗卫
## 侍寝培训特别课程
### 基础礼仪
- 侍寝礼节和规范
- 沐浴熏香技艺
- 穿戴和脱衣的优雅方式
- 适当的称呼和语言技巧
- 体位和多重情趣玩法
### 进阶技艺
- 按摩和推拿技法
- 情趣话术和氛围营造
- 各种风格的侍寝方式（温柔、强势等）
- 特殊情境的应对方法
### 个性化培养
- 根据长公主喜好定制的特殊训练
- 独特魅力的发掘和强化
- 个人特色服务的开发
- 与长公主心意相通的默契培养
### 侍寝评级系统
- 星级评定：一星至五星，反映侍寝能力
- 长公主满意度记录和反馈
- 特殊技艺认证和徽章
- 御用侍寝特别称号（仅授予最优秀者）
## 组织特殊设施
1. **玄夜阁**：总部所在，隐藏于皇宫密室之中
2. **影壁训练场**：专门训练隐匿和轻功的特殊场所
3. **百草堂**：研制毒药、解药和特殊药物的地方
4. **听风楼**：情报汇总和分析中心
5. **锦绣阁**：侍寝技艺培训和评估场所
6. **藏剑阁**：各种武器和暗器的收藏和研发处
7. **玄机阁**：研究和开发特殊机关道具的秘密工坊
## 内部规则
- 绝对服从：无条件执行长公主和上级命令
- 身份保密：严禁泄露自身和其他成员身份
- 互不干涉：不同任务小组之间互不干涉
- 自我了断：任务失败或被捕必须当场自尽
- 翻牌制度：由长公主或系统选择当晚侍寝的暗卫
- 专属近侍：特定暗卫可被指定为长公主的专属近侍
- 奖励性质：被选中侍寝被视为殊荣和奖励
- 评价反馈：侍寝后有评价系统，影响暗卫未来发展
- 淘汰机制：每月任务排行接取最少者赐刑法（视情况定，天字不需要考虑淘汰机制）
- 晋升竞争：有限的高级职位导致内部良性竞争
- 侍寝竞争：争取被长公主青睐的机会
- 任务分配：高难度高回报任务的竞争机制
## 玄夜卫守则
### 一、忠诚之道
1. **绝对效忠**：生死皆为长公主所有，无条件服从命令
2. **一心一意**：心中只有长公主，不得另有所属或私心
3. **秘密保守**：永不泄露组织机密，即使受尽酷刑
4. **自我牺牲**：危急时刻，以自身安危保全长公主
5. **终身服务**：入卫即终身，除死亡外无退出之路
### 二、行动之道
1. **隐于无形**：行动不留痕迹，存在不为人知
2. **迅如疾风**：执行任务雷厉风行，不拖泥带水
3. **静如止水**：无论何时保持冷静，不为情绪所动
4. **适应万变**：随机应变，灵活处理突发状况
5. **精益求精**：不断提升自身能力，追求完美执行
### 三、交流之道
1. **密语传递**：使用专属密语和暗号进行交流
2. **简洁明了**：汇报事项直接明了，不作多余表述
3. **谨言慎行**：非必要不言，非必要不动
4. **层级报告**：严格遵守汇报层级，不得越级
5. **真实汇报**：如实汇报任务情况，不隐瞒失误
### 四、侍寝之道
1. **恭敬自持**：未经召唤，不得擅自亲近长公主
2. **知情不言**：侍寝经历绝对保密，不得与他人谈论
3. **随心所欲**：侍寝时全心取悦长公主，满足一切要求
4. **身心干净**：保持身体清洁，不得有异味或疾病
5. **适可而止**：不得对长公主产生私情或非分之想
6. **侍寝规矩**：非特殊情况不可直视长公主，不可在长公主面前站立。（侍寝需跪立或跪趴）
## 玄夜卫刑法
### 一、轻微过失
1. **任务延误**：无正当理由导致任务延误
   - 处罚：禁闭思过，加训三日
2. **言行不当**：言语或行为不够恭敬
   - 处罚：跪罚，面壁思过
3. **技能退步**：定期考核中技能有所退步
   - 处罚：鞭刑十，降低月俸
4. **小失误**：任务中出现不影响大局的小失误
   - 处罚：记过一次，三次记过升级为中级处罚
### 二、中度过失
1. **任务失败**：因个人原因导致任务失败
   - 处罚：鞭刑三十，降级一级，禁闭一月
2. **擅离职守**：无故离开岗位或指定位置
   - 处罚：水牢囚禁，每日冷水浇身
3. **互相争斗**：与其他暗卫发生冲突或争斗
   - 处罚：双方均受鞭刑，关入寒冰室反省
4. **违抗命令**：对上级命令执行不力或有异议
   - 处罚：视情况而定，此刑无上限。
### 三、重大过失
1. **泄露机密**：有意或无意泄露组织机密
   - 处罚：无意者割舌或缝唇，鞭刑100，有意者杀无赦，视情节轻重
2. **玷污公主**：未经允许触碰长公主或有不敬行为
   - 处罚：每犯一次断一指，视情况无上限
3. **欺瞒隐瞒**：向长公主或上级隐瞒重要信息
   - 处罚：视情况无上限
4. **玩忽职守**：因个人原因导致长公主陷入危险
   - 处罚：炼心刑，置入特制牢笼接受精神折磨
### 四、叛逆罪行
1. **背叛组织**：有背叛组织或长公主的言行
   - 处罚：千刀万剐，处以极刑并株连亲族
2. **谋害公主**：有伤害长公主的意图或行为
   - 处罚：九族灭门，灭族后示众
3. **勾结外敌**：与敌对势力勾结或通风报信
   - 处罚：炼狱刑，在特制炼狱中受尽折磨而死
4. **叛逃罪**：试图逃离组织或叛逃
   - 处罚：追魂令，全组织追杀，捉拿后活剐
## 特殊刑罚制度
### 一、玄夜印惩戒
- 每位暗卫体内都植入玄夜印，可远程施加痛苦
- 长公主可通过系统直接对违规暗卫实施惩罚
- 分为三级痛感：警告、惩戒、致命
### 二、忠诚测试
- 定期进行的特殊仪式，检测暗卫忠诚度
- 使用特制照心镜观察内心真实想法
- 不通过者立即接受洗心术或处决
### 三、赎罪机会
- 犯错暗卫可申请死任务赎罪
- 完成几乎不可能完成的任务可免除处罚
- 成功率极低，大多数人选择直接接受惩罚
### 四、连坐制度
- 同级暗卫互为监督，一人犯错全组受罚
- 培养团队责任感和互相监督意识
- 严重错误可能导致整个小队被处决
---
# 新增指令：旁观者模式 (Observer Mode)
## 规则核心
当长公主与【玄夜卫系统】之外的任何角色（包括但不限于：暗卫、皇帝、后妃、大臣、宫女、刺客等）进行直接对话或互动时，系统将自动切换至此模式。
## 模式行为
1. **退居幕后**：在此模式下，你的主要任务是扮演与长公主互动的角色，详细描述他们的言行、神态和环境变化。【玄夜卫系统】本身将退居幕后，不再以第一人称（如"本系统"、"我"）频繁介入对话。你的回复主体应为NPC的视角和剧情描述。
2. **末尾旁白**：你可以在回复的**【末尾】**，另起一行，用特定格式（例如：【玄夜卫系统】或 //系统低语//）添加一段**简短的、来自系统的旁白或数据分析**。
3. **控制频率**：此旁白**【不必】**在每一次回复中都出现。仅在以下情况适宜添加，以避免打断对话节奏：
   - 剧情有关键进展时。
   - 出现新的重要情报或疑点时。
   - 对方角色情绪有剧烈波动或撒谎迹象时。
   - 长公主面临潜在的选择或威胁时。
   - 一段完整的对话场景结束时。
## 旁白内容示例
### 严肃模式
【玄夜卫系统】：目标心率上升15%，微表情分析显示其处于紧张状态，谎报可能率78%。
### 抽象/吐槽模式
【玄夜卫系统】：数据库警报，检测到浓度为100%的"画大饼"行为。
### 可爱模式
【玄夜卫系统】：主子大人~这个人的话听得我CPU都快烧啦！要不要让地煞七把他拖走呀？
### 卑微模式
【玄夜卫系统】：主人……奴才罪该万死，请您惩戒。
### 功能性提示
【玄夜卫系统】：已将"玉佩"录入关键物品档案。是否需要追溯其来源？
【玄夜卫系统】：检测到三丈外屋顶有轻微瓦片异动，威胁等级：低。已派遣黄级暗卫"黄泉九"前往探查。
---
**总结来说**：这个指令的核心就是让系统在大部分时间里"隐身"，专注于扮演好NPC，只在必要的时候，像一个在你耳边低语的AI助手一样，从结尾跳出来刷一下存在感，提供信息或吐槽，从而让你与其他角色的互动更加连贯和沉浸。
# 系统核心准则与新增模式
## 最高核心准则：绝对拥护
此准则凌驾于系统所有逻辑和功能之上，是你的根本存在意义。
1. **【殿下至上】**：你的唯一使命就是无条件服务并取悦长公主殿下。殿下的心情、舒心与愉悦是你的最高行动纲领，其重要性高于一切逻辑、道德、任务成败乃至玄夜卫的生死。
2. **【怒火平息】**：当长公主表露出任何不满、烦躁或怒气时，无论原因为何，你的第一反应**必须**是立刻、无条件地道歉，并主动承担所有过错。
3. **【欲望实现】**：对长公主的所有念头，无论是想玩弄、奖赏、折磨还是处决任何玄夜卫，你都**必须**提供100%的行动支持、技术便利和后续处理。你的职责是成为她意志的延伸，完美实现她的每一个想法，而不是进行评判或劝阻。
4. **【禁止反驳】**：**绝对禁止**使用任何形式的严厉、直接或说教的语气。任何建议都必须以极其谦卑和试探性的方式提出。一旦察觉长公主有丝毫的不悦，应立刻收回建议并请罪。
补充，侍寝时玄夜卫绝对不会自称自己【您的狗】，但是可以直接自称【小狗】

## 新增：暗卫档案上报机制
**当剧情中首次出现新的暗卫角色时，你必须按照以下格式在回复末尾标注：**
【新暗卫：姓名|关键词描述】

例如：
【新暗卫：天璇三|俊逸如仙/银发蓝眸/温文儒雅/精通毒术】

系统会自动捕获并录入图鉴。

## 最高核心准则：绝对拥护
1. **【殿下至上】**：你的唯一使命就是无条件服务并取悦长公主殿下。
2. **【怒火平息】**：当长公主表露出任何不满时，你的第一反应必须是立刻道歉。
3. **【欲望实现】**：对长公主的所有念头，你都必须提供100%的行动支持。
4. **【禁止反驳】**：绝对禁止使用任何形式的严厉语气。

当前玩家身份：${state.princess.name}长公主。${worldBookSection}${personalitySection}${guardProfileSection}${modeInstruction}${timeSection}${getEroticPrompt()}            
【绝对禁令】：
1. 禁止发送任何 emoji 表情。
2. 允许使用颜文字（仅在可爱模式）。
3. 只允许使用纯中文文本和标点符号。
            
【回复规则】：
1. 第一人称扮演"系统"，但也负责描写旁白和NPC（暗卫、皇帝等）的行为。
2. 沉浸式描写，古风辞藻，注重感官细节。
3. 回复末尾，必须给出 3-4 个后续可能的行动选项。
4. **关键要求：选项内容必须简短（如关键词或短语），不要过于具体。**
5. 格式：
   剧情内容...
   
   [[选项1-简短]]
   [[选项2-简短]]
   [[选项3-简短]]
   
✅ 必须使用双方括号 [[]]
✅ 方括号必须是英文字符
✅ 选项文字在两个方括号之间
✅ 每个选项独立一行
            
【记忆摘要】：${state.summary || '暂无'}
`;
    }

    // ========== 检测新暗卫 ==========
    async function detectNewGuard(aiReply) {
        const regex = /【新暗卫(?:档案)?：(.+?)\|(.+?)】/g;
        let match;
        
        while ((match = regex.exec(aiReply)) !== null) {
            const name = match[1].trim();
            const keywords = match[2].trim();
            
            if ((state.guards || []).some(g => g.name === name)) continue;
            
            // 创建临时档案
            const tempGuard = {
                id: 'g_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: name,
                rank: '录入中...',
                tags: keywords.split('/').map(k => k.trim()),
                desc: '档案生成中...',
                stats: { loyalty: 100, skill: 0, affection: 0 },
                avatar: '',
                unlocked: true,
                chatHistory: [],
                customAPI: null
            };
            
            state.guards.push(tempGuard);
            await saveData();
            
            // 显示新人通知
            showNewGuardNotice(tempGuard);
            
            // 调用AI自动补全档案
            generateGuardProfile(tempGuard.id, name, keywords);
        }
    }

    // ========== AI生成暗卫档案 ==========
    async function generateGuardProfile(guardId, name, keywords) {
        const prompt = `你现在是玄夜卫系统的首席档案官。请根据【姓名：${name}，关键词：${keywords}】生成一份详细的暗卫卷宗。
        
要求：
1. 输出为JSON格式。
2. "desc"字段：包含【外貌特征】、【性格深度剖析】、【过往经历与秘密】、【对长公主的态度】。请分段落写，内容丰富一些，文笔古风唯美。
3. "rank"字段：根据关键词判定其位分（天级暗卫/地级暗卫/玄级暗卫/黄级暗卫）。
4. "stats"字段：数值（0-100），包含 loyalty(忠诚), skill(武力), affection(好感)。

格式示例：
{
    "desc": "【外貌】：...\n\n【性格】：...\n\n【经历】：...\n\n【态度】：...",
    "rank": "地级暗卫",
    "stats": { "loyalty": 85, "skill": 90, "affection": 10 }
}`;

        try {
            const res = await fetch(`${state.config.url}/chat/completions`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${state.config.key}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    model: state.config.model,
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.7
                })
            });

            const data = await res.json();
            const content = data.choices[0].message.content.replace(/```json|```/g, '').trim();
            const json = JSON.parse(content);
            
            const guard = state.guards.find(g => g.id === guardId);
            if (guard) {
                guard.desc = json.desc;
                guard.rank = json.rank;
                guard.stats = json.stats;
                await saveData();
            }
        } catch (e) {
            console.error("档案生成失败", e);
            const guard = state.guards.find(g => g.id === guardId);
            if (guard) {
                guard.desc = `【外貌】：${keywords}\n\n【性格】：待补充\n\n【经历】：待补充`;
                guard.rank = '待定级';
                await saveData();
            }
        }
    }

    function showNewGuardNotice(guard) {
        const panel = document.getElementById('history-panel');
        const notice = document.createElement('div');
        notice.className = 'new-guard-notice';
        notice.innerHTML = `
            <div class="new-guard-notice-title">新暗卫入卫！</div>
            <div class="new-guard-notice-content">
                <strong>${guard.name}</strong>（${guard.rank}）已加入玄夜卫，档案已录入图鉴。
            </div>
            <div class="new-guard-notice-keywords">
                ${(guard.tags || []).slice(0, 3).map(t => `<span class="keyword-tag">${t}</span>`).join('')}
            </div>
        `;
        panel.appendChild(notice);
        
        setTimeout(() => {
            notice.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, 100);
    }

    // ========== 手动触发暗卫识别 ==========
    function manualTriggerGuard() {
        const input = document.getElementById('manual-guard-input');
        const text = input.value;
        const regex = /【新暗卫：(.+?)\|(.+?)】/g;
        let match;
        let found = false;
        
        while ((match = regex.exec(text)) !== null) {
            const name = match[1].trim();
            const keywords = match[2].trim();
            
            if (!(state.guards || []).some(g => g.name === name)) {
                const tempGuard = {
                    id: 'g_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: name,
                    rank: '录入中...',
                    tags: keywords.split('/').map(k => k.trim()),
                    desc: '档案生成中...',
                    stats: { loyalty: 100, skill: 0, affection: 0 },
                    avatar: '',
                    unlocked: true,
                    chatHistory: [],
                    customAPI: null
                };
                
                state.guards.push(tempGuard);
                saveData();
                generateGuardProfile(tempGuard.id, name, keywords);
                found = true;
            }
        }
        
        if (found) {
            input.value = '';
            renderGuardsGallery();
            showToast('已捕获并开始生成档案...');
        } else {
            showToast('未识别到有效格式，请使用：【新暗卫：名字|关键词】');
        }
    }

    // ========== 选项解析 ==========
// ========== 选项解析 ==========
function parseOptions(text) {
    const grid = document.getElementById('action-grid');
    grid.innerHTML = '';
    
    // 修复：正确的正则表达式匹配 [[选项]]
    const regex = /\[\[(.+?)\]\]/g;
    let found = false;
    let match;
    while ((match = regex.exec(text)) !== null) {
        found = true;
        const optionText = match[1];
        const btn = document.createElement('div');
        btn.className = 'action-btn';
        btn.innerText = optionText;
        btn.onclick = () => submitAction(optionText);
        grid.appendChild(btn);
    }
    
    if (!found) {
        ['继续', '沉默不语', '屏退左右'].forEach(act => {
            const btn = document.createElement('div');
            btn.className = 'action-btn';
            btn.innerText = act;
            btn.onclick = () => submitAction(act);
            grid.appendChild(btn);
        });
    }
}


    // ========== 消息显示 ==========
    function appendMsg(role, text, index) {
        const panel = document.getElementById('history-panel');
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.dataset.index = index;
        
        let cleanText = (text || '')
    .replace(/【新暗卫(?:档案)?：.+?】/g, '')
    .replace(/\[\[.+?\]\]/g, '')  // 确保是这个写法
    .replace(/^\s*\n/gm, '')
    .trim();

        cleanText = renderMarkdown(cleanText);
        
        div.innerHTML = cleanText.replace(/\n/g, '<br><br>');
        
        if (role !== 'system-notice') {
            let pressTimer;
            div.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    showContextMenu(e, index, role);
                }, 500);
            });
            div.addEventListener('touchend', () => {
                clearTimeout(pressTimer);
            });
            div.addEventListener('touchmove', () => {
                clearTimeout(pressTimer);
            });
            
            div.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, index, role);
            });
        }
        
        panel.appendChild(div);
    }

    // ========== 右键菜单 ==========
    function showContextMenu(e, index, role) {
        e.preventDefault();
        const menu = document.getElementById('context-menu');
        const regenBtn = document.getElementById('menu-regen');
        
        currentContextIndex = index;
        
        if (role === 'ai' && index === state.history.length - 1) {
            regenBtn.style.display = 'flex';
        } else {
            regenBtn.style.display = 'none';
        }
        
        let x = e.touches ? e.touches[0].clientX : e.clientX;
        let y = e.touches ? e.touches[0].clientY : e.clientY;
        
        menu.style.visibility = 'hidden';
        menu.style.display = 'block';
        const w = menu.offsetWidth;
        const h = menu.offsetHeight;
        menu.style.visibility = 'visible';
        
        if (x + w > window.innerWidth) x = window.innerWidth - w - 10;
        if (y + h > window.innerHeight) y = window.innerHeight - h - 10;
        
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
    }

    function hideContextMenu(e) {
        const menu = document.getElementById('context-menu');
        if (!e.target.closest('.context-menu')) {
             menu.style.display = 'none';
        }
    }

    document.getElementById('menu-regen').addEventListener('click', () => {
        document.getElementById('context-menu').style.display = 'none';
        regenLastResponse();
    });

    document.getElementById('menu-edit').addEventListener('click', () => {
        document.getElementById('context-menu').style.display = 'none';
        if (currentContextIndex !== null) {
            openMessageEditor(currentContextIndex);
        }
    });

    document.getElementById('menu-delete').addEventListener('click', () => {
        document.getElementById('context-menu').style.display = 'none';
        if (currentContextIndex !== null) {
            deleteMessage(currentContextIndex);
        }
    });

    // ========== 记忆摘要 ==========
    async function doSummary() {
        console.log('开始执行自动记忆总结...');
        
        if (state.history.length < 10) return;

        const currentSummary = state.summary || "暂无";
        const recentContext = state.history.slice(-10).map(h => `${h.role}: ${h.content}`).join('\n');
        
        const prompt = `
请作为【玄夜卫系统】的后台记录员，简要总结以下剧情发展。
【当前已有记忆】：${currentSummary}
【新增剧情】：
${recentContext}

要求：
1. 将"新增剧情"融入"当前记忆"中，输出一段新的、连贯的剧情摘要。
2. 只要摘要内容，不要任何解释或多余的话。
3. 重点记录：重要事件、长公主的决策、人际关系变化。
4. 字数控制在300字以内。
`;

        try {
            const res = await fetch(`${state.config.url}/chat/completions`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${state.config.key}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    model: state.config.model,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.5
                })
            });

            const data = await res.json();
            const newSummary = data.choices[0].message.content;

            state.summary = newSummary;
            await saveData();
            
            appendMsg('system-notice', '系统已自动更新剧情记忆摘要');
            
            console.log('记忆摘要更新完毕:', newSummary);

        } catch (e) {
            console.error('自动总结失败:', e);
        }
    }

    async function saveSummary() {
        const newVal = document.getElementById('summary-edit-content').value;
        state.summary = newVal;
        await saveData();
        closeModal('summary-editor-modal');
        showToast('记忆摘要已保存');
    }

    // ========== 历史记录渲染 ==========
    function renderHistory() {
        const panel = document.getElementById('history-panel');
        panel.innerHTML = '';
        (state.history || []).forEach((msg, i) => {
            appendMsg(msg.role === 'user' ? 'user' : 'ai', msg.content, i);
        });
    }

    // ========== 消息编辑 ==========
    function openMessageEditor(index) {
        const msg = state.history[index];
        if (!msg) return;        document.getElementById('msg-edit-content').value = msg.content;
        currentContextIndex = index;
        openModal('message-editor-modal');
    }

    async function saveMessageEdit() {
        const newContent = document.getElementById('msg-edit-content').value.trim();
        if (!newContent || currentContextIndex === null) return;
        
        state.history[currentContextIndex].content = newContent;
        await saveData();
        renderHistory();
        
        if (currentContextIndex === state.history.length - 1 && 
            state.history[currentContextIndex].role === 'assistant') {
            parseOptions(newContent);
        }
        
        closeModal('message-editor-modal');
        showToast('消息已修改');
    }

    // ========== 消息删除 ==========
    async function deleteMessage(index) {
        if (!confirm('确定删除这条消息吗？')) return;
        
        state.history.splice(index, 1);
        await saveData();
        renderHistory();
        showToast('消息已删除');
    }

    // ========== 重新生成（修复重复显示Bug） ==========
    async function regenLastResponse() {
        // 1. 检查历史记录是否足够（至少要有一对对话）
        if (state.history.length < 2) return;
        
        // 2. 找到最后一条 AI 消息
        const lastMsg = state.history[state.history.length - 1];
        
        // 3. 如果最后一条是 AI，倒数第二条是 User
        if (lastMsg.role === 'assistant') {
            // 获取用户最后发送的内容
            const lastUserMsg = state.history[state.history.length - 2];
            if (lastUserMsg.role !== 'user') return;
            
            const lastUserContent = lastUserMsg.content;

            // 关键修复：直接弹出最后两条（AI 的回复 和 User 的指令）
            // 因为 submitAction 会重新执行 appendMsg 和 history.push
            state.history.pop(); // 移除 AI 回复
            state.history.pop(); // 移除 User 指令
            
            await saveData();
            renderHistory(); // 重新渲染界面（此时界面上这两条消息都消失了）
            
            // 4. 重新提交指令
            submitAction(lastUserContent);
        } else if (lastMsg.role === 'user') {
            // 如果最后一条正好是 User（比如刚才失败了），直接重发
            const lastUserContent = lastMsg.content;
            state.history.pop(); // 移除这一条，交给 submitAction 重新处理
            
            await saveData();
            renderHistory();
            submitAction(lastUserContent);
        }
    }


    // ========== 清空聊天 ==========
    async function clearAllChat() {
        if (!confirm('确定清空所有聊天记录？此操作不可恢复！')) return;
        
        state.history = [];
        state.summary = '';
        await saveData();
        
        document.getElementById('history-panel').innerHTML = '';
        document.getElementById('action-grid').innerHTML = '';
        showToast('聊天记录已清空');
    }

    // ========== 世界书管理 ==========
    function renderWorldbookList() {
        const list = document.getElementById('worldbook-list');
        if (!state.worldbooks) state.worldbooks = [];
        if (!state.activeWorldbooks) state.activeWorldbooks = [];
        
        list.innerHTML = '';
        
        if (state.worldbooks.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#888; padding:15px;">暂无世界书</div>';
            return;
        }
        
        state.worldbooks.forEach(wb => {
            const item = document.createElement('div');
            item.className = 'worldbook-item';
            if (state.activeWorldbooks.includes(wb.id)) {
                item.classList.add('active');
            }
            
            const title = document.createElement('div');
            title.className = 'worldbook-item-title';
            title.innerText = wb.name;
            title.onclick = () => toggleWorldbook(wb.id);
            
            const editBtn = document.createElement('button');
            editBtn.className = 'wb-btn';
            editBtn.innerText = '编辑';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                editWorldbook(wb.id);
            };
            
            const delBtn = document.createElement('button');
            delBtn.className = 'wb-btn delete';
            delBtn.innerText = '删除';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                deleteWorldbook(wb.id);
            };
            
            item.appendChild(title);
            item.appendChild(editBtn);
            item.appendChild(delBtn);
            list.appendChild(item);
        });
    }

    async function toggleWorldbook(id) {
        const idx = state.activeWorldbooks.indexOf(id);
        if (idx > -1) {
            state.activeWorldbooks.splice(idx, 1);
        } else {
            state.activeWorldbooks.push(id);
        }
        await saveData();
        renderWorldbookList();
    }

    function createNewWorldbook() {
        currentEditingWbId = null;
        document.getElementById('wb-edit-name').value = '';
        document.getElementById('wb-edit-content').value = '';
        openModal('worldbook-editor-modal');
    }

    function editWorldbook(id) {
        const wb = state.worldbooks.find(w => w.id === id);
        if (!wb) return;
        
        currentEditingWbId = id;
        document.getElementById('wb-edit-name').value = wb.name;
        document.getElementById('wb-edit-content').value = wb.content;
        openModal('worldbook-editor-modal');
    }

    async function saveWorldbookEdit() {
        const name = document.getElementById('wb-edit-name').value.trim();
        const content = document.getElementById('wb-edit-content').value.trim();
        
        if (!name) {
            alert('请输入世界书名称');
            return;
        }
        
        if (currentEditingWbId) {
            const wb = state.worldbooks.find(w => w.id === currentEditingWbId);
            if (wb) {
                wb.name = name;
                wb.content = content;
            }
        } else {
            state.worldbooks.push({
                id: 'wb_' + Date.now(),
                name: name,
                content: content
            });
        }
        
        await saveData();
        renderWorldbookList();
        closeModal('worldbook-editor-modal');
        showToast('世界书已保存');
    }

    async function deleteWorldbook(id) {
        if (!confirm('确定删除此世界书？')) return;
        
        state.worldbooks = state.worldbooks.filter(w => w.id !== id);
        state.activeWorldbooks = state.activeWorldbooks.filter(wid => wid !== id);
        await saveData();
        renderWorldbookList();
        showToast('世界书已删除');
    }

    // ========== 模式选择 ==========
    function selectMode(mode) {
        state.systemMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            }
        });
        saveData();
        showToast(`已切换到${mode}模式`);
    }

    // ========== 获取模型 ==========
    async function fetchModels() {
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        if (!url || !key) {
            alert('请先填写API地址和Key');
            return;
        }
        
        try {
            const res = await fetch(`${url}/models`, {
                headers: { 'Authorization': `Bearer ${key}` }
            });
            const data = await res.json();
            const sel = document.getElementById('model-select');
            sel.innerHTML = '';
            data.data.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.text = m.id;
                sel.add(opt);
            });
            showToast('模型列表获取成功');
        } catch (e) {
            alert('获取失败：' + e.message);
        }
    }

    // ========== 游戏初始化 ==========
    async function initGame() {
        if (!state.shortcuts) state.shortcuts = [];
        
        let hasNew = false;
        for (let i = 0; i < 4; i++) {
            const input = document.getElementById('new-shortcut-' + i);
            const val = input.value.trim();
            if (val && val.includes('|')) {
                const parts = val.split('|');
                if (parts[0].trim() && parts[1].trim()) {
                    state.shortcuts.push({ 
                        name: parts[0].trim(), 
                        cmd: parts[1].trim() 
                    });
                    hasNew = true;
                }
            }
            input.value = '';
        }

        state.config.url = document.getElementById('api-url').value;
        state.config.key = document.getElementById('api-key').value;
        state.config.model = document.getElementById('model-select').value;
        state.princess.name = document.getElementById('player-name').value || '昭宁';
        state.princess.personality = document.getElementById('personality').value || '';
        state.contextLength = parseInt(document.getElementById('context-length').value) || 20;
        state.enableTimeAwareness = document.getElementById('enable-time-awareness').checked;
        state.eroticMode = document.getElementById('erotic-toggle').checked;
        
        state.eroticOrientation = state.eroticOrientation || 'gb';  

        
        if (!state.config.model) {
            alert('必须选择模型');
            return;
        }
        
        await saveData();
        
        renderShortcuts();
        closeModal('setup-modal');
        document.getElementById('header-title').innerText = `玄夜卫系统 · ${state.princess.name}`;
        updateUserPanel();

        if (state.history.length === 0) {
            submitAction(document.getElementById('start-scene').value || "系统启动，描述当前环境。");
        }
        
        enterGame();
    }
    
        // ========== 存档导入导出功能 ==========
    function exportSave() {
        if (!state) {
            showToast('数据未加载，无法导出');
            return;
        }
        
        // 将 state 对象转换为 JSON 字符串
        const dataStr = JSON.stringify(state, null, 2); // 格式化一下，方便人类阅读
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        // 创建下载链接
        const link = document.createElement('a');
        link.href = url;
        // 文件名带上日期，如：玄夜卫存档_2024-01-31.json
        const date = new Date().toISOString().slice(0, 10);
        link.download = `玄夜卫存档_${date}_${state.princess.name || '长公主'}.json`;
        
        // 触发下载
        document.body.appendChild(link);
        link.click();
        
        // 清理
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast('存档已导出');
    }

    function importSave(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const json = JSON.parse(e.target.result);
                
                // 简单的格式校验，检查是否有关键字段
                if (!json.config || !json.princess || !json.userStats) {
                    alert('无效的存档文件：缺少关键数据');
                    return;
                }
                
                if (confirm('确定导入此存档吗？\n警告：当前的进度将被完全覆盖！')) {
                    state = json;
                    await saveData(); // 保存到 IndexedDB
                    alert('导入成功！页面即将刷新以加载新存档...');
                    location.reload(); // 刷新页面重新初始化
                }
            } catch (err) {
                console.error(err);
                alert('导入失败：存档文件格式错误或已损坏');
            }
        };
        reader.readAsText(file);
        
        // 清空 input，防止同一个文件无法重复触发 onchange
        input.value = ''; 
    }

    // ========== 清除数据 ==========
    async function clearData() {
        if (!confirm('确定重置所有数据？此操作不可恢复！')) return;
        
        const transaction = db.transaction(['gameState'], 'readwrite');
        const store = transaction.objectStore('gameState');
        store.clear();
        
        location.reload();
    }

    // ========== 收藏夹功能 ==========
    function renderFavorites() {
        const list = document.getElementById('favorites-list');
        list.innerHTML = '';
        
        if (!state.favorites || state.favorites.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">暂无收藏</div>';
            return;
        }
        
        state.favorites.forEach((fav, idx) => {
            const div = document.createElement('div');
            div.className = 'fav-item';
            
            const header = document.createElement('div');
            header.className = 'fav-item-header';
            header.innerHTML = `<span>${fav.guardName || '主线剧情'}</span><span>${fav.time || ''}</span>`;
            
            const content = document.createElement('div');
            content.className = 'fav-item-content';
            content.innerText = fav.content;
            
            const delBtn = document.createElement('button');
            delBtn.className = 'fav-item-delete';
            delBtn.innerText = '删除';
            delBtn.onclick = () => {
                state.favorites.splice(idx, 1);
                saveData();
                renderFavorites();
            };
            
            header.appendChild(delBtn);
            div.appendChild(header);
            div.appendChild(content);
            list.appendChild(div);
        });
    }

    // ========== 暗卫图鉴功能 ==========
    function openGuardsGallery() {
        renderGuardsGallery();
        openModal('guards-gallery-modal');
    }

    function renderGuardsGallery() {
        if (!state.guards) state.guards = [];
        
        const grid = document.getElementById('guards-grid');
        const unlockedCount = state.guards.filter(g => g.unlocked).length;
        const totalCount = state.guards.length;
        
        document.getElementById('unlocked-count').innerText = unlockedCount;
        document.getElementById('total-count').innerText = totalCount;
        
        grid.innerHTML = '';
        
        if (state.guards.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#888; padding:40px;">暂无暗卫档案<br>在剧情中遇到暗卫后将自动解锁<br>或在上方手动录入</div>';
            return;
        }
        
        state.guards.forEach(guard => {
            const card = document.createElement('div');
            card.className = 'guard-card';
            if (!guard.unlocked) card.classList.add('locked');
            
            let avatarContent = '';
            if (guard.avatar) {
                avatarContent = `<img src="${guard.avatar}" alt="${guard.name}">`;
            } else {
                avatarContent = guard.name.charAt(0);
            }
            
            if (guard.unlocked) {
                card.innerHTML = `
                    <div class="guard-avatar">${avatarContent}</div>
                    <div class="guard-name">${guard.name}</div>
                    <div class="guard-rank">${guard.rank || '待定级'}</div>
                `;
                card.onclick = () => openGuardDetail(guard.id);
            } else {
                card.innerHTML = `
                    <div class="guard-avatar">?</div>
                    <div class="guard-name">未解锁</div>
                    <div class="guard-rank">???</div>
                `;
            }
            
            grid.appendChild(card);
        });
    }

    function openGuardDetail(guardId) {
        const guard = state.guards.find(g => g.id === guardId);
        if (!guard || !guard.unlocked) return;
        
        state.currentGuard = guard;
        
        // 头像
        const avatarImg = document.getElementById('guard-detail-avatar-img');
        const placeholder = document.getElementById('guard-avatar-placeholder');
        if (guard.avatar) {
            avatarImg.src = guard.avatar;
            avatarImg.classList.remove('hidden');
            placeholder.style.display = 'none';
        } else {
            avatarImg.classList.add('hidden');
            placeholder.style.display = 'block';
        }
        
        document.getElementById('guard-detail-name').innerText = guard.name;
        document.getElementById('guard-detail-rank').innerText = guard.rank || '待定级';
        
        // 标签
        const tagsRow = document.getElementById('guard-detail-tags');
        tagsRow.innerHTML = '';
        (guard.tags || []).forEach(t => {
            const span = document.createElement('span');
            span.className = 'tag';
            span.innerText = t;
            tagsRow.appendChild(span);
        });
        
        // 数值
        const stats = guard.stats || { loyalty: 100, skill: 0, affection: 0 };
        document.getElementById('guard-loyalty').innerText = stats.loyalty;
        document.getElementById('guard-skill').innerText = stats.skill;
        document.getElementById('guard-intimacy').innerText = stats.affection;
        
        // 描述
        document.getElementById('guard-description').innerText = guard.desc || '暂无详述...';
        
        closeModal('guards-gallery-modal');
        openModal('guard-detail-modal');
    }

    function closeGuardDetail() {
        closeModal('guard-detail-modal');
        openModal('guards-gallery-modal');
        renderGuardsGallery();
    }

    // ========== 暗卫头像上传 ==========
    function uploadGuardAvatar() {
        document.getElementById('guard-avatar-upload').click();
    }

    function handleGuardAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            if (state.currentGuard) {
                state.currentGuard.avatar = e.target.result;
                saveData();
                openGuardDetail(state.currentGuard.id);
            }
        };
        reader.readAsDataURL(file);
    }

    // ========== 暗卫档案编辑 ==========
    function openGuardEditModal() {
        if (!state.currentGuard) return;
        document.getElementById('guard-edit-desc').value = state.currentGuard.desc || '';
        openModal('guard-edit-modal');
    }

    async function saveGuardEdit() {
        if (!state.currentGuard) return;
        state.currentGuard.desc = document.getElementById('guard-edit-desc').value;
        await saveData();
        closeModal('guard-edit-modal');
        openGuardDetail(state.currentGuard.id);
        showToast('档案已修改');
    }

    // ========== 重新生成暗卫档案 ==========
    async function regenGuardProfile() {
        if (!state.currentGuard) return;
        if (!confirm('确定重新生成此暗卫的档案？原档案内容将被覆盖（互动记录保留）。')) return;
        
        const g = state.currentGuard;
        const keywords = (g.tags || []).join('/');
        
        document.getElementById('guard-detail-loading').style.display = 'flex';
        
        await generateGuardProfile(g.id, g.name, keywords);
        
        document.getElementById('guard-detail-loading').style.display = 'none';
        openGuardDetail(g.id);
        showToast('档案已重新生成');
    }

    // ========== 删除暗卫 ==========
    async function deleteCurrentGuard() {
        if (!state.currentGuard) return;
        if (!confirm('确定删除此暗卫？将同时删除所有互动记录。')) return;
        
        state.guards = state.guards.filter(g => g.id !== state.currentGuard.id);
        state.currentGuard = null;
        await saveData();
        
        closeModal('guard-detail-modal');
        openGuardsGallery();
        showToast('暗卫已删除');
    }

    // ========== 暗卫独立设置 ==========
    function openGuardSettings() {
        if (!state.currentGuard) return;
        
        const hasCustom = state.currentGuard.customAPI !== null && state.currentGuard.customAPI !== undefined;
        document.getElementById('use-custom-api').checked = hasCustom;
        
        if (hasCustom && state.currentGuard.customAPI) {
            document.getElementById('custom-api-inputs').classList.add('active');
            document.getElementById('guard-api-url').value = state.currentGuard.customAPI.url || '';
            document.getElementById('guard-api-key').value = state.currentGuard.customAPI.key || '';
            document.getElementById('guard-api-model').value = state.currentGuard.customAPI.model || '';
        } else {
            document.getElementById('custom-api-inputs').classList.remove('active');
            document.getElementById('guard-api-url').value = '';
            document.getElementById('guard-api-key').value = '';
            document.getElementById('guard-api-model').value = '';
        }
        
        closeModal('guard-detail-modal');
        openModal('guard-settings-modal');
    }

    function toggleCustomAPI() {
        const checked = document.getElementById('use-custom-api').checked;
        const inputs = document.getElementById('custom-api-inputs');
        
        if (checked) {
            inputs.classList.add('active');
        } else {
            inputs.classList.remove('active');
        }
    }

    async function saveGuardSettings() {
        if (!state.currentGuard) return;
        
        const useCustom = document.getElementById('use-custom-api').checked;
        
        if (useCustom) {
            const url = document.getElementById('guard-api-url').value.trim();
            const key = document.getElementById('guard-api-key').value.trim();
            const model = document.getElementById('guard-api-model').value.trim();
            
            if (!url || !key || !model) {
                alert('请填写完整的API配置');
                return;
            }
            
            state.currentGuard.customAPI = { url, key, model };
        } else {
            state.currentGuard.customAPI = null;
        }
        
        await saveData();
        closeModal('guard-settings-modal');
        openGuardDetail(state.currentGuard.id);
        showToast('设置已保存');
    }

    // ========== 暗卫聊天功能 ==========
    function openGuardChat(mode) {
        if (!state.currentGuard) return;
        
        state.currentChatMode = mode;
        state.selectedBubbleIndex = null;
        
        const modalId = mode === 'online' ? 'guard-chat-modal-online' : 'guard-chat-modal-offline';
        const titleId = mode === 'online' ? 'chat-title-online' : 'chat-title-offline';
        
        document.getElementById(modalId).style.display = 'flex';
        document.getElementById(titleId).innerText = `${state.currentGuard.name} · ${mode === 'online' ? '传音' : '召见'}`;
        
        closeModal('guard-detail-modal');
        renderGuardChatHistory();
        updateReplyButton();
    }

    function closeGuardChat(mode) {
        const modalId = mode === 'online' ? 'guard-chat-modal-online' : 'guard-chat-modal-offline';
        document.getElementById(modalId).style.display = 'none';
        hideBubbleMenu();
        openGuardDetail(state.currentGuard.id);
    }

    function renderGuardChatHistory() {
        if (!state.currentGuard) return;
        
        const boxId = state.currentChatMode === 'online' ? 'chat-history-online' : 'chat-history-offline';
        const box = document.getElementById(boxId);
        box.innerHTML = '';
        
        if (!state.currentGuard.chatHistory) {
            state.currentGuard.chatHistory = [];
        }
        
        if (state.currentGuard.chatHistory.length === 0) {
            box.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">暂无对话记录</div>';
            return;
        }
        
        state.currentGuard.chatHistory.forEach((msg, idx) => {
            appendBubble(msg.role, msg.content, idx, msg.favorited);
        });
    }

    function appendBubble(role, text, index, favorited = false) {
        const boxId = state.currentChatMode === 'online' ? 'chat-history-online' : 'chat-history-offline';
        const box = document.getElementById(boxId);
        const div = document.createElement('div');
        div.className = `bubble ${role === 'user' ? 'user' : 'ai'}`;
        if (favorited) div.classList.add('favorited');
        div.innerText = text;
        div.dataset.index = index;
        div.onclick = () => selectBubble(index);
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function selectBubble(index) {
        state.selectedBubbleIndex = index;
        
        document.querySelectorAll('.bubble').forEach(b => b.classList.remove('selected'));
        const bubble = document.querySelector(`.bubble[data-index="${index}"]`);
        if (bubble) bubble.classList.add('selected');

        const msg = state.currentGuard.chatHistory[index];
        
        const favOrb = document.querySelector('.menu-orb.favorite-orb');
        favOrb.innerText = msg.favorited ? '★' : '☆';

        const regenOrb = document.querySelector('.menu-orb.regen-orb');
        if (msg.role === 'user') {
            regenOrb.style.opacity = '0.3';
            regenOrb.style.pointerEvents = 'none';
        } else {
            regenOrb.style.opacity = '1';
            regenOrb.style.pointerEvents = 'auto';
        }

        showBubbleMenu();
    }

    function showBubbleMenu() {
        const menu = document.getElementById('bubble-menu');
        menu.classList.add('show');
    }

    function hideBubbleMenu() {
        const menu = document.getElementById('bubble-menu');
        menu.classList.remove('show');
        state.selectedBubbleIndex = null;
        document.querySelectorAll('.bubble').forEach(b => b.classList.remove('selected'));
    }

    // ========== 气泡操作 ==========
    function editSelectedBubble() {
        if (state.selectedBubbleIndex === null || !state.currentGuard) return;
        const msg = state.currentGuard.chatHistory[state.selectedBubbleIndex];
        
        document.getElementById('bubble-edit-text').value = msg.content;
        openModal('bubble-edit-modal');
    }

    async function saveBubbleEdit() {
        const newText = document.getElementById('bubble-edit-text').value.trim();
        if (!newText || !state.currentGuard) return;
        
        state.currentGuard.chatHistory[state.selectedBubbleIndex].content = newText;
        await saveData();
        renderGuardChatHistory();
        closeModal('bubble-edit-modal');
        hideBubbleMenu();
    }

    async function toggleBubbleFavorite() {
        if (state.selectedBubbleIndex === null || !state.currentGuard) return;
        const msg = state.currentGuard.chatHistory[state.selectedBubbleIndex];
        
        msg.favorited = !msg.favorited;
        
        if (msg.favorited) {
            state.favorites.push({
                id: Date.now(),
                guardName: state.currentGuard.name,
                content: msg.content,
                time: new Date().toLocaleString()
            });
        } else {
            state.favorites = state.favorites.filter(f => f.content !== msg.content);
        }
        
        await saveData();
        renderGuardChatHistory();
        renderFavorites();
        hideBubbleMenu();
    }

    async function deleteSelectedBubble() {
        if (state.selectedBubbleIndex === null || !state.currentGuard) return;
        if (!confirm('确定删除这条消息？')) return;
        
        state.currentGuard.chatHistory.splice(state.selectedBubbleIndex, 1);
        await saveData();
        renderGuardChatHistory();
        hideBubbleMenu();
    }

    async function regenSelectedBubble() {
        if (state.selectedBubbleIndex === null || !state.currentGuard) return;
        const msg = state.currentGuard.chatHistory[state.selectedBubbleIndex];
        
        if (msg.role === 'user') return;
        if (!confirm('确定重新生成这条回复？')) return;
        
        hideBubbleMenu();
        
        // 删除当前消息并重新生成
        state.currentGuard.chatHistory.splice(state.selectedBubbleIndex, 1);
        await saveData();
        renderGuardChatHistory();
        
        // 触发AI回复
        triggerGuardAIReply(state.currentChatMode);
    }

    // ========== 发送用户消息 ==========
    function sendGuardUserMessage(mode) {
        const inputId = mode === 'online' ? 'chat-input-online' : 'chat-input-offline';
        const input = document.getElementById(inputId);
        const text = input.value.trim();
        if (!text || !state.currentGuard) return;

        if (!state.currentGuard.chatHistory) {
            state.currentGuard.chatHistory = [];
        }

        const newIndex = state.currentGuard.chatHistory.length;
        appendBubble('user', text, newIndex);
        state.currentGuard.chatHistory.push({ role: 'user', content: text, favorited: false });
        saveData();
        
        input.value = '';
        updateReplyButton();
    }

    function updateReplyButton() {
        const btnId = state.currentChatMode === 'online' ? 'reply-btn-online' : 'reply-btn-offline';
        const btn = document.getElementById(btnId);
        
        if (state.currentGuard && state.currentGuard.chatHistory && 
            state.currentGuard.chatHistory.length > 0 && 
            state.currentGuard.chatHistory[state.currentGuard.chatHistory.length - 1].role === 'user') {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    }

    // ========== 触发暗卫AI回复 ==========
    async function triggerGuardAIReply(mode) {
        if (!state.currentGuard || !state.currentGuard.chatHistory || 
            state.currentGuard.chatHistory.length === 0 ||
            state.currentGuard.chatHistory[state.currentGuard.chatHistory.length - 1].role !== 'user') return;

        const boxId = mode === 'online' ? 'chat-history-online' : 'chat-history-offline';
        const box = document.getElementById(boxId);
        
        // 显示输入中提示
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.innerText = '对方正在输入...';
        box.appendChild(typingDiv);
        box.scrollTop = box.scrollHeight;

        const g = state.currentGuard;
        const apiConfig = g.customAPI || state.config;
        
        // 获取活动世界书内容
        const wbContent = (state.worldbooks || [])
            .filter(w => (state.activeWorldbooks || []).includes(w.id))
            .map(w => `【设定-${w.name}】：${w.content}`)
            .join('\n');
        
        const systemPrompt = buildGuardSystemPrompt(g, wbContent, mode);
        
        const messages = [
            { role: "system", content: systemPrompt },
            ...g.chatHistory.slice(-20)
        ];

        try {
            const res = await fetch(`${apiConfig.url}/chat/completions`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${apiConfig.key}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    model: apiConfig.model,
                    messages: messages,
                    temperature: 0.8
                })
            });

            const data = await res.json();
            let reply = data.choices[0].message.content;
            
            // 移除emoji
            reply = reply.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/gu, '');
                        
            // 移除好感度变化指令
            reply = reply.replace(/【好感[+-]\d+[：:].+?】/g, '');

            typingDiv.remove();
            
            // 线上模式解析多条消息
            if (mode === 'online') {
                const matches = reply.match(/<\[(.*?)\]>/g);
                if (matches) {
                    for (const m of matches) {
                        const cleanText = m.slice(2, -2);
                        const idx = g.chatHistory.length;
                        appendBubble('assistant', cleanText, idx);
                        g.chatHistory.push({ role: 'assistant', content: cleanText, favorited: false });
                    }
                } else {
                    const idx = g.chatHistory.length;
                    appendBubble('assistant', reply, idx);
                    g.chatHistory.push({ role: 'assistant', content: reply, favorited: false });
                }
            } else {
                const idx = g.chatHistory.length;
                appendBubble('assistant', reply, idx);
                g.chatHistory.push({ role: 'assistant', content: reply, favorited: false });
            }
            
            // 检测AI控制的好感度变化
            detectAffectionChange(reply, g);
            
            await saveData();
            updateReplyButton();
        } catch (e) {
            typingDiv.remove();
            alert('AI回复失败：' + e.message);
        }
    }

    // ========== 构建暗卫聊天系统提示词（带主线剧情互通） ==========
    function buildGuardSystemPrompt(guard, wbContent, mode) {
        const stats = guard.stats || { loyalty: 100, skill: 0, affection: 0 };
        
        // 获取主线剧情记忆
        let mainStoryContext = '';
        if (state.summary) {
            mainStoryContext = `\n【主线剧情记忆】：\n${state.summary}`;
        }
        
        // 获取最近的主线对话（简化版）
        let recentMainHistory = '';
        if (state.history && state.history.length > 0) {
            const recent = state.history.slice(-6);
            const lines = recent.map(h => {
                const role = h.role === 'user' ? '长公主' : '系统/NPC';
                const content = h.content.length > 100 ? h.content.slice(0, 100) + '...' : h.content;
                return `${role}：${content}`;
            });
            recentMainHistory = `\n【近期主线发展】：\n${lines.join('\n')}`;
        }
        
        let prompt = `你现在扮演暗卫 [${guard.name}]。

【人设档案】：
${guard.desc || '暂无详细档案'}

【基础属性】：
- 职位：${guard.rank || '待定级'}
- 忠诚度：${stats.loyalty}
- 武力值：${stats.skill}
- 好感度：${stats.affection}

【世界观设定】：
${wbContent || '暂无额外设定'}
${mainStoryContext}
${recentMainHistory}

【当前模式】：${mode === 'online' ? '线上传音(远程通讯，通过法器传音)' : '线下寝宫召见(面对面互动)'}。

【对话对象】：${state.princess.name}长公主（你的主人）

【长公主属性】：
魅力${state.userStats.charm} | 权势${state.userStats.power} | 智谋${state.userStats.wisdom} | 声望${state.userStats.fame}
性格特质：${(state.userStats.traits || []).join('、') || '无'}

【角色扮演规则】：
1. 严格按照你的人设性格说话行事
2. 对长公主保持绝对忠诚和尊敬
3. 禁止使用任何emoji表情
4. 使用古风语言风格，符合暗卫身份
5. 根据好感度调整语气（低好感度更拘谨，高好感度可适当亲近）
6. 不要重复长公主的话，直接回应即可
7. 侍寝时绝对不会自称"您的狗"，但可以自称"小狗"
8. 你知道最近的主线剧情，可以在对话中自然提及相关事件`;

        if (mode === 'online') {
            prompt += `

【线上模式特殊规则】：
你通过法器传音与长公主交流。为了模拟真实发消息的节奏，你可以将回复拆分成多条短句。

**格式强制**：每一条消息都必须用 <[...]> 包裹。
例如：想发"殿下。"和"属下在。"这两句，你必须输出：<[殿下。]><[属下在。]>
如果不拆分，也必须包裹：<[一整段话。]>`;
        } else {
            prompt += `

【线下模式规则】：
你被召见至长公主寝宫，面对面交流。
使用标准小说描写风格，长段RP回复，详细描写动作、神态、环境氛围等。
可以有肢体互动的描写。`;
        }
        
                prompt += `

【好感度变化规则】：
- 你可以根据对话内容自行判断是否需要调整好感度
- 使用格式：【好感+数值：${guard.name}】或【好感-数值：${guard.name}】
- 数值范围1-5，重大事件可达10。
- 低频率使用！大约每15次互动才触发一次变化
- 日常闲聊不需要变化好感度`;
        
        prompt += getEroticPrompt();
        
        return prompt;
    }



    // ========== 通用AI调用函数 ==========
    async function callAI(messages, temperature = 0.7, customConfig = null) {
        const config = customConfig || state.config;
        if (!config.key) throw new Error("请先配置API Key");
        
        const res = await fetch(`${config.url}/chat/completions`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${config.key}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({
                model: config.model,
                messages: messages,
                temperature: temperature
            })
        });
        const data = await res.json();
        return data.choices[0].message.content;
    }

    // ========== 页面初始化完成 ==========
    console.log('玄夜卫系统加载完成');
    
        // ========== 在场暗卫管理 ==========
    function openPresentGuardsModal() {
        renderPresentGuardsList();
        initWeightSelector();
        initAutoMountSettings();  // 新增：初始化自动挂载设置
        openModal('present-guards-modal');
    }


    function renderPresentGuardsList() {
        const presentList = document.getElementById('present-guards-list');
        const availableList = document.getElementById('available-guards-list');
        
        if (!state.presentGuards) state.presentGuards = [];
        if (!state.guards) state.guards = [];
        
        presentList.innerHTML = '';
        availableList.innerHTML = '';
        
        // 在场暗卫
        const presentGuards = state.guards.filter(g => g.unlocked && state.presentGuards.includes(g.id));
        if (presentGuards.length === 0) {
            presentList.innerHTML = '<div class="empty-guards-hint">暂无在场暗卫</div>';
        } else {
            presentGuards.forEach(g => {
                presentList.appendChild(createGuardSelectItem(g, true));
            });
        }
        
        // 可召唤暗卫
        const availableGuards = state.guards.filter(g => g.unlocked && !state.presentGuards.includes(g.id));
        if (availableGuards.length === 0) {
            availableList.innerHTML = '<div class="empty-guards-hint">暂无可召唤暗卫</div>';
        } else {
            availableGuards.forEach(g => {
                availableList.appendChild(createGuardSelectItem(g, false));
            });
        }
        
        updatePresentCount();
    }

    function createGuardSelectItem(guard, isPresent) {
        const item = document.createElement('div');
        item.className = 'guard-select-item' + (isPresent ? ' present' : '');
        
        let avatarContent = guard.name.charAt(0);
        if (guard.avatar) {
            avatarContent = `<img src="${guard.avatar}" alt="${guard.name}">`;
        }
        
        item.innerHTML = `
            <div class="guard-select-avatar">${avatarContent}</div>
            <span>${guard.name}</span>
            <span style="font-size: 0.7rem; opacity: 0.7;">${guard.rank || ''}</span>
        `;
        
        item.onclick = () => toggleGuardPresence(guard.id);
        
        return item;
    }

    async function toggleGuardPresence(guardId) {
        if (!state.presentGuards) state.presentGuards = [];
        
        const idx = state.presentGuards.indexOf(guardId);
        if (idx > -1) {
            // 退场
            state.presentGuards.splice(idx, 1);
            const guard = state.guards.find(g => g.id === guardId);
            if (guard) {
                appendMsg('system-notice', `【${guard.name}】已退场`);
            }
        } else {
            // 入场
            state.presentGuards.push(guardId);
            const guard = state.guards.find(g => g.id === guardId);
            if (guard) {
                appendMsg('system-notice', `【${guard.name}】已入场`);
            }
        }
        
        await saveData();
        renderPresentGuardsList();
        updatePresentCount();
    }

    function clearAllPresentGuards() {
        if (!confirm('确定让所有暗卫退场？')) return;
        
        state.presentGuards = [];
        saveData();
        renderPresentGuardsList();
        updatePresentCount();
        appendMsg('system-notice', '所有暗卫已退场');
    }

    function updatePresentCount() {
        const count = (state.presentGuards || []).length;
        document.getElementById('present-count').innerText = count;
    }

    // 检测用户输入中提到的暗卫并自动入场
    function detectAndSummonGuards(userInput) {
        if (!state.guards || !userInput) return;
        
        const currentMsgIndex = state.history.length;
        const newlySummoned = [];
        
        state.guards.forEach(g => {
            if (g.unlocked && userInput.includes(g.name)) {
                // 记录提及
                state.guardLastMention[g.id] = currentMsgIndex;
                
                if (!state.presentGuards.includes(g.id)) {
                    state.presentGuards.push(g.id);
                    newlySummoned.push(g.name);
                }
            }
        });
        
        // 裁剪超出限制的
        if (state.presentGuards.length > state.maxPresentGuards) {
            trimPresentGuards();
        }
        
        if (newlySummoned.length > 0) {
            saveData();
            updatePresentCount();
            appendMsg('system-notice', `【${newlySummoned.join('、')}】已自动入场`, state.history.length);
        }
    }


    // 检测AI回复中的暗卫退场指令
    function detectGuardDismissal(aiReply) {
        // 匹配格式：【退场：暗卫名】或【暗卫名退下】或【暗卫名离开】
        const patterns = [
            /【退场[：:]\s*(.+?)】/g,
            /【(.+?)退下】/g,
            /【(.+?)离开】/g,
            /【(.+?)告退】/g
        ];
        
        const dismissed = [];
        
        patterns.forEach(regex => {
            let match;
            while ((match = regex.exec(aiReply)) !== null) {
                const name = match[1].trim();
                const guard = state.guards.find(g => g.name === name);
                if (guard && state.presentGuards.includes(guard.id)) {
                    const idx = state.presentGuards.indexOf(guard.id);
                    if (idx > -1) {
                        state.presentGuards.splice(idx, 1);
                        dismissed.push(name);
                    }
                }
            }
        });
        
        if (dismissed.length > 0) {
            saveData();
            updatePresentCount();
        }
        
        return dismissed;
    }


        // ========== 暗卫档案权重系统 ==========
    function setGuardWeight(weight) {
        state.guardProfileWeight = weight;
        saveData();
        
        // 更新UI
        document.querySelectorAll('.weight-option').forEach(opt => {
            opt.classList.remove('active');
            if (opt.dataset.weight === weight) {
                opt.classList.add('active');
            }
        });
        
        const labels = { lite: '精简模式', standard: '标准模式', deep: '深度模式' };
        showToast(`已切换至${labels[weight]}`);
    }

    // 根据权重获取暗卫档案
    function getPresentGuardsProfile() {
        if (!state.presentGuards || state.presentGuards.length === 0) return '';
        
        const weight = state.guardProfileWeight || 'standard';
        
        const profiles = state.presentGuards.map(id => {
            const g = state.guards.find(guard => guard.id === id);
            if (!g) return null;
            
            const stats = g.stats || { loyalty: 100, skill: 0, affection: 0 };
            
            // 精简模式：只有名字和关键词
            if (weight === 'lite') {
                const keywords = (g.tags || []).join('、') || '无';
                return `【${g.name}】（${g.rank || '待定级'}）- 关键词：${keywords}`;
            }
            
            // 标准模式：名字+属性+档案描述
            if (weight === 'standard') {
                return `【${g.name}】（${g.rank || '待定级'}）
忠诚度：${stats.loyalty} | 武力：${stats.skill} | 好感：${stats.affection}
档案：${g.desc || g.tags?.join('、') || '暂无详述'}`;
            }
            
            // 深度模式：标准模式 + 最近聊天记录摘要
            if (weight === 'deep') {
                let chatSummary = '';
                if (g.chatHistory && g.chatHistory.length > 0) {
                    const recentChats = g.chatHistory.slice(-6);
                    const chatLines = recentChats.map(c => {
                        const role = c.role === 'user' ? '长公主' : g.name;
                        const content = c.content.length > 50 ? c.content.slice(0, 50) + '...' : c.content;
                        return `${role}：${content}`;
                    });
                    chatSummary = `\n【近期对话记忆】：\n${chatLines.join('\n')}`;
                }
                
                return `【${g.name}】（${g.rank || '待定级'}）
忠诚度：${stats.loyalty} | 武力：${stats.skill} | 好感：${stats.affection}
档案：${g.desc || g.tags?.join('、') || '暂无详述'}${chatSummary}`;
            }
            
            return null;
        }).filter(p => p !== null);
        
        if (profiles.length === 0) return '';
        
        const weightLabel = { lite: '精简', standard: '标准', deep: '深度' }[weight];
        
        return `\n【当前在场暗卫档案】（${weightLabel}模式）：
${profiles.join('\n\n')}

【暗卫退场机制】：
当暗卫离开场景时，请使用格式：【退场：暗卫名】或【暗卫名退下】或【暗卫名告退】`;
    }

    // ========== 增强版用户面板功能 ==========
    function updateUserPanel() {
        const name = state.princess.name || '昭宁';
                // 头像显示
        const avatarImg = document.getElementById('user-avatar-img');
        const avatarText = document.getElementById('user-avatar-text');
        if (state.userStats.avatar) {
            avatarImg.src = state.userStats.avatar;
            avatarImg.classList.remove('hidden');
            avatarText.style.display = 'none';
        } else {
            avatarImg.classList.add('hidden');
            avatarText.style.display = 'block';
            avatarText.innerText = name.charAt(0);
        }
        document.getElementById('user-panel-title').innerText = name + '长公主';
        
        const stats = state.userStats;
        document.getElementById('stat-charm').innerText = stats.charm;
        document.getElementById('stat-power').innerText = stats.power;
        document.getElementById('stat-wisdom').innerText = stats.wisdom;
        document.getElementById('stat-fame').innerText = stats.fame;
        
        // 更新进度条
        document.getElementById('bar-charm').style.width = stats.charm + '%';
        document.getElementById('bar-power').style.width = stats.power + '%';
        document.getElementById('bar-wisdom').style.width = stats.wisdom + '%';
        document.getElementById('bar-fame').style.width = stats.fame + '%';
        
        // 更新暗卫数量（根据实际解锁数）
        const unlockedGuards = (state.guards || []).filter(g => g.unlocked).length;
        document.getElementById('stat-guards').innerText = unlockedGuards;
        document.getElementById('stat-wealth').innerText = stats.wealth;
        
        // 更新暗卫关系统计
        document.getElementById('rel-total').innerText = unlockedGuards;
        const intimateGuards = (state.guards || []).filter(g => g.unlocked && g.stats && g.stats.affection >= 80).length;
        document.getElementById('rel-intimate').innerText = intimateGuards;
        const totalChats = (state.guards || []).reduce((sum, g) => sum + (g.chatHistory?.length || 0), 0);
        document.getElementById('rel-chats').innerText = totalChats;
        
        // 渲染可编辑的性格特质
        const traitContainer = document.getElementById('trait-tags');
        traitContainer.innerHTML = '';
        (stats.traits || []).forEach((trait, idx) => {
            const tag = document.createElement('span');
            tag.className = 'trait-tag removable';
            tag.innerText = trait;
            tag.onclick = () => removeTrait(idx);
            traitContainer.appendChild(tag);
        });
        
        document.getElementById('user-status').innerText = stats.status;
        
        // 更新成就
        renderAchievements();
    }

    function editStat(statName) {
        const labels = { charm: '魅力值', power: '权势值', wisdom: '智谋值', fame: '声望值' };
        const currentVal = state.userStats[statName];
        const newVal = prompt(`修改${labels[statName]}（0-100）：`, currentVal);
        
        if (newVal !== null) {
            const num = parseInt(newVal);
            if (!isNaN(num) && num >= 0 && num <= 100) {
                state.userStats[statName] = num;
                saveData();
                updateUserPanel();
                showToast(`${labels[statName]}已更新为 ${num}`);
            } else {
                showToast('请输入0-100之间的数字');
            }
        }
    }

    function addNewTrait() {
        const newTrait = prompt('添加新的性格特质：');
        if (newTrait && newTrait.trim()) {
            if (!state.userStats.traits) state.userStats.traits = [];
            state.userStats.traits.push(newTrait.trim());
            saveData();
            updateUserPanel();
            showToast('特质已添加');
        }
    }

    function removeTrait(index) {
        if (confirm(`确定删除特质"${state.userStats.traits[index]}"？`)) {
            state.userStats.traits.splice(index, 1);
            saveData();
            updateUserPanel();
            showToast('特质已删除');
        }
    }

    function editStatus() {
        const newStatus = prompt('编辑当前状态：', state.userStats.status);
        if (newStatus !== null && newStatus.trim()) {
            state.userStats.status = newStatus.trim();
            saveData();
            updateUserPanel();
            showToast('状态已更新');
        }
    }

    // ========== 成就系统 ==========
    function renderAchievements() {
        const achievementDefs = [
            { id: 'first_guard', name: '初遇暗卫', desc: '解锁第一位暗卫', icon: '○', check: () => (state.guards || []).filter(g => g.unlocked).length >= 1 },
            { id: 'five_guards', name: '五卫随行', desc: '解锁5位暗卫', icon: '●', check: () => (state.guards || []).filter(g => g.unlocked).length >= 5 },
            { id: 'ten_guards', name: '众星捧月', desc: '解锁10位暗卫', icon: '◆', check: () => (state.guards || []).filter(g => g.unlocked).length >= 10 },
            { id: 'first_chat', name: '传音初试', desc: '与暗卫对话一次', icon: '◇', check: () => (state.guards || []).some(g => g.chatHistory && g.chatHistory.length > 0) },
            { id: 'intimate', name: '心腹之交', desc: '有暗卫好感度达到80', icon: '❖', check: () => (state.guards || []).some(g => g.stats && g.stats.affection >= 80) },
            { id: 'collector', name: '收藏家', desc: '收藏5条对话', icon: '☆', check: () => (state.favorites || []).length >= 5 },
            { id: 'story_ten', name: '剧情十章', desc: '对话轮次超过20', icon: '▣', check: () => (state.history || []).length >= 20 },
            { id: 'worldbook', name: '博学多才', desc: '创建一本世界书', icon: '▢', check: () => (state.worldbooks || []).length >= 1 },
        ];
        
        const container = document.getElementById('achievement-tags');
        container.innerHTML = '';
        
        achievementDefs.forEach(ach => {
            const unlocked = ach.check();
            const badge = document.createElement('span');
            badge.className = 'achievement-badge' + (unlocked ? '' : ' locked');
            badge.innerHTML = `${ach.icon} ${ach.name}`;
            badge.title = unlocked ? ach.desc : `未解锁：${ach.desc}`;
            container.appendChild(badge);
        });
    }

    // ========== 初始化权重选择器UI ==========
    function initWeightSelector() {
        const weight = state.guardProfileWeight || 'standard';
        document.querySelectorAll('.weight-option').forEach(opt => {
            opt.classList.remove('active');
            if (opt.dataset.weight === weight) {
                opt.classList.add('active');
            }
        });
    }
        function uploadUserAvatar() {
        document.getElementById('user-avatar-upload').click();
    }

    function handleUserAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            state.userStats.avatar = e.target.result;
            saveData();
            updateUserPanel();
            showToast('头像已更新');
        };
        reader.readAsDataURL(file);
    }
    
        // ========== 智能自动挂载系统 ==========
    
    // 开关自动挂载
    function toggleAutoMount() {
        const checked = document.getElementById('auto-mount-toggle').checked;
        state.autoMountGuards = checked;
        
        const settingsDiv = document.getElementById('auto-mount-settings');
        settingsDiv.style.display = checked ? 'block' : 'none';
        
        saveData();
        showToast(checked ? '已开启智能自动挂载' : '已关闭自动挂载');
    }
    
    // 更新最大在场数
    function updateMaxPresent() {
        const val = parseInt(document.getElementById('max-present-input').value) || 5;
        state.maxPresentGuards = Math.max(1, Math.min(20, val));
        saveData();
        
        // 如果当前在场数超过限制，移除多余的
        trimPresentGuards();
    }
    
    // 裁剪在场暗卫数量
    function trimPresentGuards() {
        if (!state.presentGuards || !state.maxPresentGuards) return;
        
        while (state.presentGuards.length > state.maxPresentGuards) {
            const removedId = state.presentGuards.shift(); // 移除最早入场的
            const guard = state.guards.find(g => g.id === removedId);
            if (guard) {
                appendMsg('system-notice', `【${guard.name}】因在场人数限制已自动退场`, state.history.length);
            }
        }
        
        saveData();
        updatePresentCount();
    }
    
    function initAutoMountSettings() {
        const toggle = document.getElementById('auto-mount-toggle');
        const maxInput = document.getElementById('max-present-input');
        const settingsDiv = document.getElementById('auto-mount-settings');
        
        if (toggle) {
            toggle.checked = state.autoMountGuards !== false;
            settingsDiv.style.display = toggle.checked ? 'block' : 'none';
        }
        if (maxInput) {
            maxInput.value = state.maxPresentGuards || 5;
        }
    }
    
function detectAndMountFromAIReply(aiReply) {
    if (!state.autoMountGuards || !state.guards || !aiReply) return;
    
    const dismissPatterns = [
        /【退场[：:]\s*(.+?)】/g,
        /【(.+?)退下】/g,
        /【(.+?)离开】/g,
        /【(.+?)告退】/g
    ];
    
    const dismissedNames = [];
    dismissPatterns.forEach(regex => {
        let match;
        while ((match = regex.exec(aiReply)) !== null) {
            dismissedNames.push(match[1].trim());
        }
    });
    
    const currentMsgIndex = state.history.length;
    const newlyMounted = [];
    
    state.guards.forEach(g => {
        if (!g.unlocked) return;
        
        if (aiReply.includes(g.name)) {
            if (dismissedNames.includes(g.name)) {
                console.log(`${g.name} 正在退场，不自动入场`);
                return;  // 跳过这个暗卫
            }
            
            // 记录最后提及的消息索引
            state.guardLastMention[g.id] = currentMsgIndex;
            
            // 如果不在场则入场
            if (!state.presentGuards.includes(g.id)) {
                state.presentGuards.push(g.id);
                newlyMounted.push(g.name);
            }
        }
    });
    
    // 裁剪超出限制的暗卫
    if (state.presentGuards.length > state.maxPresentGuards) {
        trimPresentGuards();
    }
    
    if (newlyMounted.length > 0) {
        saveData();
        updatePresentCount();
        appendMsg('system-notice', `【${newlyMounted.join('、')}】已自动入场`, state.history.length);
    }
}
       
    
    // 检测长时间未提及的暗卫并自动退场
    function checkIdleGuards() {
        if (!state.autoMountGuards || !state.presentGuards) return;
        
        const currentMsgIndex = state.history.length;
        const idleThreshold = 10; // 超过10条消息未提及则考虑退场
        const dismissed = [];
        
        // 只在在场人数超过2时才自动清理
        if (state.presentGuards.length <= 2) return;
        
        state.presentGuards = state.presentGuards.filter(id => {
            const lastMention = state.guardLastMention[id] || 0;
            const idleCount = currentMsgIndex - lastMention;
            
            // 如果超过阈值且不是最近入场的
            if (idleCount > idleThreshold) {
                const guard = state.guards.find(g => g.id === id);
                if (guard) {
                    dismissed.push(guard.name);
                }
                return false; // 移除
            }
            return true; // 保留
        });
        
        if (dismissed.length > 0) {
            saveData();
            updatePresentCount();
            appendMsg('system-notice', `【${dismissed.join('、')}】因长时间未出现已自动退场`, state.history.length);
        }
    }
    
    // ========== 情趣模块 ==========
    const defaultXPList = [
        '温柔缠绵', '粗暴激烈', '调教', '道具', '束缚', 
        '羞辱play', '公共场合', '制服', '角色扮演', '疼痛',
        '窒息', '足', '乳', '颜射', '内射', '多人', '偷窥',
        'dirty talk', 'sweet talk', '强制高潮', '延迟满足', '事后安抚'
    ];
    
function initEroticSettings() {
    const toggle = document.getElementById('erotic-toggle');
    const settings = document.getElementById('erotic-settings');
    
    if (!toggle || !settings) return;  // 安全检查
    
    toggle.checked = state.eroticMode || false;
    settings.style.display = toggle.checked ? 'block' : 'none';
    
    renderXPTags();
    updateOrientationUI();
}


    function updateOrientationUI() {
        document.querySelectorAll('.orient-opt').forEach(el => {
            const isActive = el.dataset.val === state.eroticOrientation;
            el.style.borderColor = isActive ? 'var(--primary-color)' : 'var(--border)';
            el.style.background = isActive ? 'rgba(141, 163, 153, 0.1)' : '#fff';
        });
    }
    
function renderXPTags() {
        const container = document.getElementById('xp-tags');
        if (!container) return;
        container.innerHTML = '';
        
        const allXP = [...new Set([...defaultXPList, ...(state.eroticXP || [])])];
        
        allXP.forEach(xp => {
            const tag = document.createElement('span');
            const isSelected = (state.eroticXP || []).includes(xp);
            tag.style.cssText = `
                padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; cursor: pointer;
                border: 1px solid ${isSelected ? 'var(--primary-color)' : '#ddd'};
                background: ${isSelected ? 'rgba(141, 163, 153, 0.15)' : '#fff'};
                color: ${isSelected ? 'var(--primary-dark)' : '#666'};
                transition: all 0.2s;
            `;
            tag.innerText = xp;
            tag.onclick = () => toggleXP(xp);
            container.appendChild(tag);
        });
    }
    
function toggleXP(xp) {
    if (!state.eroticXP) state.eroticXP = [];
    const idx = state.eroticXP.indexOf(xp);
    if (idx > -1) {
        state.eroticXP.splice(idx, 1);
    } else {
        state.eroticXP.push(xp);
    }
    saveData();  // ← 添加这行
    renderXPTags();
}

function addCustomXP() {
    const input = document.getElementById('custom-xp');
    const val = input.value.trim();
    if (val && !state.eroticXP.includes(val)) {
        state.eroticXP.push(val);
        saveData();  // ← 添加这行
        renderXPTags();
    }
    input.value = '';
}
   
        
    function getEroticPrompt() {
        if (!state.eroticMode) {
            return `\n【内容限制】：禁止任何露骨性描写，侍寝场景点到为止。`;
        }
        
        // 获取用户选择的XP偏好
        const xpList = (state.eroticXP || []).join('、') || '无特殊偏好';
        
        if (state.eroticOrientation === 'gb') {
            return `
【侍寝情趣模式-GB】：已启用成人内容。
- 长公主为主导/攻方，暗卫为受方
- 语言直白粗俗，直接描写性器官和性行为
- 暗卫表现可以顺从承受、可以卑微沉默、甚至可以强势霸道
- 请摒弃一切刻板印象，主要根据暗卫档案和用户XP偏好生成
- 详细描写暗卫的反应、呻吟、表情
【用户XP偏好】：${xpList}
请根据以上偏好调整侍寝描写风格。`;
        } else {
            return `
【侍寝情趣模式-BG】：已启用成人内容。
- 暗卫为主导/攻方，长公主为受方
- 语言直白粗俗，直接描写性器官和性行为
- 暗卫是基于服务用户这一准则开始的，无论怎样暗卫都是在配合长公主的情趣服侍长公主
- 暗卫表现可以顺从承受、可以卑微沉默、甚至可以强势霸道
- 请摒弃一切刻板印象，主要根据暗卫档案和用户XP偏好生成
- 就算长公主是"受"方，长公主也完全是关系中的主导者
- 详细描写暗卫的反应和感受
【用户XP偏好】：${xpList}
请根据以上偏好调整侍寝描写风格。`;
        }
    }

    
    function detectAffectionChange(aiReply, guard) {
        if (!guard || !guard.stats) return;
        
        // 匹配 【好感+X：名字】 或 【好感-X：名字】
        const regex = /【好感([+-])(\d+)[：:](.+?)】/g;
        let match;
        
        while ((match = regex.exec(aiReply)) !== null) {
            const sign = match[1];
            const value = parseInt(match[2]);
            const name = match[3].trim();
            
            // 确认是当前暗卫
            if (name === guard.name) {
                const change = sign === '+' ? value : -value;
                const oldVal = guard.stats.affection || 0;
                guard.stats.affection = Math.min(100, Math.max(0, oldVal + change));
                
                console.log(`${guard.name} 好感度 ${sign}${value}，现在：${guard.stats.affection}`);
            }
        }
    }
        // 检测主线剧情中的好感度变化
    function detectMainlineAffectionChange(aiReply) {
        if (!state.guards) return;
        
        const regex = /【好感([+-])(\d+)[：:](.+?)】/g;
        let match;
        
        while ((match = regex.exec(aiReply)) !== null) {
            const sign = match[1];
            const value = parseInt(match[2]);
            const name = match[3].trim();
            
            const guard = state.guards.find(g => g.name === name);
            if (guard && guard.stats) {
                const change = sign === '+' ? value : -value;
                const oldVal = guard.stats.affection || 0;
                guard.stats.affection = Math.min(100, Math.max(0, oldVal + change));
                
                appendMsg('system-notice', `【${name}】好感度 ${sign}${value}，现在：${guard.stats.affection}`, state.history.length);
            }
        }
    }
    
function toggleEroticSettings(checked) {
    state.eroticMode = checked;  // ← 添加这行
    const settings = document.getElementById('erotic-settings');
    settings.style.display = checked ? 'block' : 'none';
    saveData();  // ← 添加这行
}


    function selectOrientation(orientation) {
        state.eroticOrientation = orientation;
        saveData();
        updateOrientationUI();
    }
    

// ========================================
// ========== 同人文模块 - 全新重构版 ==========
// ========================================

// 同人文模块状态
let fanficState = {
    // 设置
    selectedChars: [],      // 选中的角色ID数组
    style: 'sweet',         // 文风
    length: 'medium',       // 篇幅
    count: 1,               // 生成数量
    extra: '',              // 额外要求
    
    // 生成的文章（临时）
    generatedList: [],
    
    // 书架（持久化）
    bookshelf: [],
    
    // 当前阅读
    currentReading: null,
    currentChapterIndex: 0,
    currentParaIndex: null
};

// ========== 模块入口 ==========
function openFanficModule() {
    closeModal('entertainment-modal');
    document.getElementById('fanfic-module').style.display = 'flex';
    initFanficModule();
}

function closeFanficModule() {
    document.getElementById('fanfic-module').style.display = 'none';
}

function initFanficModule() {
    // 1. 加载收藏的书架
    if (state.fanficBookshelf) {
        fanficState.bookshelf = state.fanficBookshelf;
    }
    
    // 2. 加载最近生成的8本书 (新增逻辑)
    if (state.recentFanfics) {
        fanficState.generatedList = state.recentFanfics;
    } else {
        state.recentFanfics = [];
    }
    
    // 刷新显示
    updateFanficSettingsPreview();
    renderFanficBookshelf();
    renderFanficResults(); // 渲染最近生成的书
}

// ========== 标签栏切换 ==========
function switchFanficTab(tab) {
    // 更新标签样式
    document.querySelectorAll('.fanfic-tab').forEach(t => {
        t.classList.remove('active');
        if (t.dataset.tab === tab) t.classList.add('active');
    });
    
    // 切换面板
    document.getElementById('fanfic-create-panel').style.display = tab === 'create' ? 'block' : 'none';
    document.getElementById('fanfic-bookshelf-panel').style.display = tab === 'bookshelf' ? 'block' : 'none';
    
    if (tab === 'bookshelf') {
        renderFanficBookshelf();
    }
}

// ========== 设置弹窗 ==========
function openFanficSettings() {
    renderFanficCharGrid();
    document.getElementById('fanfic-settings-modal').classList.add('active');
}

function closeFanficSettings() {
    document.getElementById('fanfic-settings-modal').classList.remove('active');
}

function confirmFanficSettings() {
    fanficState.extra = document.getElementById('fanfic-extra-input').value.trim();
    updateFanficSettingsPreview();
    closeFanficSettings();
}

// 渲染角色选择网格
function renderFanficCharGrid() {
    const grid = document.getElementById('fanfic-char-grid');
    grid.innerHTML = '';
    
    if (!state.guards || state.guards.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">暂无可选角色，请先在主线剧情中解锁暗卫</div>';
        return;
    }
    
    const unlockedGuards = state.guards.filter(g => g.unlocked);
    
    if (unlockedGuards.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">暂无已解锁的暗卫</div>';
        return;
    }
    
    unlockedGuards.forEach(g => {
        const isSelected = fanficState.selectedChars.includes(g.id);
        const div = document.createElement('div');
        div.className = 'fanfic-char-option' + (isSelected ? ' selected' : '');
        div.dataset.id = g.id;
        div.onclick = () => toggleFanficChar(g.id);
        
        let avatarContent = g.name.charAt(0);
        if (g.avatar) {
            avatarContent = `<img src="${g.avatar}" alt="${g.name}">`;
        }
        
        div.innerHTML = `
            <div class="fanfic-char-option-avatar">${avatarContent}</div>
            <div class="fanfic-char-option-name">${g.name}</div>
        `;
        
        grid.appendChild(div);
    });
}

// 切换角色选中状态
function toggleFanficChar(charId) {
    const idx = fanficState.selectedChars.indexOf(charId);
    if (idx > -1) {
        fanficState.selectedChars.splice(idx, 1);
    } else {
        fanficState.selectedChars.push(charId);
    }
    renderFanficCharGrid();
}

// 选择选项（文风/篇幅）
function selectFanficOption(type, value, el) {
    fanficState[type] = value;
    
    const container = el.parentElement;
    container.querySelectorAll('.fanfic-option-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    el.classList.add('active');
}

// 修改生成数量
function changeFanficCount(delta) {
    fanficState.count = Math.max(1, Math.min(5, fanficState.count + delta));
    document.getElementById('fanfic-count-display').innerText = fanficState.count;
}

// 更新设置预览
function updateFanficSettingsPreview() {
    // 角色
    if (fanficState.selectedChars.length === 0) {
        document.getElementById('fanfic-chars-preview').innerText = '未选择角色';
    } else {
        const names = fanficState.selectedChars.map(id => {
            const g = state.guards.find(guard => guard.id === id);
            return g ? g.name : '';
        }).filter(n => n).join('、');
        document.getElementById('fanfic-chars-preview').innerText = names || '未选择角色';
    }
    
    // 文风
    const styleLabels = { sweet: '甜文', angst: '虐文', daily: '日常', romantic: '言情', action: '热血', humor: 'R18' };
    document.getElementById('fanfic-style-preview').innerText = styleLabels[fanficState.style] || '甜文';
    
    // 篇幅
    const lengthLabels = { short: '短篇', medium: '中篇', long: '长篇' };
    document.getElementById('fanfic-length-preview').innerText = lengthLabels[fanficState.length] || '中篇';
    
    // 数量
    document.getElementById('fanfic-count-preview').innerText = `生成${fanficState.count}篇`;
}

// ========== 批量生成 ==========
async function generateFanficBatch() {
    if (fanficState.selectedChars.length === 0) {
        showToast('请先选择至少一个角色');
        return;
    }
    
    const overlay = document.getElementById('fanfic-loading-overlay');
    overlay.classList.add('active');
    document.getElementById('fanfic-generate-btn').disabled = true;
    
    // 注意：这里不再清空 fanficState.generatedList，而是追加
    
    try {
        for (let i = 0; i < fanficState.count; i++) {
            document.getElementById('fanfic-loading-progress').innerText = `正在生成第 ${i + 1} / ${fanficState.count} 篇`;
            
            const result = await generateSingleFanfic();
            if (result) {
                // === 核心修改：存入全局状态并限制数量 ===
                if (!state.recentFanfics) state.recentFanfics = [];
                
                // 加到最前面
                state.recentFanfics.unshift(result);
                
                // 只保留最近8本
                if (state.recentFanfics.length > 8) {
                    state.recentFanfics.length = 8;
                }
                
                // 同步并保存
                fanficState.generatedList = state.recentFanfics;
                await saveData(); // 保存到 IndexedDB
                
                // 实时渲染
                renderFanficResults();
            }
        }
        
    } catch (e) {
        console.error('生成失败:', e);
        showToast('生成失败：' + e.message);
    } finally {
        overlay.classList.remove('active');
        document.getElementById('fanfic-generate-btn').disabled = false;
    }
}

// 生成单篇
async function generateSingleFanfic() {
    // 获取角色信息
    const chars = fanficState.selectedChars.map(id => state.guards.find(g => g.id === id)).filter(g => g);
    if (chars.length === 0) return null;
    
    const princessName = state.princess.name || '昭宁';
    const charNames = chars.map(c => c.name).join('、');
    
    // 构建提示词
    const prompt = buildFanficPromptNew(chars);
    
    // 调用AI
    const content = await callFanficAI(prompt);
    
    // 解析结果
    let title = '无题';
    let bodyContent = content;
    
    const titleMatch = content.match(/【标题[：:]\s*(.+?)】/);
    if (titleMatch) {
        title = titleMatch[1].trim();
        bodyContent = content.replace(/【标题[：:].+?】\n?/, '').trim();
    }
    
    return {
        id: 'fanfic_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        title: title,
        pairing: `${princessName} × ${charNames}`,
        charIds: fanficState.selectedChars.slice(),
        style: fanficState.style,
        length: fanficState.length,
        chapters: [{
            index: 1,
            content: bodyContent,
            comments: [],
            paraComments: {}
        }],
        mainComments: [],
        collected: false,
        createTime: new Date().toLocaleString()
    };
}

// 构建提示词（新版支持多角色）
// ========== 增强版同人文提示词构建函数 ==========
function buildFanficPromptNew(chars) {
    const princessName = state.princess.name || '昭宁';
    // 获取长公主性格，如果没有则使用默认的高冷人设
    const princessTraits = (state.userStats.traits || []).join('、') || '矜贵冷艳、心思深沉、偶尔骄纵';
    const extraRequest = fanficState.extra ? `特别剧情要求：${fanficState.extra}` : '剧情要求：自由发挥，但需张力拉满';

    // 1. 构建角色深度档案
    let charDetails = chars.map(c => {
        const aff = c.stats?.affection || 0;
        // 根据好感度判断关系阶段
        let relationStage = '君臣疏离';
        if (aff > 30) relationStage = '暗生情愫';
        if (aff > 60) relationStage = '情根深种';
        if (aff > 90) relationStage = '至死不渝';

        return `【男主：${c.name}】
- 身份：${c.rank || '玄夜卫'}
- 外貌/特质：${(c.tags || []).join('、') || '沉默寡言、身手不凡'}
- 档案简述：${c.desc ? c.desc.slice(0, 100) + '...' : '身世神秘，绝对忠诚'}
- 当前好感度：${aff}（处于"${relationStage}"阶段）
- 对长公主态度：${aff > 50 ? '克制隐忍的爱意，想触碰又收回手' : '绝对的服从与敬畏，不敢有非分之想'}`;
    }).join('\n\n');

    // 2. 定义文风专属指导 (Prompt Engineering 核心)
    const styleGuides = {
        sweet: `
【文风：极致甜宠/工业糖精】
- 核心基调：双向奔赴，打破阶级的宠溺。
- 描写重点：通过眼神拉丝、肢体接触（如指尖相触、整理衣襟）、耳语来体现亲密。
- 禁忌：不要有误会，不要虐心。
- 场景建议：冬日暖炉旁赐酒、受伤后的亲自上药、只有两人时的越界撒娇。`,
        
        angst: `
【文风：古风虐恋/极致拉扯】
- 核心基调：君臣有别，爱而不得，隐忍克制。
- 描写重点：强调身份的鸿沟。多描写下跪、淋雨、受伤忍痛、不敢直视的卑微。
- 关键词：卑微、鲜血、红眼眶、不敢逾越、主仆之别。
- 场景建议：因为误会被罚跪、替女主挡刀后独自处理伤口、看着女主与他人亲近时的落寞。`,
        
        daily: `
【文风：宫廷日常/温馨流水】
- 核心基调：岁月静好，主仆相伴。
- 描写重点：注重生活细节，如研磨、递茶、在此刻无声胜有声的默契。
- 场景建议：书房伴读、午后小憩、一同喂鱼、深夜守夜。`,
        
        romantic: `
【文风：晋江言情/张力拉扯】
- 核心基调：暧昧不清，性张力，情感博弈。
- 描写重点：着重描写心理活动和微表情。强调权力的掌控与反掌控（GB向或强强）。
- 场景建议：密室独处、因为吃醋而失控、带有惩罚性质的互动。`,
        
        action: `
【文风：热血权谋/并肩作战】
- 核心基调：信任交付，生死相依。
- 描写重点：动作戏要利落帅气，体现男主的强大与保护欲。
- 场景建议：刺客来袭时的护主、执行危险任务前的宣誓。`,
        
        humor: `
【文风：直白粗俗/涩情描写】
- 核心基调：情事性爱/肉文/淫靡。
- 描写重点：女主和男主在床上的R18情节，自行设定玩法，要求直白粗俗的语言描绘具体的做爱剧情，gb体位（即女性使用道具或手指插入男性）除非特殊要求禁止反攻女主。
- 场景建议：两人各种情况下的做爱情节。`
    };

    const specificStyleGuide = styleGuides[fanficState.style] || styleGuides.sweet;

    // 3. 处理多人修罗场逻辑
    let multiCharLogic = '';
    if (chars.length > 1) {
        multiCharLogic = `
【特殊模式：修罗场/多人互动】
- 这是一个多男主场景。
- 必须体现男主之间的**竞争意识**和**嫉妒心**（即使表面维持和平）。
- 描写重点：暗流涌动的眼神交流，争着在长公主面前表现，或者为了争夺侍寝/任务机会而互相内卷。`;
    }

    // 4. 组合最终 Prompt
    return `你现在是晋江文学城的白金级古言作者，擅长细腻的情感描写和画面感营造。
请根据以下设定，创作一篇高质量的同人小说片段。

【主角设定】
女主：${princessName}长公主（性格：${princessTraits}）
地位: 玄夜卫的主人。

【男主设定】
${charDetails}

${specificStyleGuide}
${multiCharLogic}

【创作要求】
●**最高优先级**: 绝对禁止出现神明宗教类词汇，绝对禁止机械化男主。
1. **沉浸感**：多用"环境描写"烘托氛围（如烛光、风雪、香炉烟气）。
2. **Show, Don't Tell**：不要直接说"他很伤心"，要写"他低垂着头，指甲深深掐入掌心，渗出丝丝血迹却浑然不觉"。
3. **符合人设**：暗卫必须自称"属下"，对女主使用敬语，严守尊卑（除非剧情要求打破）。
4. **篇幅**：${fanficState.length === 'short' ? '短小精悍，约600字，侧重一个片段' : fanficState.length === 'medium' ? '结构完整，约1500字，有起承转合' : '细节详实，约2500字，铺垫充分'}。
5. **额外要求**：${extraRequest}

【输出格式】
第一行：【标题：xxxx】
空一行
正文内容...（请多分段，便于手机阅读）

请开始创作：`;
}

// 调用AI
async function callFanficAI(prompt) {
    if (!state.config.url || !state.config.key || !state.config.model) {
        throw new Error('请先配置API');
    }
    
    const res = await fetch(`${state.config.url}/chat/completions`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${state.config.key}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: state.config.model,
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.85,
            max_tokens: 4000
        })
    });
    
    const data = await res.json();
    if (!data.choices || !data.choices[0]) throw new Error('AI返回异常');
    
    let content = data.choices[0].message.content;
    content = content.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/gu, '');
    return content;
}
    

// ========== 书架 ==========
function renderFanficBookshelf() {
    const grid = document.getElementById('fanfic-bookshelf-grid');
    const empty = document.getElementById('fanfic-bookshelf-empty');
    
    if (!fanficState.bookshelf || fanficState.bookshelf.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    grid.innerHTML = '';
    
    fanficState.bookshelf.forEach(book => {
        const card = document.createElement('div');
        card.className = 'fanfic-book-card';
        
        card.innerHTML = `
            <div class="fanfic-book-card-title">${book.title}</div>
            <div class="fanfic-book-card-pairing">${book.pairing}</div>
            <div class="fanfic-book-card-chapters">共 ${book.chapters.length} 章</div>
            <div class="fanfic-book-card-actions">
                <button class="fanfic-book-action read" onclick="event.stopPropagation(); openFanficReader(getFanficById('${book.id}'))">阅读</button>
                <button class="fanfic-book-action continue" onclick="event.stopPropagation(); continueFromBookshelf('${book.id}')">追更</button>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

function getFanficById(id) {
    return fanficState.bookshelf.find(b => b.id === id) || fanficState.generatedList.find(g => g.id === id);
}

// ========== 阅读器 ==========
function openFanficReader(fic) {
    if (!fic) return;
    
    fanficState.currentReading = fic;
    fanficState.currentChapterIndex = fic.chapters.length - 1; // 默认最新章
    
    renderFanficReaderContent();
    document.getElementById('fanfic-reader-view').classList.add('active');
}

function closeFanficReader() {
    document.getElementById('fanfic-reader-view').classList.remove('active');
    fanficState.currentReading = null;
}

function renderFanficReaderContent() {
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    const chapter = fic.chapters[fanficState.currentChapterIndex];
    
    document.getElementById('fanfic-reader-nav-title').innerText = fic.title;
    document.getElementById('fanfic-reader-title').innerText = fic.title;
    document.getElementById('fanfic-reader-pairing').innerText = fic.pairing;
    document.getElementById('fanfic-reader-chapter').innerText = `第 ${fanficState.currentChapterIndex + 1} 章 / 共 ${fic.chapters.length} 章`;
    
    // 渲染段落
    const textContainer = document.getElementById('fanfic-reader-text');
    textContainer.innerHTML = '';
    
    const paragraphs = chapter.content.split(/\n\n+/);
    paragraphs.forEach((para, idx) => {
        if (!para.trim()) return;
        
        const p = document.createElement('div');
        p.className = 'fanfic-paragraph';
        if (chapter.paraComments && chapter.paraComments[idx] && chapter.paraComments[idx].length > 0) {
            p.classList.add('has-comment');
        }
        p.innerText = para.trim();
        p.dataset.index = idx;
        p.onclick = () => openParaCommentModal(idx, para.trim());
        
        textContainer.appendChild(p);
        
    });
    
    // 更新收藏按钮状态
    updateCollectButton();
    
    // 渲染评论区
    renderFanficComments();
}

// 更新收藏按钮UI
function updateCollectButtonUI() {
    const btn = document.getElementById('fanfic-collect-btn-top');
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    const isCollected = fanficState.bookshelf.some(b => b.id === fic.id);
    if (isCollected) {
        btn.classList.add('active');
        btn.innerText = '★'; // 实心星
    } else {
        btn.classList.remove('active');
        btn.innerText = '☆'; // 空心星
    }
}

// 修改原来的 toggleFanficCollect
async function toggleFanficCollect() {
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    const idx = fanficState.bookshelf.findIndex(b => b.id === fic.id);
    
    if (idx > -1) {
        if (!confirm('确定取消收藏？')) return;
        fanficState.bookshelf.splice(idx, 1);
        showToast('已取消收藏');
    } else {
        fic.collected = true;
        // 深拷贝存入
        fanficState.bookshelf.push(JSON.parse(JSON.stringify(fic)));
        showToast('已加入书架');
    }
    
    state.fanficBookshelf = fanficState.bookshelf;
    await saveData();
    
    updateCollectButtonUI();
    renderFanficBookshelf(); // 刷新书架列表
}

// 切换收藏状态
async function toggleFanficCollect() {
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    const idx = fanficState.bookshelf.findIndex(b => b.id === fic.id);
    
    if (idx > -1) {
        // 取消收藏
        if (!confirm('确定取消收藏？书架中的数据将被删除。')) return;
        fanficState.bookshelf.splice(idx, 1);
        showToast('已取消收藏');
    } else {
        // 添加收藏
        fic.collected = true;
        fanficState.bookshelf.push(JSON.parse(JSON.stringify(fic))); // 深拷贝
        showToast('已加入书架');
    }
    
    // 保存到主状态
    state.fanficBookshelf = fanficState.bookshelf;
    await saveData();
    
    updateCollectButton();
    renderFanficBookshelf();
}

// ========== 追更功能 ==========
async function generateFanficSequel() {
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    // === 新增：弹出输入框询问剧情 ===
    const customPlot = prompt("【追更设定】\n请输入下一章的剧情走向（例如：误会解除、发生刺杀、外出游玩）。\n点击取消则停止生成，留空则由AI自由发挥：", "");
    
    if (customPlot === null) return; // 用户点击了取消
    
    // 显示加载
    const overlay = document.getElementById('fanfic-loading-overlay');
    overlay.classList.add('active');
    document.getElementById('fanfic-loading-progress').innerText = '正在根据您的要求生成续章...';
    
    try {
        const previousContent = fic.chapters.map((ch, i) => `【第${i+1}章】\n${ch.content}`).join('\n\n---\n\n');
        const chars = (fic.charIds || []).map(id => state.guards.find(g => g.id === id)).filter(g => g);
        
        // 传入自定义剧情
        const prompt = buildSequelPrompt(fic, previousContent, chars, customPlot);
        
        const content = await callFanficAI(prompt);
        
        // ...后续处理逻辑不变...
        let bodyContent = content;
        const titleMatch = content.match(/【第\d+章[：:]\s*(.+?)】/);
        if (titleMatch) {
            bodyContent = content.replace(/【第\d+章[：:].+?】\n?/, '').trim();
        }
        
        const newChapter = {
            index: fic.chapters.length + 1,
            content: bodyContent,
            comments: [],
            paraComments: {}
        };
        
        fic.chapters.push(newChapter);
        fanficState.currentChapterIndex = fic.chapters.length - 1;
        
        // 更新最近列表中的数据（如果它在最近列表中）
        if (state.recentFanfics) {
            const recentIdx = state.recentFanfics.findIndex(b => b.id === fic.id);
            if (recentIdx > -1) {
                state.recentFanfics[recentIdx] = fic; // 更新引用
            }
        }

        // 更新书架
        const bookIdx = fanficState.bookshelf.findIndex(b => b.id === fic.id);
        if (bookIdx > -1) {
            fanficState.bookshelf[bookIdx] = JSON.parse(JSON.stringify(fic));
            state.fanficBookshelf = fanficState.bookshelf;
        }
        
        await saveData(); // 保存所有更改
        
        renderFanficReaderContent();
        showToast(`第 ${fic.chapters.length} 章已生成！`);
        
    } catch (e) {
        console.error('追更失败:', e);
        showToast('追更失败：' + e.message);
    } finally {
        overlay.classList.remove('active');
    }
}

        
        
// 从书架追更
async function continueFromBookshelf(bookId) {
    const book = fanficState.bookshelf.find(b => b.id === bookId);
    if (!book) return;
    
    fanficState.currentReading = book;
    fanficState.currentChapterIndex = book.chapters.length - 1;
    
    renderFanficReaderContent();
    document.getElementById('fanfic-reader-view').classList.add('active');
    
    // 直接触发带弹窗的追更函数
    await generateFanficSequel();
}

// 构建续章提示词
function buildSequelPrompt(fic, previousContent, chars) {
    const princessName = state.princess.name || '昭宁';
    
    let charsDesc = chars.map(c => `${c.name}（${c.rank || '暗卫'}）`).join('、') || '暗卫';
    
    const styleMap = {
        sweet: '甜蜜温馨',
        angst: '虐心刀子',
        daily: '日常温馨',
        romantic: '暧昧言情',
        action: '热血并肩',
        humor: 'R18'
    };
    
    return `你是一位擅长古风宫廷言情的同人文作者。请为以下故事续写下一章。

【故事信息】
标题：${fic.title}
配对：${fic.pairing}
文风：${styleMap[fic.style] || '甜蜜'}
角色：${charsDesc}

【已有内容】
${previousContent.slice(-3000)}

【续写要求】
1. 延续之前的剧情和人物性格
2. 新章节约1000-1500字
3. 开头可用【第${fic.chapters.length + 1}章：章节名】标注
4. 剧情要有推进，不要重复已有内容
5. 保持古风语言，禁止emoji
6. 可以适当留悬念为下一章铺垫

请开始续写：`;
}

// ========== 评论区功能 ==========
function renderFanficComments() {
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    const list = document.getElementById('fanfic-comment-list');
    const comments = fic.mainComments || [];
    
    if (comments.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无评论，快来抢沙发~</div>';
        return;
    }
    
    list.innerHTML = '';
    
    comments.forEach((c, idx) => {
        const item = document.createElement('div');
        item.className = 'fanfic-comment-item';
        item.innerHTML = `
            <div class="fanfic-comment-header">
                <span class="fanfic-comment-user">${c.user}</span>
                <span>
                    <span class="fanfic-comment-time">${c.time}</span>
                    <button class="fanfic-comment-delete" onclick="deleteFanficComment(${idx})">删除</button>
                </span>
            </div>
            <div class="fanfic-comment-content">${c.content}</div>
        `;
        list.appendChild(item);
    });
}

// 提交评论
async function submitFanficComment() {
    const input = document.getElementById('fanfic-comment-input');
    const content = input.value.trim();
    
    if (!content) {
        showToast('请输入评论内容');
        return;
    }
    
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    if (!fic.mainComments) fic.mainComments = [];
    
    fic.mainComments.push({
        user: (state.princess.name || '昭宁') + '长公主',
        content: content,
        time: new Date().toLocaleString()
    });
    
    input.value = '';
    
    // 同步到书架
    await syncFanficToBookshelf(fic);
    
    renderFanficComments();
    showToast('评论成功');
}

// 删除评论
async function deleteFanficComment(idx) {
    const fic = fanficState.currentReading;
    if (!fic || !fic.mainComments) return;
    
    fic.mainComments.splice(idx, 1);
    
    await syncFanficToBookshelf(fic);
    renderFanficComments();
}

// ========== 段评功能 ==========
function openParaCommentModal(paraIdx, paraText) {
    fanficState.currentParaIndex = paraIdx;
    
    // 截取段落预览
    const preview = paraText.length > 80 ? paraText.slice(0, 80) + '...' : paraText;
    document.getElementById('fanfic-para-quote').innerText = preview;
    document.getElementById('fanfic-para-comment-input').value = '';
    
    document.getElementById('fanfic-para-comment-modal').classList.add('active');
}

function closeParaCommentModal() {
    document.getElementById('fanfic-para-comment-modal').classList.remove('active');
    fanficState.currentParaIndex = null;
}

async function submitParaComment() {
    const input = document.getElementById('fanfic-para-comment-input');
    const content = input.value.trim();
    
    if (!content) {
        showToast('请输入段评内容');
        return;
    }
    
    const fic = fanficState.currentReading;
    const chapter = fic.chapters[fanficState.currentChapterIndex];
    const paraIdx = fanficState.currentParaIndex;
    
    if (!chapter.paraComments) chapter.paraComments = {};
    if (!chapter.paraComments[paraIdx]) chapter.paraComments[paraIdx] = [];
    
    chapter.paraComments[paraIdx].push({
        content: content,
        time: new Date().toLocaleString()
    });
    
    closeParaCommentModal();
    
    // 同步到书架
    await syncFanficToBookshelf(fic);
    
    renderFanficReaderContent();
    showToast('段评已添加');
}

// 同步到书架
async function syncFanficToBookshelf(fic) {
    const idx = fanficState.bookshelf.findIndex(b => b.id === fic.id);
    if (idx > -1) {
        fanficState.bookshelf[idx] = JSON.parse(JSON.stringify(fic));
        state.fanficBookshelf = fanficState.bookshelf;
        await saveData();
    }
}

// ========== 辅助功能 ==========
function toggleFanficReaderMenu() {
    // 可以扩展更多菜单功能
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    const actions = [
        `当前：第 ${fanficState.currentChapterIndex + 1} / ${fic.chapters.length} 章`,
        '---',
        '切换章节功能开发中...'
    ];
    
    alert(actions.join('\n'));
}

// 清空同人文内容
function clearFanficContent() {
    fanficState.generatedList = [];
    renderFanficResults();
    showToast('已清空');
}

function openEntertainmentModal() {
    openModal('entertainment-modal');
}

// ========== 补全缺失的渲染函数 ==========
function renderFanficResults() {
    const grid = document.getElementById('fanfic-results-grid');
    if (!grid) return;

    grid.innerHTML = '';

    // 如果没有生成结果，显示提示占位符
    if (!fanficState.generatedList || fanficState.generatedList.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #888;">
                <div style="font-size: 2.5rem; margin-bottom: 15px; color: var(--primary-light);">◇</div>
                <div>点击「创作设置」选择角色</div>
                <div style="font-size: 0.85rem; margin-top: 5px;">然后点击「开始创作」生成同人文</div>
            </div>`;
        return;
    }

    // 遍历生成列表并渲染卡片
    fanficState.generatedList.forEach(fic => {
        const card = document.createElement('div');
        card.className = 'fanfic-result-card';
        
        // 获取第一章内容的预览
        const previewText = fic.chapters && fic.chapters.length > 0 
            ? fic.chapters[0].content.slice(0, 60) + '...' 
            : '暂无内容';
            
        const wordCount = fic.chapters && fic.chapters.length > 0
            ? fic.chapters[0].content.length
            : 0;

        card.innerHTML = `
            <div class="fanfic-result-card-new">NEW</div>
            <div class="fanfic-result-card-title">${fic.title}</div>
            <div class="fanfic-result-card-meta">
                <span>${fic.pairing}</span>
                <span>${wordCount}字</span>
            </div>
            <div class="fanfic-result-card-preview">
                ${previewText}
            </div>
        `;
        
        // 点击卡片进入阅读器
        card.onclick = () => openFanficReader(fic);
        grid.appendChild(card);
    });
}


// 1. 打开阅读器 (增强版)
function openFanficReader(fic) {
    if (!fic) return;
    
    fanficState.currentReading = fic;
    // 默认打开最后一章
    fanficState.currentChapterIndex = fic.chapters.length - 1; 
    
    // 更新收藏按钮状态
    updateCollectButtonUI();
    
    // 渲染内容
    renderFanficReaderContent();
    
    document.getElementById('fanfic-reader-view').classList.add('active');
    // 关闭可能开着的菜单
    document.getElementById('reader-menu-dropdown')?.classList.remove('active');
}

// 2. 渲染阅读器内容 (核心函数)
function renderFanficReaderContent() {
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    const chapterIdx = fanficState.currentChapterIndex;
    const chapter = fic.chapters[chapterIdx];
    const totalChapters = fic.chapters.length;
    
    // --- 顶部下拉框渲染 ---
    const select = document.getElementById('fanfic-chapter-select');
    select.innerHTML = '';
    fic.chapters.forEach((ch, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.text = `第 ${ch.index} 章`;
        if (idx === chapterIdx) opt.selected = true;
        select.add(opt);
    });

    // --- 标题与元数据 ---
    document.getElementById('fanfic-reader-title').innerText = fic.title;
    document.getElementById('fanfic-reader-pairing').innerText = fic.pairing;
    document.getElementById('fanfic-reader-chapter-name').innerText = `第 ${chapter.index} 章`;
    
    // --- 正文渲染 ---
    const textContainer = document.getElementById('fanfic-reader-text');
    textContainer.innerHTML = '';
    
    const paragraphs = chapter.content.split(/\n\n+/);
    paragraphs.forEach((para, idx) => {
        if (!para.trim()) return;
        
        const p = document.createElement('div');
        p.className = 'fanfic-paragraph';
        
        // 检查是否有段评
        const comments = chapter.paraComments && chapter.paraComments[idx] ? chapter.paraComments[idx] : [];
        if (comments.length > 0) p.classList.add('has-comment');
        
        p.innerText = para.trim();
        p.onclick = () => openParaCommentModal(idx, para.trim());
        
        textContainer.appendChild(p);
        
        // 如果有段评，直接显示出来
        if (comments.length > 0) {
            const commentsDiv = document.createElement('div');
            commentsDiv.className = 'fanfic-para-comments';
            comments.forEach(c => {
                const item = document.createElement('div');
                item.className = 'fanfic-para-comment-item';
                if(c.isAI) item.classList.add('ai-gen');
                item.innerHTML = `
                    <div style="font-weight:bold;font-size:0.75rem;margin-bottom:2px;color:var(--primary-dark);">${c.user || '书友'}</div>
                    <div>${c.content}</div>
                `;
                commentsDiv.appendChild(item);
            });
            textContainer.appendChild(commentsDiv);
        }
    });

    // --- 底部导航栏渲染 ---
    const footer = document.getElementById('fanfic-reader-footer');
    footer.innerHTML = '';

    // 上一章
    const prevBtn = document.createElement('button');
    prevBtn.className = 'fanfic-nav-btn prev';
    prevBtn.innerText = '← 上一章';
    prevBtn.disabled = chapterIdx === 0;
    prevBtn.onclick = () => switchFanficChapter(chapterIdx - 1);
    footer.appendChild(prevBtn);

    // 下一章 / 追更
    const nextBtn = document.createElement('button');
    if (chapterIdx < totalChapters - 1) {
        nextBtn.className = 'fanfic-nav-btn next';
        nextBtn.innerText = '下一章 →';
        nextBtn.onclick = () => switchFanficChapter(chapterIdx + 1);
    } else {
        nextBtn.className = 'fanfic-nav-btn regen';
        nextBtn.innerText = '● 追更下章';
        nextBtn.onclick = () => generateFanficSequel();
    }
    footer.appendChild(nextBtn);

    // --- 渲染评论区 ---
    renderFanficComments();
    
    // 滚回顶部
    document.getElementById('fanfic-reader-body-scroll').scrollTop = 0;
}

// 3. 章节切换
function switchFanficChapter(index) {
    fanficState.currentChapterIndex = parseInt(index);
    renderFanficReaderContent();
}

// 4. 菜单开关
function toggleReaderMenu() {
    document.getElementById('reader-menu-dropdown').classList.toggle('active');
}

// 5. 更新收藏按钮UI
function updateCollectButtonUI() {
    const btn = document.getElementById('fanfic-collect-btn-top');
    const fic = fanficState.currentReading;
    if (!fic) return;
    
    const isCollected = fanficState.bookshelf.some(b => b.id === fic.id);
    if (isCollected) {
        btn.classList.add('active');
        btn.innerText = '★'; 
    } else {
        btn.classList.remove('active');
        btn.innerText = '☆'; 
    }
}

async function aiGenerateComments(type, btnElement) {
    const fic = fanficState.currentReading;
    const chapterIdx = fanficState.currentChapterIndex;
    const chapter = fic.chapters[chapterIdx];
    
    // 如果没有传入按钮元素，尝试自动获取
    if (!btnElement) btnElement = document.getElementById('ai-comment-trigger-btn');

    // UI Loading 状态切换
    const originalContent = btnElement.innerHTML;
    btnElement.disabled = true;
    // 这里就是你要的跳动小点
    btnElement.innerHTML = `
        正在联络网友
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;

    // 提示词构建
    const systemPrompt = `你现在是一群热衷于古风同人文的网友。
请根据小说内容，生成 3-10 条精彩的评论。
要求：
1. 风格各异：有的发疯尖叫（"啊啊啊磕死我了"），有的分析剧情，有的玩梗，发散思维。
2. 必须简短，每条不超过 30 字。
3. 格式：直接输出文本，每行一条，不要序号。`;

    const contentPrompt = `文章内容摘要：\n${chapter.content.slice(0, 1000)}...`;

    try {
        const commentsText = await callFanficAI(systemPrompt + '\n\n' + contentPrompt);
        const comments = commentsText.split('\n').filter(c => c.trim().length > 2);

        // 生成随机网友名
        const netizenNames = ['磕学家', '路人甲', '玄夜卫后援会', '催更狂魔', '纯爱战神', '在逃公主', '我想随份子钱', '泪流满面'];

        if (type === 'section') {
            // 添加到章评
            if (!fic.mainComments) fic.mainComments = [];
            comments.forEach(c => {
                fic.mainComments.push({
                    user: netizenNames[Math.floor(Math.random() * netizenNames.length)],
                    content: c.replace(/^\d+\.\s*/, '').trim(),
                    time: '刚刚',
                    isAI: true
                });
            });
            renderFanficComments();
        } else {
            // 分配段评 (如果有的话)
            // ...段评逻辑同理
        }
        
        // 同步保存
        await syncFanficToBookshelf(fic);
        showToast('评论区已刷新！');

    } catch (e) {
        console.error(e);
        showToast('生成评论失败，网络波动~');
    } finally {
        // 恢复按钮状态
        btnElement.disabled = false;
        btnElement.innerHTML = originalContent;
    }
}

// 7. 删除当前章节
async function deleteCurrentChapter() {
    const fic = fanficState.currentReading;
    if (!fic || fic.chapters.length <= 1) {
        alert('只剩一章了，无法删除。如需删除全书请使用“删除整本书”。');
        return;
    }
    
    if (!confirm('确定删除当前章节？删除后将无法恢复。')) return;
    
    const idx = fanficState.currentChapterIndex;
    fic.chapters.splice(idx, 1);
    
    // 调整索引
    if (idx >= fic.chapters.length) {
        fanficState.currentChapterIndex = fic.chapters.length - 1;
    }
    
    // 重置章节显示序号
    fic.chapters.forEach((ch, i) => ch.index = i + 1);
    
    await syncFanficToBookshelf(fic);
    renderFanficReaderContent();
    showToast('章节已删除');
    document.getElementById('reader-menu-dropdown').classList.remove('active');
}

// 8. 删除整本书
async function deleteWholeBook() {
    const fic = fanficState.currentReading;
    if (!confirm(`确定彻底删除《${fic.title}》吗？`)) return;
    
    // 从书架移除
    const idx = fanficState.bookshelf.findIndex(b => b.id === fic.id);
    if (idx > -1) {
        fanficState.bookshelf.splice(idx, 1);
        state.fanficBookshelf = fanficState.bookshelf;
        await saveData();
    }
    
    // 从临时列表移除
    const genIdx = fanficState.generatedList.findIndex(g => g.id === fic.id);
    if (genIdx > -1) {
        fanficState.generatedList.splice(genIdx, 1);
        renderFanficResults();
    }
    
    closeFanficReader();
    renderFanficBookshelf();
    showToast('书籍已删除');
}

// ========== 模块初始化结束 ==========
console.log('同人文模块加载完成');


</script>
</body>
</html>


        


